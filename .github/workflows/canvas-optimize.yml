name: Canvas Self-Optimization Loop

# Runs daily at 3am UTC — analyzes quality, evolves params, tunes prompts
# GitHub Actions: 2,000 free minutes/month on free tier
# This workflow uses ~5 minutes per run = ~150 min/month = well within free tier

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3am UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write  # Required for committing results back to repo

jobs:
  optimize:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install numpy

      - name: Run optimization loop
        working-directory: canvas-engine
        run: |
          python -m agents.optimization_loop
        continue-on-error: true  # Don't block checklist if no optimization data yet

      - name: Commit evolved config
        run: |
          git config user.name "Canvas Optimization Bot"
          git config user.email "canvas-bot@loopcanvas.ai"
          git add -A canvas-engine/optimization_data/
          git diff --staged --quiet || git commit -m "chore: canvas optimization gen $(date +%Y%m%d)

          Auto-evolved parameters from quality feedback loop.

          Co-Authored-By: Canvas Optimization Bot <canvas-bot@loopcanvas.ai>"
          git push || echo "Nothing to push"

  retention:
    runs-on: ubuntu-latest
    needs: optimize
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install numpy

      - name: Run Retention Engineer
        working-directory: canvas-engine
        run: |
          python -m agents.retention_engineer
        continue-on-error: true

      - name: Commit retention config
        run: |
          git config user.name "Canvas Optimization Bot"
          git config user.email "canvas-bot@loopcanvas.ai"
          git add -A retention_config.json templates/ canvas-engine/checklist_data/retention_*.jsonl canvas-engine/checklist_data/retention_summary.json
          git diff --staged --quiet || git commit -m "chore: retention engineer cycle $(date +%Y%m%d)

          Autonomous retention optimization — config + template updates.

          Co-Authored-By: Canvas Optimization Bot <canvas-bot@loopcanvas.ai>"
          git push || echo "Nothing to push"

  onboarding:
    runs-on: ubuntu-latest
    needs: optimize
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install numpy

      - name: Run Onboarding Optimizer
        working-directory: canvas-engine
        run: |
          python -m agents.onboarding_optimizer
        continue-on-error: true

      - name: Commit onboarding config
        run: |
          git config user.name "Canvas Optimization Bot"
          git config user.email "canvas-bot@loopcanvas.ai"
          git add -A onboarding_config.json landing_config.json templates/ canvas-engine/checklist_data/onboarding_*.jsonl canvas-engine/checklist_data/onboarding_summary.json
          git diff --staged --quiet || git commit -m "chore: onboarding optimizer cycle $(date +%Y%m%d)

          Autonomous onboarding/landing optimization — config + template updates.

          Co-Authored-By: Canvas Optimization Bot <canvas-bot@loopcanvas.ai>"
          git push || echo "Nothing to push"

  growth:
    runs-on: ubuntu-latest
    needs: optimize
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install numpy

      - name: Run Growth Engineer
        working-directory: canvas-engine
        run: |
          python -m agents.growth_engineer
        continue-on-error: true

      - name: Commit growth config
        run: |
          git config user.name "Canvas Optimization Bot"
          git config user.email "canvas-bot@loopcanvas.ai"
          git add -A growth_config.json templates/ canvas-engine/checklist_data/growth_*.jsonl canvas-engine/checklist_data/growth_summary.json
          git diff --staged --quiet || git commit -m "chore: growth engineer cycle $(date +%Y%m%d)

          Autonomous growth/viral optimization — config + template updates.

          Co-Authored-By: Canvas Optimization Bot <canvas-bot@loopcanvas.ai>"
          git push || echo "Nothing to push"

  master-checklist:
    runs-on: ubuntu-latest
    needs: [optimize, retention, onboarding, growth]
    if: always()  # Run even if agents fail (checklist is independent)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # Pull latest (optimize may have pushed)

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install numpy

      - name: Run Part VII Master Checklist
        working-directory: canvas-engine
        run: |
          python -m agents.weekly_checklist

      - name: Commit checklist data
        run: |
          git config user.name "Canvas Optimization Bot"
          git config user.email "canvas-bot@loopcanvas.ai"
          git add -A canvas-engine/checklist_data/
          git diff --staged --quiet || git commit -m "chore: weekly checklist eval $(date +%Y%m%d)

          Automated Part VII Master Checklist evaluation.

          Co-Authored-By: Canvas Optimization Bot <canvas-bot@loopcanvas.ai>"
          git push || echo "Nothing to push"

      - name: Upload checklist report
        uses: actions/upload-artifact@v4
        with:
          name: checklist-report-${{ github.run_number }}
          path: canvas-engine/checklist_data/
          retention-days: 90

  quality-report:
    runs-on: ubuntu-latest
    needs: master-checklist
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate quality report
        working-directory: canvas-engine
        run: |
          python -m agents.optimization_loop report
        continue-on-error: true

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ github.run_number }}
          path: canvas-engine/optimization_data/
          retention-days: 90
