<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LoopCanvas â€” Turn a 7-second canvas into a full-length music video</title>
<meta name="description" content="Upload your track, get an AI-built Spotify-style canvas in seconds â€” then expand it into a full music video that matches your mood, your sound, and your world.">
<meta property="og:title" content="LoopCanvas â€” AI Music Video Generator">
<meta property="og:description" content="Turn a 7-second canvas into a full-length custom music video. Built for artists & producers.">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¬</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Apple Core Foundation Design System â€” Liquid Glass & Spatial UI
   Based on: https://developer.apple.com/design/new-design-gallery/

   Key Principles:
   1. Content over chrome - UI serves the content
   2. Bottom tab bar for primary navigation (new iOS pattern)
   3. Liquid Glass materials with responsive interactivity
   4. Scroll-edge effects for header dismissal
   5. Fluid interactions with responsive feedback
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
  /* === SPATIAL DEPTH LAYERS === */
  --z-background: -100px;
  --z-surface: 0px;
  --z-raised: 20px;
  --z-floating: 40px;
  --z-overlay: 80px;

  /* === GLASS MATERIALS (Liquid Glass) === */
  --glass-bg: rgba(255, 255, 255, 0.03);
  --glass-bg-hover: rgba(255, 255, 255, 0.06);
  --glass-bg-active: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-border-hover: rgba(255, 255, 255, 0.15);
  --glass-highlight: rgba(255, 255, 255, 0.1);
  --glass-blur: 40px;
  --glass-saturation: 180%;

  /* === COLORS â€” Apple TV Pure Black === */
  --bg-void: #000000;
  --bg-primary: #0a0a0a;
  --bg-secondary: #111111;
  --bg-tertiary: #1a1a1a;
  --border: rgba(255, 255, 255, 0.06);
  --border-subtle: rgba(255, 255, 255, 0.03);

  --text-primary: rgba(255, 255, 255, 0.92);
  --text-secondary: rgba(255, 255, 255, 0.6);
  --text-muted: rgba(255, 255, 255, 0.35);
  --text-dim: rgba(255, 255, 255, 0.2);

  --accent: #1db954;
  --accent-hover: #1ed760;
  --accent-glow: rgba(29, 185, 84, 0.3);

  /* === TYPOGRAPHY â€” Clean Sans-Serif === */
  --font-display: 'Inter', -apple-system, sans-serif;
  --font-body: 'Inter', -apple-system, sans-serif;

  /* === SHADOWS (SPATIAL DEPTH) === */
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 24px 64px rgba(0, 0, 0, 0.5);
  --shadow-glow: 0 0 40px var(--accent-glow);

  /* === MOTION (Fluid Interactions) === */
  --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);
  --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
  --duration-fast: 0.15s;
  --duration-normal: 0.3s;
  --duration-slow: 0.5s;

  /* === RADII === */
  --radius-sm: 8px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --radius-xl: 32px;

  /* === SCROLL-EDGE STATE (set by JS) === */
  --header-opacity: 1;
  --header-blur: 40px;
  --header-scale: 1;
}

body {
  font-family: var(--font-body);
  background: var(--bg-void);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* === GLASS MATERIAL MIXIN (applied via class) === */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
  border: 1px solid var(--glass-border);
  box-shadow:
    var(--shadow-md),
    inset 0 1px 0 var(--glass-highlight),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

.glass:hover {
  background: var(--glass-bg-hover);
  border-color: var(--glass-border-hover);
}

/* === AMBIENT GLOW EFFECT === */
.glow-accent {
  box-shadow: var(--shadow-md), var(--shadow-glow);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER â€” Floating Glass Navigation with Scroll-Edge Effect
   Apple Core Foundation: Headers respond to scroll with opacity/blur changes
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.header {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%) scale(var(--header-scale, 1));
  width: calc(100% - 48px);
  max-width: 1200px;
  height: 56px;
  z-index: 100;

  /* Liquid Glass Material */
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, calc(0.06 * var(--header-opacity, 1))) 0%,
    rgba(255, 255, 255, calc(0.02 * var(--header-opacity, 1))) 100%
  );
  backdrop-filter: blur(var(--header-blur, 40px)) saturate(var(--glass-saturation));
  -webkit-backdrop-filter: blur(var(--header-blur, 40px)) saturate(var(--glass-saturation));
  border: 1px solid rgba(255, 255, 255, calc(0.08 * var(--header-opacity, 1)));
  border-radius: var(--radius-xl);
  box-shadow:
    0 24px 64px rgba(0, 0, 0, calc(0.5 * var(--header-opacity, 1))),
    inset 0 1px 0 rgba(255, 255, 255, calc(0.1 * var(--header-opacity, 1)));

  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;

  transition: transform var(--duration-normal) var(--ease-out-expo),
              background var(--duration-fast) linear,
              border-color var(--duration-fast) linear;
}

/* Scroll-edge: header shrinks slightly when scrolled */
.header.scrolled {
  --header-scale: 0.98;
  --header-opacity: 0.85;
  --header-blur: 60px;
}

.header:hover {
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.03) 100%
  );
  border-color: var(--glass-border-hover);
  box-shadow:
    var(--shadow-lg),
    inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM TAB BAR â€” Apple Core Foundation Primary Navigation
   "Controls shift from top to bottom for better thumb accessibility"
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.bottom-tab-bar {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 100;

  /* Liquid Glass Material */
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.03) 100%
  );
  backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  box-shadow:
    var(--shadow-lg),
    inset 0 1px 0 var(--glass-highlight);

  display: flex;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;

  transition: all var(--duration-normal) var(--ease-out-expo);
}

.bottom-tab-bar:hover {
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.1) 0%,
    rgba(255, 255, 255, 0.04) 100%
  );
  border-color: var(--glass-border-hover);
}

.tab-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px 20px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
  color: var(--text-muted);
}

.tab-item:hover {
  background: rgba(255, 255, 255, 0.06);
  color: var(--text-secondary);
}

.tab-item.active {
  background: rgba(48, 209, 88, 0.15);
  color: var(--accent);
}

.tab-item svg {
  width: 24px;
  height: 24px;
  margin-bottom: 4px;
  stroke: currentColor;
  fill: none;
  stroke-width: 1.5;
}

.tab-item.active svg {
  stroke: var(--accent);
  filter: drop-shadow(0 0 8px var(--accent-glow));
}

.tab-item span {
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.3px;
}

/* Hide phone slot on desktop (phone stays as sibling in hero) */
.hero-phone-slot { display: none; }

/* Hide bottom tab on desktop, show on mobile */
@media (min-width: 769px) {
  .bottom-tab-bar {
    display: none;
  }
}

@media (max-width: 768px) {
  .bottom-tab-bar {
    display: flex;
  }
  .nav {
    display: none !important;
  }
  body {
    padding-bottom: 100px; /* Space for bottom tab bar */
  }
}

.logo {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.3px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.logo span {
  color: var(--accent);
  text-shadow: 0 0 20px var(--accent-glow);
}

.nav {
  display: flex;
  gap: 8px;
}
.nav a {
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  padding: 8px 16px;
  border-radius: var(--radius-md);
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.nav a:hover {
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.06);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO â€” Spatial Layout with Depth
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO â€” Vision OS 2 Spatial Depth
   Elements float in space with true 3D perspective
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.hero {
  padding: 160px 40px 120px;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  gap: 100px;
  max-width: 1400px;
  margin: 0 auto;
  perspective: 1200px;
  position: relative;
}

/* Ambient gradient glow behind hero */
.hero::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 30%;
  width: 600px;
  height: 600px;
  background: radial-gradient(
    circle,
    rgba(48, 209, 88, 0.08) 0%,
    transparent 70%
  );
  transform: translate(-50%, -50%);
  pointer-events: none;
  filter: blur(80px);
}

.hero-content {
  max-width: 520px;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO â€” Soho House Editorial + Game Theory
   Warm, sophisticated, exclusive â€” speaks to taste, not tech
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Credibility Badge â€” Exclusivity signal */
.hero-credibility {
  margin-bottom: 32px;
}

.credibility-badge {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 2px;
  color: var(--accent);
  text-transform: uppercase;
}

.badge-icon {
  font-size: 8px;
  opacity: 0.8;
}

/* Editorial Headline â€” Serif + Sans mix like Soho House */
.hero h1 {
  font-family: var(--font-body);
  font-size: 52px;
  font-weight: 600;
  line-height: 1.15;
  letter-spacing: -1.5px;
  margin-bottom: 28px;
  color: #fff;
}

.headline-italic {
  font-family: var(--font-display);
  font-style: normal;
  font-weight: 300;
  color: var(--accent);
}

.hero-tagline {
  font-size: 17px;
  font-weight: 400;
  color: rgba(255, 255, 255, 0.5);
  line-height: 1.75;
  margin-bottom: 32px;
  max-width: 460px;
}

/* Feature bullets */
.hero-features {
  list-style: none;
  margin-bottom: 32px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.hero-features li {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 15px;
  color: rgba(255, 255, 255, 0.7);
}

.hero-features .bullet {
  color: var(--accent);
  font-size: 8px;
}

/* Live Indicator â€” Clean, tech-forward */
.hero-live-indicator {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 12px 20px;
  background: rgba(29, 185, 84, 0.06);
  border: 1px solid rgba(29, 185, 84, 0.12);
  border-radius: 8px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.65);
  margin-bottom: 36px;
}

.live-dot {
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 50%;
  animation: pulse-live 2s ease-in-out infinite;
  box-shadow: 0 0 12px var(--accent-glow);
}

@keyframes pulse-live {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.8); }
}

.hero-buttons {
  display: flex;
  gap: 16px;
  justify-content: flex-start;
  margin-bottom: 24px;
}

/* Trust line â€” understated confidence */
.hero-guarantee {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.35);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS â€” VisionOS 2 Liquid Glass & Spatial Depth
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 14px 28px;
  border-radius: var(--radius-lg);
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  position: relative;
  overflow: hidden;
  transition: all var(--duration-normal) var(--ease-out-expo);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO CTA â€” Vision OS 2 + Game Theory

   Game Theory: Single dominant strategy (one button = no choice paralysis)
   Vision OS 2: Floating pill with specular highlight, spatial shadow
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn-hero-cta {
  padding: 20px 40px;
  font-size: 16px;
  font-weight: 600;
  letter-spacing: -0.2px;
  border-radius: 100px; /* Pill shape â€” Vision OS 2 */

  /* Solid confident color */
  background: linear-gradient(180deg, #3ee066 0%, #30d158 100%);
  color: #000;
  border: none;

  /* Spatial depth â€” floating above surface */
  box-shadow:
    0 0 0 1px rgba(255, 255, 255, 0.1) inset,
    0 1px 0 rgba(255, 255, 255, 0.25) inset, /* Top specular */
    0 -1px 0 rgba(0, 0, 0, 0.1) inset, /* Bottom shadow */
    0 20px 40px -10px rgba(48, 209, 88, 0.4),
    0 10px 20px -5px rgba(0, 0, 0, 0.2);

  position: relative;
  overflow: hidden;
  transform: translateZ(0); /* GPU acceleration */
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
}

/* Specular highlight sweep on hover */
.btn-hero-cta::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.2) 50%,
    transparent 100%
  );
  transition: left 0.6s ease;
}

.btn-hero-cta:hover::before {
  left: 100%;
}

.btn-hero-cta:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow:
    0 0 0 1px rgba(255, 255, 255, 0.15) inset,
    0 1px 0 rgba(255, 255, 255, 0.3) inset,
    0 30px 60px -15px rgba(48, 209, 88, 0.5),
    0 15px 30px -10px rgba(0, 0, 0, 0.25);
}

.btn-hero-cta:active {
  transform: translateY(-2px) scale(1.01);
  box-shadow:
    0 4px 16px rgba(48, 209, 88, 0.2),
    0 1px 4px rgba(0, 0, 0, 0.2);
}

.btn-hero-cta svg {
  width: 20px;
  height: 20px;
  opacity: 0.8;
}

.btn-primary {
  background: var(--accent);
  color: #000;
  box-shadow:
    0 4px 16px rgba(48, 209, 88, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-primary:hover {
  background: var(--accent-hover);
  transform: translateY(-3px) scale(1.02);
  box-shadow:
    0 8px 32px rgba(48, 209, 88, 0.4),
    0 0 60px rgba(48, 209, 88, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.btn-primary:active {
  transform: translateY(-1px) scale(0.98);
}

.btn-secondary {
  background: var(--glass-bg);
  color: var(--text-primary);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: var(--shadow-sm);
}

.btn-secondary:hover {
  background: var(--glass-bg-hover);
  border-color: var(--glass-border-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.hero-stats {
  display: flex;
  align-items: center;
  gap: 24px;
  margin-top: 32px;
  font-size: 13px;
  color: var(--text-muted);
}

.stars {
  color: #fbbf24;
  text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHONE PREVIEW â€” Floating Device with Spatial Depth
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.phone-preview {
  position: relative;
  display: flex;
  justify-content: center;
  perspective: 1200px;
}

/* iPhone 17 Pro Frame â€” Titanium Design Language */
.phone-frame {
  width: 300px;
  height: 620px;
  background: #000;
  border-radius: 52px;
  border: 3px solid #1a1a1a;
  overflow: hidden;
  position: relative;
  box-shadow:
    /* Subtle depth shadow only */
    0 50px 100px rgba(0, 0, 0, 0.6),
    0 25px 50px rgba(0, 0, 0, 0.4);
  transition: transform var(--duration-slow) var(--ease-out-expo);
}

.phone-frame:hover {
  transform: translateY(-8px);
}

/* iPhone 17 Pro Dynamic Island */
.phone-notch {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  width: 120px;
  height: 34px;
  background: #000;
  border-radius: 20px;
  z-index: 20;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.05);
}

/* Dynamic Island inner elements */
.phone-notch::before {
  content: "";
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 10px;
  height: 10px;
  background: radial-gradient(circle, #1a1a1a 40%, #0a0a0a 100%);
  border-radius: 50%;
  box-shadow: inset 0 0 2px rgba(255, 255, 255, 0.1);
}

.phone-notch::after {
  content: "";
  position: absolute;
  right: 26px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  background: radial-gradient(circle, #1a1a1a 40%, #0a0a0a 100%);
  border-radius: 50%;
}

.phone-screen {
  width: 100%;
  height: 100%;
  background: #000;
  position: relative;
  overflow: hidden;
}

.phone-screen > video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* Spotify Now Playing Overlay â€” Matches real Spotify design */
.phone-screen .spotify-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.85) 40%, rgba(0,0,0,0.5) 70%, transparent 100%);
  padding: 16px 20px 28px;
  z-index: 10;
  box-sizing: border-box;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.spotify-now-playing {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Track title section - centered at top */
.spotify-track-title {
  text-align: center;
  padding-bottom: 8px;
}

.spotify-track-name {
  font-size: 22px;
  font-weight: 700;
  color: #fff;
  margin: 0 0 4px 0;
  letter-spacing: -0.3px;
}

.spotify-artist-name {
  font-size: 14px;
  color: rgba(255,255,255,0.7);
  margin: 0;
  font-weight: 500;
}

/* Track info row - album art, song info, heart */
.spotify-track-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.spotify-album-art {
  width: 56px;
  height: 56px;
  border-radius: 4px;
  background: linear-gradient(135deg, #D2A05A, #B4828C);
  flex-shrink: 0;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.spotify-album-art video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.spotify-track-text {
  flex: 1;
  min-width: 0;
}

.spotify-track-text .track-name {
  font-size: 15px;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin: 0 0 2px 0;
}

.spotify-track-text .artist-name {
  font-size: 13px;
  color: rgba(255,255,255,0.7);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin: 0;
}

.spotify-heart {
  width: 24px;
  height: 24px;
  color: #1ed760;
  flex-shrink: 0;
  cursor: pointer;
  transition: transform 0.15s ease;
}

.spotify-heart:hover {
  transform: scale(1.1);
}

/* Spotify Progress Bar */
.spotify-progress {
  display: flex;
  align-items: center;
  gap: 8px;
}

.spotify-time {
  font-size: 10px;
  color: rgba(255,255,255,0.5);
  width: 28px;
  text-align: center;
}

.spotify-progress-bar {
  flex: 1;
  height: 3px;
  background: rgba(255,255,255,0.2);
  border-radius: 2px;
  overflow: hidden;
}

.spotify-progress-fill {
  height: 100%;
  width: 35%;
  background: #1ed760;
  border-radius: 2px;
  animation: progress-loop 7s linear infinite;
}

@keyframes progress-loop {
  0% { width: 0%; }
  100% { width: 100%; }
}

/* Spotify Controls */
.spotify-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 24px;
  margin-top: 4px;
}

.spotify-control-btn {
  background: none;
  border: none;
  color: rgba(255,255,255,0.9);
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s ease, color 0.15s ease;
}

.spotify-control-btn:hover {
  color: #fff;
  transform: scale(1.1);
}

.spotify-control-btn.play-btn {
  width: 48px;
  height: 48px;
  background: #fff;
  border-radius: 50%;
  color: #000;
  opacity: 1 !important; /* Override generic .play-btn opacity */
}

.spotify-control-btn.play-btn:hover {
  transform: scale(1.05);
  color: #000;
}

.spotify-control-btn svg {
  width: 20px;
  height: 20px;
}

.spotify-control-btn.play-btn svg {
  width: 24px;
  height: 24px;
  margin-left: 2px;
}

.loop-badge {
  position: absolute;
  top: 50px;
  right: 16px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 6px 14px;
  border-radius: var(--radius-lg);
  font-size: 11px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  border: 1px solid var(--glass-border);
}

.loop-badge::before {
  content: "";
  width: 6px;
  height: 6px;
  background: var(--accent);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--accent);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.9); }
}
/* Sound toggle - Apple-style minimal */
.sound-toggle {
  position: absolute;
  bottom: 20px;
  right: 20px;
  width: 36px;
  height: 36px;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid rgba(255,255,255,0.1);
  z-index: 20;
}
.sound-toggle:hover {
  background: rgba(0,0,0,0.7);
  transform: scale(1.05);
}
.sound-toggle:active {
  transform: scale(0.95);
}
.sound-toggle svg {
  width: 16px;
  height: 16px;
  fill: rgba(255,255,255,0.9);
}
.sound-toggle.muted svg.sound-on { display: none; }
.sound-toggle.muted svg.sound-off { display: block; }
.sound-toggle:not(.muted) svg.sound-on { display: block; }
.sound-toggle:not(.muted) svg.sound-off { display: none; }
.phone-info {
  position: absolute;
  bottom: 60px;
  left: 20px;
  right: 20px;
  background: rgba(30,30,30,0.8);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 16px;
}
.phone-info h4 { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
.phone-info p { font-size: 12px; color: var(--text-secondary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FEATURES SECTION â€” Jony Ive: Typography-First, Generous Space

   Game Theory: Information asymmetry reduction (clear value = faster conversion)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.features-section {
  text-align: center;
  padding: 160px 40px;
}

.features-section h2 {
  font-size: 48px;
  font-weight: 600;
  letter-spacing: -1px;
  margin-bottom: 80px;
}

.features-minimal {
  max-width: 600px;
  margin: 0 auto;
  text-align: left;
}

.feature-row {
  padding: 32px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.feature-row:last-child {
  border-bottom: none;
}

.feature-title {
  font-size: 20px;
  font-weight: 600;
  color: #fff;
  margin-bottom: 8px;
}

.feature-desc {
  font-size: 15px;
  color: rgba(255, 255, 255, 0.5);
  line-height: 1.6;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICING SECTION â€” Jony Ive: Radical Simplicity

   Game Theory: Anchoring effect (show value first), choice architecture (2 options)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pricing-section {
  text-align: center;
  padding: 160px 40px;
  background: #080808;
}

.pricing-section h2 {
  font-size: 56px;
  font-weight: 600;
  letter-spacing: -1.5px;
  margin-bottom: 16px;
}

.pricing-subhead {
  font-size: 18px;
  color: rgba(255, 255, 255, 0.4);
  margin-bottom: 64px;
}

.pricing-minimal {
  display: flex;
  justify-content: center;
  gap: 48px;
  flex-wrap: wrap;
}

.price-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 40px 48px;
  border-radius: 20px;
  background: #0d0d0d;
  min-width: 200px;
  transition: all 0.4s var(--ease-out-expo);
}

.price-option:hover {
  transform: translateY(-4px);
  background: #111;
}

.price-option.featured {
  background: #111;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08);
}

.price-name {
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: rgba(255, 255, 255, 0.4);
  margin-bottom: 12px;
}

.price-value {
  font-size: 40px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.price-detail {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.35);
  text-align: center;
}

.pricing-note {
  margin-top: 20px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.3);
}

@media (max-width: 900px) {
  .features-section h2,
  .pricing-section h2 {
    font-size: 36px;
  }

  .pricing-minimal {
    flex-direction: column;
    align-items: center;
  }
}

/* Mood Library Section */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTIONS â€” Spatial Layout with Depth Hierarchy
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.section {
  padding: 120px 40px;
  max-width: 1400px;
  margin: 0 auto;
  position: relative;
}

.section-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 2.5px;
  color: var(--accent);
  margin-bottom: 16px;
  font-weight: 500;
}

.section h2 {
  font-family: var(--font-body);
  font-size: 36px;
  font-weight: 500;
  letter-spacing: -0.5px;
  margin-bottom: 16px;
  color: #fff;
}

.section h2 .headline-italic {
  font-family: var(--font-display);
  font-style: normal;
  font-weight: 300;
  color: var(--accent);
}

.section > p {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.5);
  margin-bottom: 48px;
  max-width: 580px;
  line-height: 1.7;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOOD GRID â€” 4 Rows Ã— 3 Columns with Vertical Scroll Parallax
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.mood-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 28px;
  perspective: 1200px;
  margin-top: 48px;
}

/* Cinematographer reference */
.mood-cinematographer {
  font-size: 10px;
  color: var(--text-dim);
  font-style: italic;
  margin-top: 10px;
  text-transform: capitalize;
  letter-spacing: 0.3px;
}

/* VisionOS Glass Card with Vertical Scroll Parallax */
.mood-card {
  /* Parallax CSS custom properties (set by JS on scroll) */
  --parallax-y: 0px;
  --parallax-scale: 1;
  --parallax-opacity: 1;
  --parallax-rotateX: 0deg;

  border-radius: var(--radius-lg);
  overflow: hidden;
  cursor: pointer;
  position: relative;
  transform-style: preserve-3d;

  /* Parallax transform from JS variables */
  transform:
    translateY(var(--parallax-y))
    scale(var(--parallax-scale))
    rotateX(var(--parallax-rotateX));
  opacity: var(--parallax-opacity);

  transition:
    transform 0.1s ease-out,
    opacity 0.1s ease-out,
    box-shadow var(--duration-normal) var(--ease-out-expo),
    border-color var(--duration-normal) var(--ease-out-expo);

  /* VisionOS Glass Material */
  background: linear-gradient(
    145deg,
    rgba(255, 255, 255, 0.05) 0%,
    rgba(255, 255, 255, 0.01) 100%
  );
  backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
  border: 1px solid var(--glass-border);
  box-shadow:
    var(--shadow-md),
    inset 0 1px 0 var(--glass-highlight),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

/* Hover state - lift card toward viewer */
.mood-card:hover {
  transform:
    translateY(calc(var(--parallax-y) - 12px))
    scale(calc(var(--parallax-scale) * 1.03))
    rotateX(var(--parallax-rotateX));
  background: linear-gradient(
    145deg,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.02) 100%
  );
  border-color: var(--glass-border-hover);
  box-shadow:
    var(--shadow-lg),
    0 0 60px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.15);
  --parallax-opacity: 1;
  z-index: 10;
}

/* Signature card - glowing accent border */
.mood-card.signature {
  border: 1px solid rgba(48, 209, 88, 0.4);
  box-shadow:
    var(--shadow-md),
    0 0 40px var(--accent-glow),
    inset 0 1px 0 var(--glass-highlight);
}
.mood-card.signature::before {
  content: "";
  position: absolute;
  top: -1px;
  left: -1px;
  right: -1px;
  bottom: -1px;
  border-radius: 25px;
  background: linear-gradient(135deg, rgba(30, 215, 96, 0.3), transparent 50%);
  z-index: -1;
  opacity: 0.5;
}
.mood-card.signature::after {
  content: "SIGNATURE";
  position: absolute;
  top: 16px;
  right: 16px;
  background: rgba(30, 215, 96, 0.9);
  color: #000;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  z-index: 10;
  backdrop-filter: blur(10px);
}

/* Video container with depth */
.mood-visual {
  height: 400px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-radius: 24px 24px 0 0;
}
.mood-visual video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
}
.mood-card:hover .mood-visual video {
  transform: scale(1.05);
}

/* Play button - VisionOS style */
.mood-play-btn {
  position: absolute;
  width: 64px;
  height: 64px;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
  z-index: 5;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}
.mood-play-btn svg {
  width: 24px;
  height: 24px;
  fill: rgba(255, 255, 255, 0.9);
  margin-left: 4px;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
}
.mood-card:hover .mood-play-btn {
  opacity: 1;
  transform: scale(1.1);
}

/* Playing state */
.mood-card.playing .mood-play-btn {
  opacity: 1;
  background: rgba(30, 215, 96, 0.3);
  border-color: rgba(30, 215, 96, 0.5);
}
.mood-card.playing .mood-play-btn svg {
  margin-left: 0;
  fill: var(--accent);
}
.mood-card.playing {
  transform:
    translateY(calc(var(--parallax-y) - 8px))
    scale(calc(var(--parallax-scale) * 1.03))
    rotateX(var(--parallax-rotateX));
  --parallax-opacity: 1;
  z-index: 10;
  box-shadow:
    0 24px 64px rgba(30, 215, 96, 0.2),
    0 0 60px rgba(30, 215, 96, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  border-color: rgba(30, 215, 96, 0.4);
}

/* Info section - glass panel */
.mood-info {
  padding: 20px 24px 24px;
  background: linear-gradient(
    180deg,
    rgba(0, 0, 0, 0) 0%,
    rgba(0, 0, 0, 0.4) 100%
  );
  position: relative;
}
.mood-info h4 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 4px;
  letter-spacing: -0.3px;
}
.mood-info .mood-artist {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.mood-info .mood-desc {
  font-size: 13px;
  color: var(--text-muted);
  line-height: 1.5;
  margin-bottom: 12px;
}

/* Tags */
.mood-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.mood-tag {
  padding: 5px 12px;
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  border-radius: 6px;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-secondary);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Scroll indicators */
.carousel-nav {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 24px;
}
.carousel-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  cursor: pointer;
}
.carousel-dot.active {
  background: var(--accent);
  width: 24px;
  border-radius: 4px;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .mood-card {
    flex: 0 0 280px;
  }
  .mood-visual {
    height: 350px;
  }
  .mood-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
}

/* Legacy gradient backgrounds (fallback) */
.mood-visual.euphoric { background: linear-gradient(180deg, #ff6b35 0%, #f72585 100%); }
.mood-visual.dark { background: linear-gradient(180deg, #667eea 0%, #3b4371 100%); }
.mood-visual.nostalgic { background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%); }
.mood-visual.longing { background: linear-gradient(180deg, #ffecd2 0%, #fcb69f 100%); }
.mood-visual.haunting { background: linear-gradient(180deg, #a8c0ff 0%, #3f2b96 100%); }
.mood-visual.hype { background: linear-gradient(180deg, #f857a6 0%, #ff5858 100%); }
.mood-visual.euphoric { background: linear-gradient(180deg, #ff6b35 0%, #f72585 100%); }
.mood-visual.dark { background: linear-gradient(180deg, #667eea 0%, #3b4371 100%); }
.mood-visual.nostalgic { background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%); }
.mood-visual.longing { background: linear-gradient(180deg, #ffecd2 0%, #fcb69f 100%); }
.mood-visual.haunting { background: linear-gradient(180deg, #a8c0ff 0%, #3f2b96 100%); }
.mood-visual.hype { background: linear-gradient(180deg, #f857a6 0%, #ff5858 100%); }
.play-btn {
  width: 60px;
  height: 60px;
  background: rgba(255,255,255,0.9);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
}
.mood-card:hover .play-btn { opacity: 1; }
.play-btn svg { width: 24px; height: 24px; margin-left: 4px; }
.mood-info {
  padding: 20px;
}
.mood-info h3, .mood-info h4 { font-size: 16px; font-weight: 500; margin-bottom: 4px; }
.mood-info .artist, .mood-info .mood-artist { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
.mood-info .description, .mood-info .mood-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.4; }
.mood-tags {
  display: flex;
  gap: 8px;
}
.mood-tag {
  padding: 4px 10px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPLOAD MODAL â€” Jony Ive: Light as Material, Depth Through Shadow

   Principles:
   - Surface should feel like frosted glass catching light
   - Depth comes from shadow, not borders
   - Warmth through subtle color temperature
   - Confidence through generous space
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(80px) saturate(150%);
  -webkit-backdrop-filter: blur(80px) saturate(150%);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-overlay.active { display: flex; }

.modal {
  /* Warm dark surface - not pure black */
  background: linear-gradient(
    180deg,
    rgba(32, 32, 34, 0.98) 0%,
    rgba(24, 24, 26, 0.99) 100%
  );
  border-radius: 24px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  width: 90%;
  max-width: 400px;
  padding: 44px 36px;
  text-align: center;

  /* Depth through shadow layers - Ive signature */
  box-shadow:
    0 0 0 1px rgba(255, 255, 255, 0.05) inset,
    0 1px 0 rgba(255, 255, 255, 0.06) inset,
    0 25px 50px -12px rgba(0, 0, 0, 0.5),
    0 50px 100px -20px rgba(0, 0, 0, 0.4);

  animation: modalFloat 0.5s var(--ease-out-expo);
}

@keyframes modalFloat {
  from {
    opacity: 0;
    transform: scale(0.96) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.modal h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 6px;
  letter-spacing: -0.3px;
  color: #fff;
}

.modal > p {
  color: rgba(255, 255, 255, 0.4);
  margin-bottom: 28px;
  font-size: 14px;
  line-height: 1.5;
}

/* === Upload Zone â€” Elevated Surface === */
.upload-zone {
  /* Slightly elevated from modal */
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 16px;
  padding: 40px 28px;
  text-align: center;
  cursor: pointer;
  transition: all 0.35s var(--ease-out-expo);
  position: relative;
}

/* Top edge light catch */
.upload-zone::before {
  content: '';
  position: absolute;
  top: 0;
  left: 16px;
  right: 16px;
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.12) 50%,
    transparent 100%
  );
  border-radius: 1px;
}

.upload-zone:hover {
  background: rgba(255, 255, 255, 0.06);
  border-color: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.upload-zone.drag-over {
  background: rgba(48, 209, 88, 0.08);
  border-color: rgba(48, 209, 88, 0.25);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
}

.upload-zone svg {
  width: 40px;
  height: 40px;
  color: rgba(255, 255, 255, 0.45);
  margin-bottom: 16px;
  transition: all 0.35s var(--ease-out-expo);
}

.upload-zone:hover svg {
  color: rgba(255, 255, 255, 0.65);
  transform: translateY(-2px);
}

.upload-zone h4 {
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 4px;
  color: rgba(255, 255, 255, 0.8);
}

.upload-zone p {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.35);
  letter-spacing: 0.2px;
}

.upload-zone input { display: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT MODAL â€” Game Theory Paywall

   Principles:
   - Endowment Effect: They see their canvas, they "own" it
   - Sunk Cost: They've invested time, don't want to lose it
   - Anchoring: Show premium first, canvas feels like a deal
   - Loss Aversion: "Download with watermark" = what they'll lose
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.export-modal {
  display: flex;
  max-width: 560px;
  padding: 0;
  overflow: hidden;
}

.export-preview {
  width: 180px;
  background: #000;
  flex-shrink: 0;
}

.export-preview video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.export-content {
  flex: 1;
  padding: 36px 32px;
}

.export-content h2 {
  font-size: 22px;
  margin-bottom: 6px;
}

.export-content > p {
  color: rgba(255, 255, 255, 0.45);
  font-size: 14px;
  margin-bottom: 24px;
}

.export-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 24px;
}

.export-option {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
}

.export-option:hover {
  border-color: rgba(255, 255, 255, 0.15);
  background: rgba(255, 255, 255, 0.05);
}

.export-option.featured {
  border-color: rgba(48, 209, 88, 0.3);
  background: rgba(48, 209, 88, 0.05);
}

.export-option.featured:hover {
  border-color: rgba(48, 209, 88, 0.5);
}

.export-option.selected {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent);
}

.export-option-badge {
  position: absolute;
  top: -8px;
  right: 12px;
  background: var(--accent);
  color: #000;
  font-size: 9px;
  font-weight: 700;
  padding: 4px 8px;
  border-radius: 4px;
  letter-spacing: 0.5px;
}

.export-option-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 4px;
}

.export-option-name {
  font-size: 14px;
  font-weight: 600;
  color: #fff;
}

.export-option-price {
  font-size: 18px;
  font-weight: 700;
  color: #fff;
}

.export-option-detail {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.4);
}

.export-cta {
  width: 100%;
  margin-bottom: 16px;
}

.export-note {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.35);
  text-align: center;
}

.export-note a {
  color: rgba(255, 255, 255, 0.5);
  text-decoration: underline;
}

.export-note a:hover {
  color: rgba(255, 255, 255, 0.7);
}

/* Free Trial State */
.trial-badge {
  display: inline-block;
  background: linear-gradient(135deg, #30d158 0%, #34c759 100%);
  color: #000;
  font-size: 10px;
  font-weight: 700;
  padding: 5px 10px;
  border-radius: 6px;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

.trial-remaining {
  color: rgba(255, 255, 255, 0.5);
  font-size: 13px;
  margin-bottom: 20px;
}

.trial-remaining span {
  color: var(--accent);
  font-weight: 600;
}

.export-formats {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.3);
  text-align: center;
  margin-top: 12px;
}

/* Apple Pay Button */
.apple-pay-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  color: #000;
  font-weight: 600;
}

.apple-pay-btn:hover {
  background: rgba(255, 255, 255, 0.9);
}

.modal-close {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 32px;
  height: 32px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 50%;
  color: rgba(255, 255, 255, 0.6);
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
}

@media (max-width: 600px) {
  .export-modal {
    flex-direction: column;
    max-width: 340px;
  }
  .export-preview {
    width: 100%;
    height: 200px;
  }
}

/* Generating State */
.generating-state {
  text-align: center;
  padding: 60px 20px;
  display: none;
}
.generating-state.active { display: block; }
.spinner-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 32px;
}
.spinner {
  width: 120px;
  height: 120px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
.spinner-inner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 32px;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.7; transform: translate(-50%, -50%) scale(0.9); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.generating-state h3 { font-size: 20px; margin-bottom: 8px; }
.generating-state p { color: var(--text-secondary); font-size: 14px; }
.generating-state .fun-message {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 16px;
  min-height: 20px;
  animation: fadeInUp 0.5s ease;
}
.generating-state .progress-bar {
  width: 200px;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin: 20px auto 0;
  overflow: hidden;
}
.generating-state .progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  width: 0%;
  transition: width 0.5s ease;
}
.generating-state .stage-dots {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 16px;
}
.generating-state .stage-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--border);
  transition: all 0.3s;
}
.generating-state .stage-dot.active {
  background: var(--accent);
  transform: scale(1.2);
}
.generating-state .stage-dot.done {
  background: var(--accent);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS ENGINE â€” Full-Screen Processing View
   The $50K director-grade pipeline experience.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â•â•â• CANVAS ENGINE v3 â€” Video IS the interface â•â•â• */
.canvas-engine {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 250;
  display: none;
  animation: ceEnter 0.6s var(--ease-out-expo);
}
.canvas-engine.active { display: block; }
@keyframes ceEnter { from { opacity: 0; } to { opacity: 1; } }
@keyframes ceFadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.ce-layout {
  display: flex;
  flex-direction: column;
  height: 100vh;
  position: relative;
}

/* Full-bleed video */
.ce-video-wrap {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ce-video-wrap video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: filter 0.6s ease, opacity 0.4s ease;
}
.ce-video-wrap video.iterating {
  filter: blur(12px) saturate(0.3) brightness(0.6);
  opacity: 0.7;
}
.ce-video-wrap video.revealing {
  filter: blur(0px) saturate(1.2) brightness(1.05);
  opacity: 1;
}
/* Iteration feedback overlay */
.ce-iterate-feedback {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 4;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s;
}
.ce-iterate-feedback.active {
  opacity: 1;
}
.ce-iterate-label {
  padding: 10px 24px;
  border-radius: 24px;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(16px);
  color: rgba(255,255,255,0.9);
  font-size: 14px;
  font-weight: 500;
  font-family: var(--font-body);
  letter-spacing: 0.02em;
}
.ce-video-placeholder {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
}
.ce-video-pulse {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid rgba(29,185,84,0.4);
  animation: cePulse 2s ease-in-out infinite;
}
@keyframes cePulse {
  0%, 100% { transform: scale(1); opacity: 0.4; }
  50% { transform: scale(1.2); opacity: 1; }
}
.ce-loading-text {
  font-size: 14px;
  color: rgba(255,255,255,0.5);
  font-family: var(--font-body);
  letter-spacing: 0.02em;
}

/* Floating overlays on the video */
.ce-overlay-top {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
  z-index: 2;
}
.ce-back-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}
.ce-back-btn:hover { background: rgba(255,255,255,0.2); }
.ce-status-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.1em;
  color: rgba(255,255,255,0.8);
  font-family: var(--font-body);
}
.ce-status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
  animation: cePulse 2s ease-in-out infinite;
}
.ce-quality-score {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent);
  font-family: var(--font-body);
  transition: opacity 0.5s ease;
  text-shadow: 0 2px 20px rgba(29,185,84,0.4);
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
  padding: 4px 12px;
  border-radius: 12px;
}

.ce-overlay-bottom {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 48px 28px 20px;
  background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
  z-index: 2;
}
.ce-track-info {
  margin-bottom: 10px;
}
.ce-track-name {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  font-family: var(--font-body);
  letter-spacing: -0.02em;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 80%;
}
.ce-track-meta {
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-top: 4px;
  font-family: var(--font-body);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.ce-timeline {
  margin-top: 8px;
}
.ce-timeline-bar {
  height: 3px;
  background: rgba(255,255,255,0.15);
  border-radius: 2px;
  overflow: hidden;
}
.ce-timeline-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  width: 0%;
  transition: width 0.3s linear;
}

/* Director picker overlay */
.ce-directors-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  z-index: 5;
  animation: ceFadeUp 0.4s ease-out;
}
.ce-directors-title {
  font-size: 28px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 32px;
  font-family: var(--font-body);
  letter-spacing: -0.02em;
}
.ce-directions-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
  max-width: 500px;
}
/* â•â•â• Director Picker â€” Apple Card Design â•â•â• */
.ce-dir-option {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 16px;
  border-radius: 16px;
  border: 1.5px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.03);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}
.ce-dir-option:hover {
  border-color: rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.05);
  transform: scale(1.01);
}
.ce-dir-option.selected {
  border-color: rgba(255,255,255,0.25);
  background: rgba(255,255,255,0.06);
}
.ce-dir-option.selected::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 16px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
  pointer-events: none;
}
.ce-dir-preview {
  width: 52px;
  height: 52px;
  border-radius: 12px;
  flex-shrink: 0;
  object-fit: cover;
  opacity: 0.85;
  transition: opacity 0.4s ease;
}
.ce-dir-option:hover .ce-dir-preview,
.ce-dir-option.selected .ce-dir-preview {
  opacity: 1;
}
.ce-dir-info { flex: 1; min-width: 0; }
.ce-dir-name {
  font-size: 15px;
  font-weight: 500;
  color: rgba(255,255,255,0.9);
  font-family: var(--font-body);
  letter-spacing: -0.01em;
}
.ce-dir-desc {
  font-size: 12px;
  color: rgba(255,255,255,0.35);
  margin-top: 3px;
  line-height: 1.4;
  letter-spacing: 0.01em;
}
.ce-dir-match {
  font-size: 13px;
  font-weight: 500;
  color: rgba(255,255,255,0.4);
  white-space: nowrap;
  letter-spacing: 0.01em;
}

/* â•â•â• Generation Progress Overlay â€” Apple Design Language â•â•â• */
.ce-gen-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.92);
  backdrop-filter: blur(40px) saturate(1.8);
  -webkit-backdrop-filter: blur(40px) saturate(1.8);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0;
  z-index: 4;
  padding: 60px 40px;
  text-align: center;
}
.ce-gen-headline {
  font-size: 32px;
  font-weight: 600;
  color: #fff;
  font-family: var(--font-display);
  letter-spacing: -0.03em;
  line-height: 1.15;
  margin-bottom: 12px;
}
.ce-gen-headline span {
  background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.6));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.ce-gen-label {
  font-size: 15px;
  color: rgba(255,255,255,0.4);
  font-family: var(--font-body);
  max-width: 300px;
  line-height: 1.6;
  font-weight: 400;
  letter-spacing: 0.01em;
  margin-bottom: 32px;
}
.ce-gen-steps {
  display: flex;
  flex-direction: column;
  gap: 0;
  margin: 0 0 28px;
  width: 100%;
  max-width: 280px;
}
.ce-gen-step {
  display: flex;
  align-items: center;
  gap: 14px;
  font-size: 14px;
  color: rgba(255,255,255,0.22);
  font-family: var(--font-body);
  font-weight: 400;
  letter-spacing: 0.01em;
  padding: 10px 0;
  transition: color 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateX(0);
}
.ce-gen-step.active {
  color: rgba(255,255,255,0.95);
  transform: translateX(2px);
}
.ce-gen-step.done {
  color: rgba(255,255,255,0.35);
}
.ce-gen-step-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1.5px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  flex-shrink: 0;
  transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  background: transparent;
}
.ce-gen-step.active .ce-gen-step-icon {
  border-color: rgba(255,255,255,0.5);
  background: rgba(255,255,255,0.08);
  box-shadow: 0 0 20px rgba(255,255,255,0.06);
}
.ce-gen-step.done .ce-gen-step-icon {
  border-color: rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.04);
}
@keyframes genPulse { 0%,100%{opacity:0.3} 50%{opacity:1} }
.ce-gen-step.active .ce-gen-step-icon::after {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #fff;
  animation: genPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
.ce-progress-bar {
  width: 240px;
  height: 2px;
  background: rgba(255,255,255,0.06);
  border-radius: 1px;
  overflow: hidden;
  margin-bottom: 16px;
}
.ce-progress-fill {
  height: 100%;
  background: rgba(255,255,255,0.5);
  border-radius: 1px;
  width: 0%;
  transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.ce-gen-eta {
  font-size: 13px;
  color: rgba(255,255,255,0.25);
  font-family: var(--font-body);
  font-weight: 400;
  letter-spacing: 0.02em;
}
.ce-gen-eta strong {
  color: rgba(255,255,255,0.5);
  font-weight: 500;
}

/* Bottom drawer â€” creative tools */
.ce-drawer {
  background: rgba(10,10,10,0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid rgba(255,255,255,0.06);
  padding: 16px 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  animation: ceFadeUp 0.4s ease-out;
}

.ce-intent-bar {
  display: flex;
  gap: 8px;
}
.ce-intent-input {
  flex: 1;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 10px 16px;
  color: #fff;
  font-size: 14px;
  font-family: var(--font-body);
  outline: none;
  transition: border-color 0.2s;
}
.ce-intent-input:focus { border-color: var(--accent); }
.ce-intent-input::placeholder { color: rgba(255,255,255,0.3); font-style: italic; }
.ce-intent-send {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: #000;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s;
  flex-shrink: 0;
}
.ce-intent-send:hover { transform: scale(1.05); }

.ce-chips {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.ce-chips::-webkit-scrollbar { display: none; }
.ce-chip {
  padding: 5px 14px;
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,0.08);
  background: transparent;
  color: rgba(255,255,255,0.5);
  font-size: 12px;
  font-family: var(--font-body);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.ce-chip:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.ce-actions {
  display: flex;
  gap: 8px;
}
.ce-action {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.04);
  color: rgba(255,255,255,0.7);
  font-size: 12px;
  font-weight: 500;
  font-family: var(--font-body);
  cursor: pointer;
  transition: all 0.2s;
}
.ce-action:hover {
  border-color: rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.08);
  color: #fff;
}
.ce-action-more { flex: 0; padding: 10px 16px; }

@media (max-width: 600px) {
  .ce-overlay-top { padding: 12px 16px; }
  .ce-overlay-bottom { padding: 24px 16px 12px; }
  .ce-track-name { font-size: 18px; }
  .ce-drawer { padding: 10px 14px; }
  .ce-quality-score { font-size: 24px; }
  .ce-directors-overlay { padding: 24px; }
  .ce-directors-title { font-size: 22px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDITOR WORKSPACE â€” CapCut-Style Full-Screen Editor
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.editor-workspace {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--bg-void);
  z-index: 250;
}
.editor-workspace.active { display: flex; }

/* Editor Layout: Sidebar | Preview | AI Panel */
.editor-layout {
  display: grid;
  grid-template-columns: 280px 1fr 360px;
  height: 100vh;
  width: 100%;
}

/* === EDITOR HEADER === */
.editor-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  background: linear-gradient(
    180deg,
    rgba(0, 0, 0, 0.8) 0%,
    transparent 100%
  );
  z-index: 10;
}

.editor-back {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 8px 16px;
  border-radius: var(--radius-md);
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.editor-back:hover {
  background: rgba(255, 255, 255, 0.06);
  color: var(--text-primary);
}
.editor-back svg {
  width: 20px;
  height: 20px;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
}

.editor-title {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

.editor-actions {
  display: flex;
  gap: 12px;
}

/* === LEFT SIDEBAR â€” Mode Tabs & Controls === */
.editor-sidebar {
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding-top: 64px;
  overflow-y: auto;
}

.editor-mode-tabs {
  display: flex;
  padding: 12px;
  gap: 4px;
  border-bottom: 1px solid var(--border);
}

.mode-tab {
  flex: 1;
  padding: 10px 8px;
  border-radius: var(--radius-sm);
  font-size: 12px;
  font-weight: 500;
  text-align: center;
  cursor: pointer;
  color: var(--text-muted);
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.mode-tab:hover {
  color: var(--text-secondary);
  background: rgba(255, 255, 255, 0.04);
}
.mode-tab.active {
  color: var(--accent);
  background: rgba(48, 209, 88, 0.12);
}

.editor-controls {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.control-section {
  margin-bottom: 24px;
}

.control-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.control-section-header h4 {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-weight: 600;
}

.control-section-header .reset-btn {
  font-size: 10px;
  color: var(--accent);
  cursor: pointer;
  opacity: 0.7;
}
.control-section-header .reset-btn:hover { opacity: 1; }

/* Quick Actions Grid */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}

.quick-action {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 14px 8px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.quick-action:hover {
  background: var(--glass-bg-hover);
  border-color: var(--glass-border-hover);
  transform: translateY(-2px);
}
.quick-action.active {
  background: rgba(48, 209, 88, 0.12);
  border-color: rgba(48, 209, 88, 0.3);
}
.quick-action svg {
  width: 20px;
  height: 20px;
  stroke: var(--text-secondary);
  fill: none;
  stroke-width: 1.5;
}
.quick-action.active svg { stroke: var(--accent); }
.quick-action span {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.quick-action.active span { color: var(--accent); }

/* Slider Controls */
.editor-slider {
  margin-bottom: 16px;
}
.editor-slider label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.editor-slider label span {
  color: var(--text-muted);
  font-size: 11px;
}
.editor-slider input[type="range"] {
  width: 100%;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--border);
  border-radius: 2px;
  cursor: pointer;
}
.editor-slider input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Color Presets */
.color-presets {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.color-preset {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.color-preset:hover {
  transform: scale(1.1);
}
.color-preset.active {
  border-color: var(--accent);
  box-shadow: 0 0 12px var(--accent-glow);
}

/* === CENTER â€” Video Preview === */
.editor-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 40px 120px;
  position: relative;
  background: var(--bg-void);
}

.preview-container {
  position: relative;
  max-width: 100%;
}

.preview-frame {
  width: 300px;
  height: 533px;
  background: var(--bg-secondary);
  border-radius: 24px;
  overflow: hidden;
  position: relative;
  box-shadow:
    0 40px 80px rgba(0, 0, 0, 0.5),
    0 0 0 1px rgba(255, 255, 255, 0.1);
}

.preview-frame video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: filter 0.15s ease;
}

/* Grain overlay effect */
.preview-frame::after {
  content: '';
  position: absolute;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity: var(--grain-opacity, 0);
  mix-blend-mode: overlay;
  pointer-events: none;
}

/* Vignette effect */
.preview-frame::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent var(--vignette-size, 60%), rgba(0,0,0,0.8) 100%);
  pointer-events: none;
  z-index: 1;
}

/* Generating state */
.preview-frame.generating {
  display: flex;
  align-items: center;
  justify-content: center;
}

.preview-frame.generating::after {
  content: 'Generating AI video...';
  position: absolute;
  color: var(--text-secondary);
  font-size: 14px;
  text-align: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.preview-badge {
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 11px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--glass-border);
}
.preview-badge::before {
  content: "";
  width: 6px;
  height: 6px;
  background: var(--accent);
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}

/* Playback Controls */
.playback-controls {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-top: 24px;
}

.playback-btn {
  width: 48px;
  height: 48px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.playback-btn:hover {
  background: var(--glass-bg-hover);
  transform: scale(1.05);
}
.playback-btn.primary {
  width: 56px;
  height: 56px;
  background: var(--accent);
  border-color: transparent;
}
.playback-btn.primary:hover {
  background: var(--accent-hover);
}
.playback-btn svg {
  width: 20px;
  height: 20px;
  stroke: var(--text-primary);
  fill: none;
  stroke-width: 2;
}
.playback-btn.primary svg {
  stroke: #000;
  fill: #000;
  margin-left: 2px;
}

.time-display {
  font-size: 12px;
  color: var(--text-muted);
  font-family: 'SF Mono', Monaco, monospace;
}

/* Timeline Scrubber */
.timeline-scrubber {
  position: absolute;
  bottom: 40px;
  left: 40px;
  right: 40px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: 16px 20px;
}

.timeline-track {
  height: 40px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.timeline-waveform {
  position: absolute;
  inset: 0;
  opacity: 0.3;
  background: linear-gradient(
    90deg,
    transparent 0%,
    var(--accent) 20%,
    var(--accent) 40%,
    transparent 50%,
    var(--accent) 60%,
    var(--accent) 80%,
    transparent 100%
  );
}

.timeline-playhead {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--accent);
  box-shadow: 0 0 10px var(--accent-glow);
  left: 30%;
  transition: left 0.1s linear;
}
.timeline-playhead::before {
  content: "";
  position: absolute;
  top: -6px;
  left: -5px;
  width: 12px;
  height: 12px;
  background: var(--accent);
  border-radius: 50%;
  border: 2px solid var(--bg-void);
}

.timeline-markers {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  font-size: 10px;
  color: var(--text-muted);
  font-family: 'SF Mono', Monaco, monospace;
}

/* === RIGHT PANEL â€” AI Assistant === */
.editor-ai-panel {
  background: var(--bg-secondary);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding-top: 64px;
}

.ai-panel-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}

.ai-avatar {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--accent), #00d4aa);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ai-avatar svg {
  width: 20px;
  height: 20px;
  stroke: #000;
  fill: none;
  stroke-width: 2;
}

.ai-panel-header h3 {
  font-size: 14px;
  font-weight: 500;
}
.ai-panel-header p {
  font-size: 11px;
  color: var(--text-muted);
}

/* AI Suggestions */
.ai-suggestions {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.ai-suggestion {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  margin-bottom: 8px;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.ai-suggestion:hover {
  background: var(--glass-bg-hover);
  border-color: var(--glass-border-hover);
}
.ai-suggestion svg {
  width: 16px;
  height: 16px;
  stroke: var(--accent);
  fill: none;
  stroke-width: 2;
  flex-shrink: 0;
}
.ai-suggestion span {
  font-size: 12px;
  color: var(--text-secondary);
}

/* AI Chat */
.ai-chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.ai-chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.ai-message {
  margin-bottom: 16px;
  max-width: 90%;
}
.ai-message.user {
  margin-left: auto;
}
.ai-message.assistant {
  margin-right: auto;
}

.ai-message-content {
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 13px;
  line-height: 1.5;
}
.ai-message.user .ai-message-content {
  background: var(--accent);
  color: #000;
  border-bottom-right-radius: 4px;
}
.ai-message.assistant .ai-message-content {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-bottom-left-radius: 4px;
}

.ai-message-time {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 4px;
  padding: 0 4px;
}
.ai-message.user .ai-message-time { text-align: right; }

/* AI Input */
.ai-chat-input {
  padding: 16px;
  border-top: 1px solid var(--border);
}

.ai-input-wrapper {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px;
}

.ai-input-wrapper textarea {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text-primary);
  font-size: 13px;
  resize: none;
  font-family: inherit;
  max-height: 100px;
}
.ai-input-wrapper textarea::placeholder {
  color: var(--text-muted);
}
.ai-input-wrapper textarea:focus { outline: none; }

.ai-send-btn {
  width: 36px;
  height: 36px;
  background: var(--accent);
  border: none;
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--duration-fast) var(--ease-out-expo);
  flex-shrink: 0;
}
.ai-send-btn:hover {
  background: var(--accent-hover);
  transform: scale(1.05);
}
.ai-send-btn svg {
  width: 18px;
  height: 18px;
  stroke: #000;
  fill: none;
  stroke-width: 2;
}

.ai-input-hint {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 8px;
  padding: 0 4px;
}

/* === Download Bar === */
.editor-download-bar {
  position: absolute;
  bottom: 0;
  left: 280px;
  right: 360px;
  padding: 16px 40px;
  background: linear-gradient(
    0deg,
    rgba(0, 0, 0, 0.9) 0%,
    transparent 100%
  );
  display: flex;
  justify-content: center;
  gap: 12px;
  pointer-events: none;
}
.editor-download-bar > * { pointer-events: auto; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAPCUT-INSPIRED PREMIUM FEATURES + APPLE DESIGN PRINCIPLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Keyframe Editor Mini-Panel */
.keyframe-panel {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: 16px;
  margin-top: 12px;
}

.keyframe-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.keyframe-header h5 {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
}

.keyframe-toggle {
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background var(--duration-fast) var(--ease-out-expo);
}
.keyframe-toggle.active { background: var(--accent); }
.keyframe-toggle::after {
  content: "";
  position: absolute;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform var(--duration-fast) var(--ease-out-expo);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
.keyframe-toggle.active::after { transform: translateX(20px); }

/* Graph/Curve Editor (Apple-style minimalist) */
.curve-editor {
  height: 60px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
  position: relative;
  overflow: hidden;
  margin-top: 8px;
}

.curve-editor svg {
  width: 100%;
  height: 100%;
}

.curve-line {
  fill: none;
  stroke: var(--accent);
  stroke-width: 2;
}

.curve-point {
  fill: var(--accent);
  cursor: grab;
  filter: drop-shadow(0 0 4px var(--accent-glow));
}
.curve-point:active { cursor: grabbing; }

/* AI Magic Button (Premium Feature) */
.ai-magic-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 14px 16px;
  background: linear-gradient(135deg, rgba(48, 209, 88, 0.15), rgba(0, 212, 170, 0.15));
  border: 1px solid rgba(48, 209, 88, 0.3);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
  margin-bottom: 16px;
}

.ai-magic-btn:hover {
  background: linear-gradient(135deg, rgba(48, 209, 88, 0.25), rgba(0, 212, 170, 0.25));
  border-color: rgba(48, 209, 88, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(48, 209, 88, 0.2);
}

.ai-magic-btn .ai-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, var(--accent), #00d4aa);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ai-magic-btn .ai-icon svg {
  width: 18px;
  height: 18px;
  stroke: #000;
  fill: none;
  stroke-width: 2;
}

.ai-magic-btn .ai-text h5 {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 2px;
}
.ai-magic-btn .ai-text p {
  font-size: 11px;
  color: var(--text-muted);
}

/* Export Quality Selector (Apple-style segmented control) */
.quality-selector {
  display: flex;
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: 4px;
  gap: 4px;
}

.quality-option {
  flex: 1;
  padding: 10px 16px;
  border-radius: var(--radius-sm);
  text-align: center;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  transition: all var(--duration-fast) var(--ease-out-expo);
}

.quality-option:hover {
  color: var(--text-secondary);
}

.quality-option.active {
  background: var(--glass-bg);
  color: var(--text-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.quality-option .badge {
  display: inline-block;
  padding: 2px 6px;
  background: var(--accent);
  color: #000;
  font-size: 9px;
  font-weight: 600;
  border-radius: 4px;
  margin-left: 4px;
  text-transform: uppercase;
}

/* Platform Export Buttons (CapCut-style one-click publish) */
.export-platforms {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 16px;
}

.platform-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 14px 8px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.platform-btn:hover {
  background: var(--glass-bg-hover);
  border-color: var(--glass-border-hover);
  transform: translateY(-2px);
}

.platform-btn svg {
  width: 24px;
  height: 24px;
}
.platform-btn span {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Spotify green */
.platform-btn.spotify svg { fill: #1DB954; }
.platform-btn.spotify:hover { border-color: rgba(29, 185, 84, 0.5); }

/* TikTok gradient */
.platform-btn.tiktok svg { fill: #ff0050; }
.platform-btn.tiktok:hover { border-color: rgba(255, 0, 80, 0.5); }

/* YouTube red */
.platform-btn.youtube svg { fill: #FF0000; }
.platform-btn.youtube:hover { border-color: rgba(255, 0, 0, 0.5); }

/* Timeline Zoom Controls (Apple-style) */
.timeline-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.zoom-btn {
  width: 28px;
  height: 28px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.zoom-btn:hover {
  background: var(--glass-bg-hover);
}
.zoom-btn svg {
  width: 14px;
  height: 14px;
  stroke: var(--text-secondary);
  fill: none;
  stroke-width: 2;
}

.zoom-level {
  font-size: 11px;
  color: var(--text-muted);
  min-width: 40px;
  text-align: center;
}

/* Video Layers Panel (CapCut-inspired) */
.layers-panel {
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: 12px;
  margin-top: 16px;
}

.layer-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--glass-bg);
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  margin-bottom: 6px;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out-expo);
}
.layer-item:hover {
  border-color: var(--glass-border-hover);
}
.layer-item.active {
  background: rgba(48, 209, 88, 0.1);
  border-color: rgba(48, 209, 88, 0.3);
}

.layer-icon {
  width: 32px;
  height: 32px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
}
.layer-icon svg {
  width: 16px;
  height: 16px;
  stroke: var(--text-secondary);
  fill: none;
  stroke-width: 1.5;
}

.layer-info {
  flex: 1;
}
.layer-info h6 {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 2px;
}
.layer-info p {
  font-size: 10px;
  color: var(--text-muted);
}

.layer-actions {
  display: flex;
  gap: 4px;
}
.layer-action {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  cursor: pointer;
  transition: background var(--duration-fast);
}
.layer-action:hover {
  background: rgba(255, 255, 255, 0.1);
}
.layer-action svg {
  width: 14px;
  height: 14px;
  stroke: var(--text-muted);
  fill: none;
  stroke-width: 2;
}

/* Apple-style Info Popover */
.info-popover {
  position: absolute;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: 16px;
  box-shadow: var(--shadow-lg);
  max-width: 280px;
  z-index: 100;
  animation: popoverIn 0.2s var(--ease-out-expo);
}

@keyframes popoverIn {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(-4px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.info-popover h5 {
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 8px;
}
.info-popover p {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* Premium Pro Badge */
.pro-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  background: linear-gradient(135deg, #FFD700, #FFA500);
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
  color: #000;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.pro-badge svg {
  width: 10px;
  height: 10px;
  fill: currentColor;
}

/* === Responsive === */
@media (max-width: 1200px) {
  .editor-layout {
    grid-template-columns: 240px 1fr 320px;
  }
}

@media (max-width: 1024px) {
  .editor-layout {
    grid-template-columns: 1fr;
  }
  .editor-sidebar,
  .editor-ai-panel {
    display: none;
  }
  .editor-download-bar {
    left: 0;
    right: 0;
  }
}

/* Legacy result-view compatibility */
.result-view {
  display: none;
}

.control-group {
  margin-bottom: 24px;
}
.control-group label {
  display: block;
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.control-group h4 {
  font-size: 16px;
  margin-bottom: 16px;
}
select {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 14px;
  cursor: pointer;
}
.slider-group {
  display: flex;
  align-items: center;
  gap: 16px;
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLUID SLIDERS â€” Apple Core Foundation "Fluid sliders that make navigating feel easier"
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.slider-group input[type="range"] {
  flex: 1;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--border);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  transition: all var(--duration-fast) var(--ease-out-expo);
}

.slider-group input[type="range"]:hover {
  height: 8px;
}

.slider-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid rgba(255, 255, 255, 0.9);
  box-shadow:
    0 2px 8px rgba(0, 0, 0, 0.3),
    0 0 20px var(--accent-glow);
  transition: all var(--duration-fast) var(--ease-spring);
}

.slider-group input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.15);
  box-shadow:
    0 4px 16px rgba(0, 0, 0, 0.4),
    0 0 30px var(--accent-glow);
}

.slider-group input[type="range"]::-webkit-slider-thumb:active {
  transform: scale(1.25);
}

.slider-group input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid rgba(255, 255, 255, 0.9);
  box-shadow:
    0 2px 8px rgba(0, 0, 0, 0.3),
    0 0 20px var(--accent-glow);
  transition: all var(--duration-fast) var(--ease-spring);
}

/* Slider track fill (webkit) */
.slider-group input[type="range"]::-webkit-slider-runnable-track {
  height: 6px;
  background: linear-gradient(
    to right,
    var(--accent) 0%,
    var(--accent) var(--slider-fill, 50%),
    var(--border) var(--slider-fill, 50%),
    var(--border) 100%
  );
  border-radius: 3px;
  transition: height var(--duration-fast) var(--ease-out-expo);
}

.slider-group input[type="range"]:hover::-webkit-slider-runnable-track {
  height: 8px;
}
.slider-group span {
  font-size: 13px;
  color: var(--text-secondary);
  min-width: 60px;
  text-align: right;
}
.btn-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 24px;
}
.btn-row .btn {
  justify-content: center;
  padding: 14px 20px;
}
.download-btn {
  width: 100%;
  justify-content: center;
  margin-bottom: 32px;
}
.extend-section {
  background: var(--bg-tertiary);
  border-radius: 12px;
  padding: 24px;
  border: 1px solid var(--border);
}
.extend-section h4 { font-size: 16px; margin-bottom: 8px; }
.extend-section p { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
.extend-section .btn {
  width: 100%;
  justify-content: center;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  color: var(--text-primary);
}
.extend-section .btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--accent);
}

/* Workstation Modal */
.workstation-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg-primary);
  display: none;
  z-index: 300;
}
.workstation-overlay.active { display: block; }
.workstation {
  display: grid;
  grid-template-columns: 300px 1fr 360px;
  height: 100vh;
}
.ws-panel {
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  padding: 24px;
  overflow-y: auto;
}
.ws-panel-right {
  border-right: none;
  border-left: 1px solid var(--border);
}
.ws-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 32px;
}
.ws-header h2 { font-size: 18px; }
.ws-close {
  width: 32px;
  height: 32px;
  background: var(--bg-tertiary);
  border: none;
  border-radius: 8px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 18px;
}
.ws-section {
  margin-bottom: 32px;
}
.ws-section h3 {
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 16px;
}
.ws-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.ws-toggle span { font-size: 14px; }
.toggle-switch {
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
}
.toggle-switch.active { background: var(--accent); }
.toggle-switch::after {
  content: "";
  position: absolute;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}
.toggle-switch.active::after { transform: translateX(20px); }
.ws-slider {
  margin-bottom: 20px;
}
.ws-slider label {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  margin-bottom: 8px;
}
.ws-slider label span { color: var(--text-secondary); }
.ws-slider input[type="range"] {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  background: linear-gradient(to right, var(--accent) 50%, var(--border) 50%);
  border-radius: 3px;
}
.ws-slider input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid white;
}
.ws-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-primary);
  padding: 40px;
}
.ws-preview-frame {
  width: 300px;
  height: 533px;
  background: var(--bg-secondary);
  border-radius: 24px;
  overflow: hidden;
  position: relative;
}
.ws-preview-frame video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.ws-preview-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.ws-preview-label h4 { font-size: 14px; margin-bottom: 4px; }
.ws-preview-label p { font-size: 12px; color: var(--text-muted); }

/* AI Assistant Panel */
.ai-panel {
  display: flex;
  flex-direction: column;
}
.ai-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 16px;
}
.ai-header svg { color: var(--accent); }
.ai-header h3 { font-size: 14px; }
.ai-header span { font-size: 12px; color: var(--text-muted); margin-left: auto; }
.ai-welcome {
  background: var(--bg-tertiary);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
.ai-welcome p { font-size: 13px; line-height: 1.5; margin-bottom: 12px; }
.ai-welcome ul { list-style: none; }
.ai-welcome li {
  font-size: 12px;
  color: var(--text-secondary);
  padding: 4px 0;
}
.ai-welcome li::before {
  content: "â€¢";
  color: var(--accent);
  margin-right: 8px;
}
.ai-chat {
  flex: 1;
  overflow-y: auto;
}
.ai-input {
  margin-top: auto;
  position: relative;
}
.ai-input textarea {
  width: 100%;
  padding: 14px 50px 14px 16px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 13px;
  resize: none;
  font-family: inherit;
}
.ai-input textarea::placeholder { color: var(--text-muted); }
.ai-input button {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 36px;
  height: 36px;
  background: var(--accent);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ai-input button svg { width: 18px; height: 18px; }
.ai-input .hint {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 8px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROOF OF WORK â€” Apple TV+ Critic Reviews + Liquid Glass
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.proof-section {
  padding: 120px 40px;
  max-width: 1200px;
  margin: 0 auto;
}

.proof-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 48px;
  flex-wrap: wrap;
  gap: 24px;
}

.proof-label {
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 2.5px;
  color: var(--accent);
  text-transform: uppercase;
  margin-bottom: 16px;
}

.proof-header h2 {
  font-family: var(--font-body);
  font-size: 40px;
  font-weight: 500;
  letter-spacing: -1px;
  color: #fff;
}

.proof-header h2 .headline-italic {
  font-family: var(--font-display);
  font-style: normal;
  font-weight: 300;
  color: var(--accent);
}

.proof-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 24px;
}

/* Liquid Glass Card */
.glass-card {
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.06) 0%,
    rgba(255, 255, 255, 0.02) 100%
  );
  backdrop-filter: blur(40px) saturate(180%);
  -webkit-backdrop-filter: blur(40px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 24px;
  position: relative;
  overflow: hidden;
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1);
}

/* Specular highlight - top edge */
.glass-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 10%;
  right: 10%;
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.2) 50%,
    transparent 100%
  );
}

/* Inner glow */
.glass-card::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 24px;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
  pointer-events: none;
}

.glass-card:hover {
  transform: translateY(-8px);
  border-color: rgba(255, 255, 255, 0.12);
  box-shadow:
    0 30px 60px -15px rgba(0, 0, 0, 0.4),
    0 0 40px rgba(48, 209, 88, 0.05);
}

.proof-card {
  padding: 32px;
}

.proof-quote {
  font-size: 17px;
  line-height: 1.7;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 28px;
}

.proof-quote em {
  font-family: var(--font-display);
  font-style: italic;
  color: var(--accent);
}

.proof-author {
  display: flex;
  align-items: center;
  gap: 16px;
}

.author-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255, 255, 255, 0.1);
}

.author-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.author-name {
  font-size: 15px;
  font-weight: 600;
  color: #fff;
}

.author-cred {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
}

/* Stats Card */
.stats-card {
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 24px;
}

.stat-row {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  letter-spacing: -1px;
  color: var(--accent);
}

.stat-desc {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.5);
}
}

/* Footer */
.site-footer {
  padding: 60px 40px 40px;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
  margin-top: 80px;
}
.footer-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 24px;
}
.footer-brand {
  font-size: 18px;
  font-weight: 600;
}
.footer-brand span { color: var(--accent); }
.footer-links {
  display: flex;
  gap: 32px;
}
.footer-links a {
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 14px;
  transition: color 0.2s;
}
.footer-links a:hover { color: var(--text-primary); }
.footer-copy {
  color: var(--text-muted);
  font-size: 13px;
  width: 100%;
  text-align: center;
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .hero {
    flex-direction: column;
    text-align: center;
    gap: 48px;
  }
  .hero-content { max-width: 100%; }
  .hero h1 { font-size: 44px; }
  .hero-tagline { max-width: 100%; }
  .hero-buttons { justify-content: center; }
  .hero-guarantee { justify-content: center; }
  .proof-grid { grid-template-columns: 1fr; }
  .proof-header { flex-direction: column; align-items: flex-start; }
  .mood-grid { grid-template-columns: repeat(2, 1fr); }
  .result-grid { grid-template-columns: 1fr; gap: 40px; }
  .workstation { grid-template-columns: 1fr; }
  .ws-panel { display: none; }
  .ws-preview { padding: 20px; }
}
@media (max-width: 768px) {
  .header { padding: 0 20px; }
  .nav { display: none; }
  .hero { padding: 100px 20px 60px; flex-direction: column; }
  /* Phone moves into hero-content flow on mobile (via JS) */
  .phone-preview.mobile-inline { margin: 16px auto 24px; }
  .hero-phone-slot { display: block; }
  .hero h1 { font-size: 36px; letter-spacing: -1px; }
  .hero-tagline { font-size: 16px; }
  .hero-buttons { flex-direction: column; width: 100%; }
  .hero-buttons .btn { width: 100%; justify-content: center; }
  .phone-frame { width: 280px; height: 560px; }
  .proof-section { padding: 80px 20px; }
  .proof-header h2 { font-size: 28px; }
  .score-number { font-size: 36px; }
  .proof-card { padding: 24px; }
  .proof-quote { font-size: 15px; }
  .stat-value { font-size: 24px; }
  .section { padding: 60px 20px; }
  .section h2 { font-size: 28px; }
  .mood-grid { grid-template-columns: 1fr; }
  .mood-visual { height: 300px; }
  .modal { padding: 24px; margin: 16px; }
  .footer-content { flex-direction: column; text-align: center; }
  .footer-links { flex-wrap: wrap; justify-content: center; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GPU FAIL GATE â€” Blocks entire site if GPU server isn't live
     Checks /api/health every 10s. No GPU = no LoopCanvas. Period.
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="gpu-fail-gate" style="
  display: none;
  position: fixed;
  inset: 0;
  z-index: 999999;
  background: #000;
  color: #fff;
  font-family: 'Inter', -apple-system, sans-serif;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 40px;
">
  <div style="max-width: 500px;">
    <div id="gpu-fail-icon" style="font-size: 64px; margin-bottom: 24px;">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/>
        <rect x="9" y="9" width="6" height="6"/>
        <line x1="9" y1="1" x2="9" y2="4"/>
        <line x1="15" y1="1" x2="15" y2="4"/>
        <line x1="9" y1="20" x2="9" y2="23"/>
        <line x1="15" y1="20" x2="15" y2="23"/>
        <line x1="20" y1="9" x2="23" y2="9"/>
        <line x1="20" y1="14" x2="23" y2="14"/>
        <line x1="1" y1="9" x2="4" y2="9"/>
        <line x1="1" y1="14" x2="4" y2="14"/>
      </svg>
    </div>
    <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.5px;">
      GPU Server Offline
    </h2>
    <p style="font-size: 16px; color: rgba(255,255,255,0.6); line-height: 1.6; margin-bottom: 24px;">
      LoopCanvas requires a live GPU server to generate canvases. The server is currently unreachable. This page will automatically unlock when the GPU comes back online.
    </p>
    <div id="gpu-fail-status" style="
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 68, 68, 0.15);
      border: 1px solid rgba(255, 68, 68, 0.3);
      border-radius: 100px;
      font-size: 13px;
      color: #ff6666;
      font-weight: 500;
    ">
      <span id="gpu-fail-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #ff4444; animation: gpuPulse 1.5s ease-in-out infinite;"></span>
      <span id="gpu-fail-msg">Checking GPU server...</span>
    </div>
    <p id="gpu-fail-error" style="font-size: 12px; color: rgba(255,255,255,0.3); margin-top: 16px; font-family: monospace;"></p>
  </div>
</div>

<style>
  @keyframes gpuPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  #gpu-fail-gate.gpu-recovering #gpu-fail-dot {
    background: #ffa500;
  }
  #gpu-fail-gate.gpu-recovering #gpu-fail-status {
    background: rgba(255, 165, 0, 0.15);
    border-color: rgba(255, 165, 0, 0.3);
    color: #ffa500;
  }
</style>

<script>
// GPU Fail Gate â€” checks health every 10 seconds
// If GPU is dead, the entire page is blocked. No exceptions.
(function() {
  const gate = document.getElementById('gpu-fail-gate');
  const msgEl = document.getElementById('gpu-fail-msg');
  const errEl = document.getElementById('gpu-fail-error');
  let gpuLive = false;
  let consecutiveFails = 0;
  let checkInterval = null;

  async function checkGPU() {
    try {
      const resp = await fetch('/api/health', {
        cache: 'no-store',
        signal: AbortSignal.timeout(8000)
      });
      const data = await resp.json();

      if (resp.ok && data.gpu === 'live') {
        // GPU is alive
        if (!gpuLive) {
          console.log('[GPU Gate] GPU server is LIVE');
          gpuLive = true;
          consecutiveFails = 0;
          gate.style.display = 'none';
          document.body.style.overflow = '';
          // Enable all upload/generate buttons
          document.querySelectorAll('[data-gpu-required]').forEach(el => {
            el.disabled = false;
            el.style.pointerEvents = '';
            el.style.opacity = '';
          });
        }
        return;
      }

      // GPU is dead
      handleGPUDown(data.error || 'GPU server returned non-live status');
    } catch (e) {
      handleGPUDown(e.message || 'Failed to reach health endpoint');
    }
  }

  function handleGPUDown(error) {
    consecutiveFails++;
    gpuLive = false;

    // Show the fail gate
    gate.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Disable all upload/generate buttons
    document.querySelectorAll('[data-gpu-required]').forEach(el => {
      el.disabled = true;
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.3';
    });

    // Update status message
    if (consecutiveFails >= 3) {
      msgEl.textContent = `GPU offline â€” retrying every 10s (${consecutiveFails} checks failed)`;
    } else {
      msgEl.textContent = 'Connecting to GPU server...';
    }
    errEl.textContent = error;

    console.warn(`[GPU Gate] GPU DOWN (fail #${consecutiveFails}): ${error}`);
  }

  // Initial check immediately
  checkGPU();

  // Re-check every 10 seconds
  checkInterval = setInterval(checkGPU, 10000);

  // Also check on visibility change (when user switches back to tab)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      checkGPU();
    }
  });

  // Expose for debugging
  window.__gpuGate = { checkGPU, isLive: () => gpuLive };
})();
</script>

<!-- Header -->
<header class="header">
  <div class="logo">Loop<span>Canvas</span></div>
  <nav class="nav">
    <a href="#moods">Styles</a>
    <a href="docs/">Docs</a>
  </nav>
</header>

<!-- Hero Section -->
<section class="hero" id="hero">
  <div class="hero-content">
    <!-- Credibility badge -->
    <div class="hero-credibility">
      <span class="credibility-badge">BUILT FOR ARTISTS & PRODUCERS</span>
    </div>

    <!-- Main headline -->
    <h1>Turn a 7-second canvas into a full-length, custom music video.</h1>

    <!-- Subhead -->
    <p class="hero-tagline">Upload your track, get an AI-built Spotify-style canvas in seconds â€” then expand it into a full music video that matches your mood, your sound, and your world.</p>

    <!-- Phone inserted here on mobile via JS â€” below the promise, as proof -->
    <div class="hero-phone-slot" id="hero-phone-slot"></div>

    <!-- Feature bullets -->
    <ul class="hero-features">
      <li><span class="bullet">â—</span> Auto-generated Spotify-style canvases</li>
      <li><span class="bullet">â—</span> One-click full-length music videos</li>
      <li><span class="bullet">â—</span> Royalty-free clips, GIFs, and effects matched to your track</li>
    </ul>

    <!-- Single CTA -->
    <div class="hero-buttons">
      <button class="btn btn-hero-cta" onclick="openUploadModal()" data-gpu-required>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <span>Upload your track</span>
      </button>
    </div>

    <!-- Social proof -->
    <div class="hero-stats">
      <span class="stars">â˜…â˜…â˜…â˜…â˜…</span>
      <span><strong>4.9</strong> Â· 2,000+ 5-star reviews</span>
      <span class="divider">|</span>
      <span>Canvases and full music videos delivered in minutes, not days.</span>
    </div>
  </div>
  <div class="phone-preview">
    <div class="phone-frame">
      <div class="phone-notch"></div>
      <div class="phone-screen">
        <video id="hero-video" autoplay loop muted playsinline style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1;"></video>
        <!-- Spotify Now Playing UI Overlay â€” Real Spotify Design -->
        <div class="spotify-overlay" style="position:absolute !important;bottom:0 !important;left:0 !important;right:0 !important;z-index:999 !important;background:linear-gradient(to top,rgba(0,0,0,0.95) 0%,rgba(0,0,0,0.8) 50%,transparent 100%) !important;padding:16px 20px 28px !important;color:#fff !important;">
          <div class="spotify-now-playing">
            <!-- Track info row with album art -->
            <div class="spotify-track-info">
              <div class="spotify-album-art">
                <video id="album-art-video" autoplay loop muted playsinline></video>
              </div>
              <div class="spotify-track-text">
                <p class="track-name" id="hero-track-name">out again</p>
                <p class="artist-name" id="hero-artist-name">It's Murph</p>
              </div>
              <svg class="spotify-heart" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
            <div class="spotify-progress">
              <span class="spotify-time">1:24</span>
              <div class="spotify-progress-bar">
                <div class="spotify-progress-fill"></div>
              </div>
              <span class="spotify-time">3:47</span>
            </div>
            <div class="spotify-controls">
              <button class="spotify-control-btn" aria-label="Shuffle">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
              </button>
              <button class="spotify-control-btn" aria-label="Previous">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
              </button>
              <button class="spotify-control-btn play-btn" id="spotify-play-btn" aria-label="Play">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
              </button>
              <button class="spotify-control-btn" aria-label="Next">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
              </button>
              <button class="spotify-control-btn" aria-label="Repeat">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="loop-badge" id="demo-duration">7s loop</div>
    </div>
  </div>
</section>

<!-- Proof of Work â€” Apple TV+ Critic Reviews Style -->
<section class="proof-section" id="proof">
  <div class="proof-header">
    <div class="proof-label">THE STUDIO</div>
    <h2><span class="headline-italic">Words from</span> the community</h2>
  </div>

  <div class="proof-grid">
    <!-- Editorial Review Cards â€” Soho House warm glass -->
    <div class="proof-card glass-card">
      <div class="proof-quote">"I uploaded a rough demo at 2am. By 2:01am I had a canvas that captured exactly what I was feeling when I made the track. <em>This is witchcraft.</em>"</div>
      <div class="proof-author">
        <img src="https://i.pravatar.cc/56?img=32" alt="" class="author-avatar">
        <div class="author-info">
          <span class="author-name">Laila K.</span>
          <span class="author-cred">Afro-house Â· 2.4M streams</span>
        </div>
      </div>
    </div>

    <div class="proof-card glass-card">
      <div class="proof-quote">"I've paid $3,000 for music videos that didn't capture the vibe as well as this did in 30 seconds. <em>My whole release strategy changed.</em>"</div>
      <div class="proof-author">
        <img src="https://i.pravatar.cc/56?img=15" alt="" class="author-avatar">
        <div class="author-info">
          <span class="author-name">J. Santos</span>
          <span class="author-cred">Melodic techno Â· Beatport Top 100</span>
        </div>
      </div>
    </div>

    <div class="proof-card glass-card">
      <div class="proof-quote">"Same canvas across Spotify, TikTok, IG Reels. Streams up 340% in the first week. <em>The algorithm loves consistent visual identity.</em>"</div>
      <div class="proof-author">
        <img src="https://i.pravatar.cc/56?img=22" alt="" class="author-avatar">
        <div class="author-info">
          <span class="author-name">Rafi</span>
          <span class="author-cred">Electronic Â· 50K monthly listeners</span>
        </div>
      </div>
    </div>

    <!-- Stats Card â€” Brass accents -->
    <div class="proof-card stats-card glass-card">
      <div class="stat-row">
        <span class="stat-value">847K</span>
        <span class="stat-desc">canvases this month</span>
      </div>
      <div class="stat-row">
        <span class="stat-value">2.1B</span>
        <span class="stat-desc">collective streams</span>
      </div>
      <div class="stat-row">
        <span class="stat-value">94%</span>
        <span class="stat-desc">export on first session</span>
      </div>
    </div>
  </div>
</section>


<!-- Mood Library Section â€” Soho House Curation -->
<section class="section" id="moods">
  <div class="section-label">THE COLLECTION</div>
  <h2><span class="headline-italic">Cinematic styles</span> for every mood</h2>
  <p>Each style is inspired by legendary cinematographers â€” from Lubezki's golden hour to Wong Kar-wai's neon noir. Your track deserves a visual director.</p>
  <div class="mood-grid" id="mood-grid">
    <!-- Populated dynamically by renderMoodLibrary() â€” 12 cards in 3 rows of 4 -->
  </div>
</section>

<!-- Upload Modal -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UPLOAD MODAL â€” Simple file drop
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="upload-modal">
  <div class="modal">
    <div id="upload-state">
      <h2>Upload your track</h2>
      <p>Drop your audio file and we'll analyze it to create your canvas.</p>
      <div class="upload-zone" onclick="document.getElementById('file-input').click()" data-gpu-required>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        <h4>Click to upload or drag and drop</h4>
        <p>WAV, MP3, FLAC, AIF, M4A up to 50MB</p>
        <input type="file" id="file-input" accept="audio/*,.wav,.mp3,.flac,.aif,.aiff,.m4a,.ogg" onchange="handleFileUpload(this)">
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CANVAS ENGINE â€” Full-Screen Processing View
     The $50K director-grade experience. Upload â†’ Feel â†’ Direct â†’ Generate â†’ Validate.
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- â•â•â• CANVAS ENGINE v3 â€” Video-first, minimal chrome â•â•â• -->
<div class="canvas-engine" id="canvas-engine" style="display:none;">
  <div class="ce-layout">

    <!-- â”€â”€ FULL-BLEED VIDEO â”€â”€ -->
    <div class="ce-video-wrap">
      <video id="ce-preview-video" autoplay loop muted playsinline></video>
      <div class="ce-video-placeholder" id="ce-video-placeholder">
        <div class="ce-video-pulse"></div>
        <div class="ce-loading-text" id="ce-loading-text">Listening to your track...</div>
      </div>

      <!-- Floating overlays on the video -->
      <div class="ce-overlay-top">
        <button class="ce-back-btn" onclick="ceClose()" aria-label="Back">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><path d="M15 10H5M9 6l-4 4 4 4"/></svg>
        </button>
        <div class="ce-status-pill" id="ce-status-pill">
          <div class="ce-status-dot"></div>
          <span id="ce-status-text">LISTENING</span>
        </div>
        <div class="ce-quality-score" id="ce-quality-score" style="opacity:0;">
          <span id="ce-score-number">9.4</span>
        </div>
      </div>

      <div class="ce-overlay-bottom">
        <div class="ce-track-info" id="ce-track-info">
          <div class="ce-track-name" id="ce-track-name">Your Track</div>
          <div class="ce-track-meta" id="ce-track-meta"></div>
        </div>
        <div class="ce-timeline">
          <div class="ce-timeline-bar"><div class="ce-timeline-fill" id="ce-timeline-fill"></div></div>
        </div>
      </div>

      <!-- Director picker (floating over video during Direct stage) -->
      <div class="ce-directors-overlay" id="ce-directors-overlay" style="display:none;">
        <div class="ce-directors-title">Choose your director</div>
        <div class="ce-directions-list" id="ce-directions-list"></div>
      </div>

      <!-- Iteration feedback overlay -->
      <div class="ce-iterate-feedback" id="ce-iterate-feedback">
        <div class="ce-iterate-label" id="ce-iterate-label">Applying changes...</div>
      </div>

      <!-- Progress overlay during generation -->
      <div class="ce-gen-overlay" id="ce-gen-overlay" style="display:none;">
        <div class="ce-gen-headline"><span>Creating your canvas</span></div>
        <div class="ce-gen-label" id="ce-gen-label">Crafting a visual world unique to your track.</div>
        <div class="ce-gen-sublabel" id="ce-gen-sublabel" style="font-size:12px;color:rgba(255,255,255,0.25);margin-top:0;min-height:16px;letter-spacing:0.01em;"></div>
        <div class="ce-gen-steps" id="ce-gen-steps">
          <div class="ce-gen-step" id="ce-gstep-analyze"><div class="ce-gen-step-icon"></div>Analyzing audio</div>
          <div class="ce-gen-step" id="ce-gstep-concept"><div class="ce-gen-step-icon"></div>Building visual concept</div>
          <div class="ce-gen-step" id="ce-gstep-scenes"><div class="ce-gen-step-icon"></div>Generating scenes</div>
          <div class="ce-gen-step" id="ce-gstep-render"><div class="ce-gen-step-icon"></div>Rendering loop</div>
          <div class="ce-gen-step" id="ce-gstep-quality"><div class="ce-gen-step-icon"></div>Validating quality</div>
        </div>
        <div class="ce-progress-bar"><div class="ce-progress-fill" id="ce-generate-fill"></div></div>
        <div class="ce-gen-eta" id="ce-gen-eta">About <strong>1 minute</strong> remaining</div>
      </div>
    </div>

    <!-- â”€â”€ BOTTOM DRAWER: Creative tools (hidden until canvas is ready) â”€â”€ -->
    <div class="ce-drawer" id="ce-drawer" style="display:none;">

      <!-- Intent input â€” the main creative tool -->
      <div class="ce-intent-bar">
        <input type="text" class="ce-intent-input" id="ce-intent-input"
          placeholder="&quot;make it feel like 3am in Tokyo&quot;"
          onkeydown="if(event.key==='Enter')ceSubmitIntent()">
        <button class="ce-intent-send" onclick="ceSubmitIntent()" aria-label="Send">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M5 10h10M11 6l4 4-4 4"/></svg>
        </button>
      </div>

      <!-- Quick suggestion chips -->
      <div class="ce-chips" id="ce-intent-suggestions">
        <button class="ce-chip" onclick="ceUseSuggestion(this)">warmer</button>
        <button class="ce-chip" onclick="ceUseSuggestion(this)">darker</button>
        <button class="ce-chip" onclick="ceUseSuggestion(this)">more motion</button>
        <button class="ce-chip" onclick="ceUseSuggestion(this)">film grain</button>
        <button class="ce-chip" onclick="ceUseSuggestion(this)">dreamy</button>
      </div>

      <!-- Action buttons -->
      <div class="ce-actions">
        <button class="ce-action" onclick="ceExport('spotify')">
          <svg viewBox="0 0 24 24" fill="#1DB954" style="width:18px;height:18px;"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
          Export Canvas
        </button>
        <button class="ce-action" onclick="expandToMusicVideo()">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" style="width:18px;height:18px;"><rect x="3" y="5" width="14" height="10" rx="2"/><polygon points="8,8 13,10 8,12"/></svg>
          Extend to Video
        </button>
        <button class="ce-action ce-action-more" onclick="ceShowExportAll()">
          <svg viewBox="0 0 20 20" fill="currentColor" style="width:18px;height:18px;"><circle cx="4" cy="10" r="2"/><circle cx="10" cy="10" r="2"/><circle cx="16" cy="10" r="2"/></svg>
          More
        </button>
      </div>
    </div>

  </div>

  <!-- Hidden elements for JS compatibility -->
  <div style="display:none;">
    <span id="ce-upload-detail"></span>
    <span id="ce-feel-detail"></span>
    <span id="ce-direct-detail"></span>
    <span id="ce-generate-detail"></span>
    <span id="ce-validate-detail"></span>
    <span id="ce-dna-bar"></span>
    <span id="ce-director-card"></span>
    <span id="ce-director-tags"></span>
    <span id="ce-director-name"></span>
    <span id="ce-director-match"></span>
    <span id="ce-generate-progress"></span>
    <span id="ce-expand-mv"></span>
    <span id="ce-tags"></span>
    <span id="ce-philosophy"></span>
    <span id="ce-pill-director"></span>
    <span id="ce-workspace"></span>
    <span id="ce-spotify-video"></span>
    <span id="ce-spotify-track"></span>
    <span id="ce-spotify-artist"></span>
    <span id="ce-sp-progress-fill"></span>
    <span id="ce-sp-time"></span>
    <span id="ce-observed-badge"></span>
    <span id="ce-time-current"></span>
    <span id="ce-time-total"></span>
    <span id="ce-tech-pills"></span>
    <span id="ce-regenerate-btn"></span>
    <video id="ce-spotify-video-compat"></video>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EDITOR WORKSPACE â€” CapCut-Style Full-Screen Editor
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="editor-workspace" id="editor-workspace">

  <!-- Editor Header -->
  <div class="editor-header">
    <div class="editor-back" onclick="closeEditor()">
      <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      <span>Back</span>
    </div>
    <div class="editor-title" id="editor-track-name">Track Name</div>
    <div class="editor-actions">
      <button class="btn btn-secondary" onclick="regenerateCanvas()" style="padding: 10px 16px; font-size: 13px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>
        </svg>
        Regenerate
      </button>
      <button class="btn btn-primary" onclick="downloadCanvas()" style="padding: 10px 20px; font-size: 13px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Export
      </button>
    </div>
  </div>

  <div class="editor-layout">

    <!-- === LEFT SIDEBAR â€” Mode Tabs & Controls === -->
    <div class="editor-sidebar">
      <div class="editor-mode-tabs">
        <div class="mode-tab active" data-mode="canvas">Canvas</div>
        <div class="mode-tab" data-mode="video">Full Video</div>
        <div class="mode-tab" data-mode="settings">Settings</div>
      </div>

      <div class="editor-controls">
        <!-- Quick Actions -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Quick Actions</h4>
          </div>
          <div class="quick-actions">
            <div class="quick-action" data-effect="grain">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><circle cx="19" cy="5" r="1"/><circle cx="5" cy="19" r="1"/><circle cx="19" cy="19" r="1"/><circle cx="5" cy="5" r="1"/></svg>
              <span>Grain</span>
            </div>
            <div class="quick-action active" data-effect="glow">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
              <span>Glow</span>
            </div>
            <div class="quick-action" data-effect="shake">
              <svg viewBox="0 0 24 24"><path d="M2 12h2M20 12h2M6.34 6.34l1.42 1.42M16.24 16.24l1.42 1.42M6.34 17.66l1.42-1.42M16.24 7.76l1.42-1.42M12 6V4M12 20v-2"/></svg>
              <span>Shake</span>
            </div>
            <div class="quick-action" data-effect="vignette">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/></svg>
              <span>Vignette</span>
            </div>
          </div>
        </div>

        <!-- Mood Selection -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Visual Mood</h4>
            <span class="reset-btn" onclick="resetMood()">Reset</span>
          </div>
          <select id="mood-select" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 13px;">
            <option value="memory_in_motion">Memory in Motion (Signature)</option>
            <option value="afterglow_ritual">Afterglow Ritual</option>
            <option value="midnight_city">Midnight City Pulse</option>
            <option value="analog_memory">Analog Memory</option>
            <option value="sunrise_departure">Sunrise Departure</option>
            <option value="desert_drive">Desert Drive</option>
            <option value="velvet_dark">Velvet Dark</option>
            <option value="ghost_room">Ghost Room</option>
            <option value="euphoric_drift">Euphoric Drift</option>
            <option value="concrete_heat">Concrete Heat</option>
            <option value="neon_calm">Neon Calm</option>
            <option value="peak_transmission">Peak Transmission</option>
          </select>
        </div>

        <!-- Color Adjustments -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Color</h4>
          </div>
          <div class="editor-slider">
            <label>Warmth <span id="warmth-val">50</span></label>
            <input type="range" min="0" max="100" value="50" id="warmth-slider">
          </div>
          <div class="editor-slider">
            <label>Saturation <span id="sat-val">60</span></label>
            <input type="range" min="0" max="100" value="60" id="saturation-slider">
          </div>
          <div class="editor-slider">
            <label>Contrast <span id="contrast-val">50</span></label>
            <input type="range" min="0" max="100" value="50" id="contrast-slider">
          </div>

          <div class="control-section-header" style="margin-top: 16px;">
            <h4>Presets</h4>
          </div>
          <div class="color-presets">
            <div class="color-preset active" style="background: linear-gradient(135deg, #D2A05A, #B4828C);" title="Golden Hour"></div>
            <div class="color-preset" style="background: linear-gradient(135deg, #667eea, #3b4371);" title="Night"></div>
            <div class="color-preset" style="background: linear-gradient(135deg, #f093fb, #f5576c);" title="Warm Pink"></div>
            <div class="color-preset" style="background: linear-gradient(135deg, #96A0B4, #B4B4AA);" title="Cool Grey"></div>
            <div class="color-preset" style="background: linear-gradient(135deg, #64B4FF, #FF78C8);" title="Neon"></div>
            <div class="color-preset" style="background: linear-gradient(135deg, #FF6450, #FFC864);" title="Energy"></div>
          </div>
        </div>

        <!-- Texture -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Texture</h4>
          </div>
          <div class="editor-slider">
            <label>Film Grain <span id="grain-val">40</span></label>
            <input type="range" min="0" max="100" value="40" id="grain-slider">
          </div>
          <div class="editor-slider">
            <label>Softness <span id="soft-val">50</span></label>
            <input type="range" min="0" max="100" value="50" id="softness-slider">
          </div>
        </div>

        <!-- Motion -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Motion</h4>
          </div>
          <div class="editor-slider">
            <label>Speed <span id="speed-val">30</span></label>
            <input type="range" min="0" max="100" value="30" id="speed-slider">
          </div>
        </div>

        <!-- AI Magic Button -->
        <div class="control-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
          <div class="ai-magic-btn" onclick="showAIMagic()">
            <div class="ai-icon">
              <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            </div>
            <div class="ai-text">
              <h5>AI Auto-Enhance</h5>
              <p>One-click professional polish</p>
            </div>
          </div>
        </div>

        <!-- Extend to Full Video -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Extend</h4>
          </div>
          <button class="btn btn-secondary" onclick="generateFullVideo()" style="width: 100%; justify-content: center;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/>
            </svg>
            Full Music Video
          </button>
        </div>

        <!-- Export Quality -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Export Quality</h4>
          </div>
          <div class="quality-selector">
            <div class="quality-option" data-quality="720">720p</div>
            <div class="quality-option active" data-quality="1080">1080p</div>
            <div class="quality-option" data-quality="4k">4K <span class="badge">Pro</span></div>
          </div>
        </div>

        <!-- One-Click Publish -->
        <div class="control-section">
          <div class="control-section-header">
            <h4>Publish To</h4>
          </div>
          <div class="export-platforms">
            <div class="platform-btn spotify" onclick="exportTo('spotify')">
              <svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
              <span>Spotify</span>
            </div>
            <div class="platform-btn tiktok" onclick="exportTo('tiktok')">
              <svg viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
              <span>TikTok</span>
            </div>
            <div class="platform-btn youtube" onclick="exportTo('youtube')">
              <svg viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
              <span>YouTube</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- === CENTER â€” Video Preview === -->
    <div class="editor-preview">
      <div class="preview-container">
        <div class="preview-frame">
          <video id="canvas-video" autoplay loop muted playsinline></video>
          <div class="preview-badge">7s loop</div>
        </div>
        <div class="playback-controls">
          <button class="playback-btn" onclick="seekBackward()">
            <svg viewBox="0 0 24 24"><polygon points="11 19 2 12 11 5 11 19"/><polygon points="22 19 13 12 22 5 22 19"/></svg>
          </button>
          <button class="playback-btn primary" id="play-pause-btn" onclick="togglePlayPause()">
            <svg class="play-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            <svg class="pause-icon" viewBox="0 0 24 24" style="display:none;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
          </button>
          <button class="playback-btn" onclick="seekForward()">
            <svg viewBox="0 0 24 24"><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></svg>
          </button>
          <button class="playback-btn" onclick="toggleMute()" id="mute-btn">
            <svg class="sound-on" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
            <svg class="sound-off" viewBox="0 0 24 24" style="display:none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
          </button>
          <span class="time-display"><span id="current-time">0:00</span> / <span id="total-time">0:07</span></span>
        </div>
      </div>

      <!-- Timeline Scrubber -->
      <div class="timeline-scrubber">
        <div class="timeline-track" id="timeline-track">
          <div class="timeline-waveform"></div>
          <div class="timeline-playhead" id="timeline-playhead"></div>
        </div>
        <div class="timeline-markers">
          <span>0:00</span>
          <span>0:01</span>
          <span>0:02</span>
          <span>0:03</span>
          <span>0:04</span>
          <span>0:05</span>
          <span>0:06</span>
          <span>0:07</span>
        </div>
      </div>
    </div>

    <!-- === RIGHT PANEL â€” AI Assistant === -->
    <div class="editor-ai-panel">
      <div class="ai-panel-header">
        <div class="ai-avatar">
          <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        </div>
        <div>
          <h3>AI Visual Editor</h3>
          <p>Describe changes in natural language</p>
        </div>
      </div>

      <!-- AI Suggestions -->
      <div class="ai-suggestions">
        <div class="ai-suggestion" onclick="applySuggestion('Make it warmer with more golden tones')">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/></svg>
          <span>Add golden warmth</span>
        </div>
        <div class="ai-suggestion" onclick="applySuggestion('Increase film grain for a more analog feel')">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><circle cx="19" cy="5" r="1"/></svg>
          <span>More film grain</span>
        </div>
        <div class="ai-suggestion" onclick="applySuggestion('Slow down the motion and add soft glow')">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <span>Slow & dreamy</span>
        </div>
        <div class="ai-suggestion" onclick="applySuggestion('Make it darker and more mysterious')">
          <svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <span>Dark & moody</span>
        </div>
      </div>

      <!-- AI Chat -->
      <div class="ai-chat-container">
        <div class="ai-chat-messages" id="ai-chat-messages">
          <div class="ai-message assistant">
            <div class="ai-message-content">
              Hi! I can help you refine your Canvas. Try describing what you want:
              <br><br>
              â€¢ "Make this more nostalgic with film grain"<br>
              â€¢ "Add camera shake on the drops"<br>
              â€¢ "Warmer tones, less motion"<br>
              â€¢ "Dark and moody with purple tones"
            </div>
            <div class="ai-message-time">AI â€¢ just now</div>
          </div>
        </div>

        <div class="ai-chat-input">
          <div class="ai-input-wrapper">
            <textarea id="ai-editor-input" rows="1" placeholder="Describe what you want to change..."></textarea>
            <button class="ai-send-btn" onclick="sendEditorAIMessage()">
              <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
          <div class="ai-input-hint">Press Enter to send â€¢ Shift+Enter for new line</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Legacy result-view for compatibility -->
<section class="result-view" id="result-view" style="display:none;"></section>

<!-- Workstation Modal -->
<div class="workstation-overlay" id="workstation">
  <div class="workstation">
    <!-- Left Panel: Controls -->
    <div class="ws-panel">
      <div class="ws-header">
        <h2>Workstation</h2>
        <button class="ws-close" onclick="closeWorkstation()">Ã—</button>
      </div>
      <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 24px;">Editing: 7s Canvas</p>

      <div class="ws-section">
        <h3>Template & Mood</h3>
        <select id="ws-mood-select">
          <option value="euphoric">Euphoric</option>
          <option value="dark">Dark</option>
          <option value="nostalgic">Nostalgic</option>
          <option value="longing">Longing</option>
          <option value="haunting">Haunting</option>
        </select>
        <button class="btn btn-secondary" style="width: 100%; margin-top: 12px; justify-content: center;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
          </svg>
          Reset to Autopilot
        </button>
      </div>

      <div class="ws-section">
        <h3>Effects</h3>
        <div class="ws-toggle">
          <span>Shake</span>
          <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
        </div>
        <div class="ws-toggle">
          <span>Retro</span>
          <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
        </div>
        <div class="ws-toggle">
          <span>Distortion</span>
          <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
        </div>
        <div class="ws-toggle">
          <span>Glitch</span>
          <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
        </div>
        <div class="ws-toggle">
          <span>Light</span>
          <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
        </div>
      </div>

      <div class="ws-section">
        <h3>Filters & Color</h3>
        <select style="margin-bottom: 16px;">
          <option>None</option>
          <option>Warm</option>
          <option>Cool</option>
          <option>Vintage</option>
          <option>High Contrast</option>
        </select>
        <button class="btn btn-secondary" style="width: 100%; justify-content: center; margin-bottom: 20px;">
          Auto color correct
        </button>
        <div class="ws-slider">
          <label>Exposure <span>50</span></label>
          <input type="range" min="0" max="100" value="50">
        </div>
        <div class="ws-slider">
          <label>Contrast <span>50</span></label>
          <input type="range" min="0" max="100" value="50">
        </div>
        <div class="ws-slider">
          <label>Temperature <span>50</span></label>
          <input type="range" min="0" max="100" value="50">
        </div>
        <div class="ws-slider">
          <label>Saturation <span>50</span></label>
          <input type="range" min="0" max="100" value="50">
        </div>
      </div>

      <div class="ws-section">
        <h3>Motion & Transitions</h3>
        <div class="ws-slider">
          <label>Motion Intensity <span>Medium</span></label>
          <input type="range" min="0" max="100" value="50">
        </div>
      </div>
    </div>

    <!-- Center: Preview -->
    <div class="ws-preview">
      <div class="ws-preview-frame">
        <video id="ws-video" autoplay loop muted playsinline></video>
        <div class="ws-preview-label">
          <h4>Preview</h4>
          <p id="ws-track-name">we shine (fade) (1).wav</p>
        </div>
      </div>
    </div>

    <!-- Right Panel: AI Assistant -->
    <div class="ws-panel ws-panel-right ai-panel">
      <div class="ai-header">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <h3>AI Visual Assistant</h3>
        <span>Lovable AI</span>
      </div>
      <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
        Describe visual changes in natural language
      </p>
      <div class="ai-welcome">
        <p>Hi! I can help you refine your Canvas with natural language. Try:</p>
        <ul>
          <li>'Make this more nostalgic with film grain'</li>
          <li>'Add camera shake on the drops, keep it warm'</li>
          <li>'Less glitch, more light leaks'</li>
          <li>'Intro slow and minimal, drop very intense'</li>
          <li>'Dark and moody with purple tones'</li>
        </ul>
      </div>
      <div class="ai-chat" id="ai-chat"></div>
      <div class="ai-input">
        <textarea id="ai-input" rows="2" placeholder="e.g., 'warmer tones with more grain' or 'less motion, darker mood'"></textarea>
        <button onclick="sendAIMessage()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
        <p class="hint">Press Enter to send, Shift+Enter for new line</p>
      </div>
    </div>
  </div>
</div>

<script>
// Live activity counter â€” Game Theory: Social Proof + FOMO
(function initLiveCounter() {
  const counter = document.getElementById('live-count');
  if (!counter) return;

  // Start with realistic number
  let count = 32 + Math.floor(Math.random() * 30);
  counter.textContent = count;

  // Subtle fluctuation every 3-8 seconds
  setInterval(() => {
    const delta = Math.random() > 0.5 ? 1 : -1;
    count = Math.max(20, Math.min(80, count + delta));
    counter.textContent = count;
  }, 3000 + Math.random() * 5000);
})();

// State
let currentFile = null;
let currentMood = 'euphoric';
let currentJobId = null;
let currentOutputDir = null;
let currentQualityScore = null;
let currentEmotionalDna = null;

// Modal controls
function openUploadModal() {
  // GPU FAIL CHECK â€” Don't even open the modal if GPU is dead
  if (window.__gpuGate && !window.__gpuGate.isLive()) {
    // Force the fail gate to show
    const gate = document.getElementById('gpu-fail-gate');
    if (gate) { gate.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    return;
  }
  hideCanvasEngine();
  document.getElementById('upload-modal').classList.add('active');
  document.getElementById('upload-state').style.display = 'block';
}

function closeUploadModal() {
  document.getElementById('upload-modal').classList.remove('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS ENGINE â€” Pipeline Controller
// The 5-stage experience: Upload â†’ Feel â†’ Direct â†’ Generate â†’ Validate
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showCanvasEngine() {
  document.getElementById('upload-modal').classList.remove('active');
  const ce = document.getElementById('canvas-engine');
  ce.style.display = 'block';
  ce.classList.add('active');
}

function hideCanvasEngine() {
  const ce = document.getElementById('canvas-engine');
  ce.style.display = 'none';
  ce.classList.remove('active');
  // Reset state
  document.getElementById('ce-directors-overlay').style.display = 'none';
  document.getElementById('ce-gen-overlay').style.display = 'none';
  document.getElementById('ce-drawer').style.display = 'none';
  document.getElementById('ce-video-placeholder').style.display = 'flex';
  document.getElementById('ce-quality-score').style.opacity = '0';
}

function ceClose() {
  hideCanvasEngine();
  // Show landing page
  document.getElementById('hero').style.display = '';
  document.getElementById('moods').style.display = '';
  document.getElementById('proof').style.display = '';
  document.getElementById('footer').style.display = '';
}

function ceSetStage(stageName, state) {
  // v3: Update status pill and loading text based on stage
  const statusText = document.getElementById('ce-status-text');
  const loadingText = document.getElementById('ce-loading-text');
  const genOverlay = document.getElementById('ce-gen-overlay');
  const genLabel = document.getElementById('ce-gen-label');

  if (stageName === 'upload' && state === 'done') {
    if (statusText) statusText.textContent = 'ANALYZING';
    if (loadingText) loadingText.textContent = 'Extracting emotional DNA...';
  }
  if (stageName === 'feel' && state === 'done') {
    if (statusText) statusText.textContent = 'DIRECTING';
    if (loadingText) loadingText.textContent = 'Matching your director...';
  }
  if (stageName === 'direct' && state === 'active') {
    if (statusText) statusText.textContent = 'DIRECTING';
  }
  if (stageName === 'direct' && state === 'done') {
    // Hide director picker overlay
    document.getElementById('ce-directors-overlay').style.display = 'none';
  }
  if (stageName === 'generate' && state === 'active') {
    if (statusText) statusText.textContent = 'GENERATING';
    // Show generation overlay with fresh explanation text
    genOverlay.style.display = 'flex';
    if (genLabel) genLabel.textContent = 'Crafting a visual world unique to your track.';
    const genSublabel = document.getElementById('ce-gen-sublabel');
    if (genSublabel) genSublabel.textContent = '';
    // Start ETA countdown
    window._genStartTime = Date.now();
    window._genEtaInterval = setInterval(updateGenEta, 1000);
    updateGenSteps(0);
  }
  if (stageName === 'generate' && state === 'done') {
    if (genOverlay) genOverlay.style.display = 'none';
    if (window._genEtaInterval) { clearInterval(window._genEtaInterval); window._genEtaInterval = null; }
  }
  if (stageName === 'validate' && state === 'done') {
    if (statusText) statusText.textContent = 'COMPLETE';
  }
  // Hidden detail elements for compatibility
  const el = document.getElementById(`ce-${stageName}-detail`);
  if (el) el.textContent = state;
}

function ceSetDetail(stageName, text) {
  const el = document.getElementById(`ce-${stageName}-detail`);
  if (el) el.textContent = text;
  // Also update visible elements
  const loadingText = document.getElementById('ce-loading-text');
  const genLabel = document.getElementById('ce-gen-label');
  if (stageName === 'feel' && loadingText) loadingText.textContent = text;
  if (stageName === 'generate') {
    // Write server status to sub-label, NOT the main explanation label
    const genSublabel = document.getElementById('ce-gen-sublabel');
    if (genSublabel) genSublabel.textContent = text;
  }
  // Update track meta with feel info
  if (stageName === 'feel') {
    const meta = document.getElementById('ce-track-meta');
    if (meta && text.includes('BPM')) meta.textContent = text;
  }
}

function ceShowDirectorCard(name, match, tags) {
  // v3: No separate card, info shows in directors overlay
}

function ceShowDirections(directions) {
  const list = document.getElementById('ce-directions-list');
  const overlay = document.getElementById('ce-directors-overlay');
  // Hide the loading placeholder
  document.getElementById('ce-video-placeholder').style.display = 'none';

  // Map director styles to mood demo preview images
  const directorPreview = {
    hype_williams: '/mood_demos/peak_transmission_demo.png',       // bold, maximalist, art deco
    observed_moment: '/mood_demos/memory_in_motion_demo_REAL.png', // silhouette in golden light beams, intimate
    spike_jonze: '/mood_demos/euphoric_drift_demo.png',            // woman in flower field, vulnerable, human
    the_daniels: '/mood_demos/neon_calm_demo.png',                 // surreal pink neon corridor
    khalil_joseph: '/mood_demos/analog_memory_demo.png',           // golden film grain through trees, nostalgic
    dave_meyers: '/mood_demos/concrete_heat_demo.png',             // raw urban texture, kinetic energy
    wong_kar_wai: '/mood_demos/midnight_city_demo.png',            // rainy neon city, bokeh, romantic noir
    golden_hour: '/mood_demos/sunrise_departure_demo.png',         // misty dawn, pink/lavender ethereal
    midnight_drift: '/mood_demos/velvet_dark_demo.png',            // purple velvet, nocturnal, reflective
  };
  list.innerHTML = directions.map((d, i) => {
    const preview = directorPreview[d.director_style] || '/mood_demos/memory_in_motion_demo.png';
    return `
    <div class="ce-dir-option${i === 0 ? ' selected' : ''}" onclick="ceSelectDirection('${d.id}', this)" data-id="${d.id}" data-style="${d.director_style || d.id}">
      <img class="ce-dir-preview" src="${preview}" alt="${d.director_name}" loading="lazy">
      <div class="ce-dir-info">
        <div class="ce-dir-name">${d.director_name}</div>
        <div class="ce-dir-desc">${d.philosophy || d.motion_style || ''}</div>
      </div>
      <div class="ce-dir-match">${Math.round((d.confidence || 0) * 100)}%</div>
    </div>
  `}).join('');
  overlay.style.display = 'flex';
}

function ceSelectDirection(directionId, el) {
  // Visual selection
  document.querySelectorAll('.ce-dir-option').forEach(d => d.classList.remove('selected'));
  if (el) el.classList.add('selected');
  // Hide directors overlay, show gen overlay
  document.getElementById('ce-directors-overlay').style.display = 'none';
  // Trigger generation
  selectDirection(directionId);
}

function ceShowModeBanner(mode, gpuError) {
  // Remove existing banner if any
  const existing = document.getElementById('ce-mode-banner');
  if (existing) existing.remove();

  const banner = document.createElement('div');
  banner.id = 'ce-mode-banner';
  banner.style.cssText = `
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
    z-index: 10001; padding: 6px 16px; border-radius: 20px;
    font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    transition: opacity 0.3s ease; pointer-events: auto; cursor: pointer;
  `;

  if (mode === 'error') {
    banner.style.background = 'rgba(231, 76, 60, 0.85)';
    banner.style.color = '#fff';
    banner.textContent = 'âš  GPU ERROR â€” Generation failed';
    banner.title = gpuError || 'GPU server error';
  } else if (mode === 'gpu') {
    banner.style.background = 'rgba(46, 204, 113, 0.85)';
    banner.style.color = '#fff';
    banner.textContent = 'âœ“ GPU MODE â€” Real generation active';
    // Auto-hide GPU banner after 5s
    setTimeout(() => { banner.style.opacity = '0'; setTimeout(() => banner.remove(), 300); }, 5000);
  }

  banner.onclick = () => { banner.style.opacity = '0'; setTimeout(() => banner.remove(), 300); };
  document.body.appendChild(banner);
}

function ceShowQuality(score) {
  const scoreEl = document.getElementById('ce-quality-score');
  const numEl = document.getElementById('ce-score-number');
  numEl.textContent = score.toFixed(1);
  numEl.style.color = score >= 9.3 ? 'var(--accent)' : score >= 8.0 ? '#e67e22' : '#e74c3c';
  scoreEl.style.opacity = '1';
}

function ceShowVideo(videoUrl) {
  const video = document.getElementById('ce-preview-video');
  const placeholder = document.getElementById('ce-video-placeholder');
  const genOverlay = document.getElementById('ce-gen-overlay');

  // Clean the URL â€” avoid double query params
  const cleanUrl = videoUrl.split('?')[0] + '?t=' + Date.now();
  console.log('[ceShowVideo] Loading:', cleanUrl);

  // Error handling â€” log video load failures
  video.onerror = () => {
    console.error('[ceShowVideo] Video load error:', video.error?.code, video.error?.message);
  };
  video.oncanplay = () => {
    console.log('[ceShowVideo] Video can play â€” duration:', video.duration, 'size:', video.videoWidth, 'x', video.videoHeight);
  };
  video.onloadeddata = () => {
    console.log('[ceShowVideo] Video data loaded, attempting play');
    video.play().catch(e => console.warn('[ceShowVideo] Play failed:', e.message));
  };

  video.src = cleanUrl;
  video.load();

  // Hide overlays, show video
  placeholder.style.display = 'none';
  if (genOverlay) genOverlay.style.display = 'none';
  // Also hide directors overlay
  const dirOverlay = document.getElementById('ce-directors-overlay');
  if (dirOverlay) dirOverlay.style.display = 'none';

  // Show the creative drawer
  document.getElementById('ce-drawer').style.display = 'flex';

  // Timeline sync
  video.addEventListener('timeupdate', () => {
    const pct = video.duration ? (video.currentTime / video.duration) * 100 : 0;
    const fill = document.getElementById('ce-timeline-fill');
    if (fill) fill.style.width = pct + '%';
  });
}

function ceUpdateTags(emotionalDna, directorStyle) {
  const tagsEl = document.getElementById('ce-tags');
  const greenTags = [];
  const redTags = [];

  // Positive attributes based on the director/style
  if (directorStyle) {
    const styleMap = {
      'spike_jonze': ['Intimate framing', 'Emotional depth', 'Natural grain'],
      'wong_kar_wai': ['Neon glow', 'Slow motion', 'Melancholic beauty'],
      'khalil_joseph': ['Analog warmth', 'Memory texture', 'Soft light'],
      'the_daniels': ['Bold color', 'Dynamic energy', 'Creative cuts'],
      'hype_williams': ['High contrast', 'Bold movement', 'Visual power'],
      'dave_meyers': ['Street texture', 'Raw energy', 'Bold grade'],
      'observed_moment': ['Natural light', 'Grain texture', 'Soft focus'],
      'golden_hour': ['Warm light', 'Amber tones', 'Gentle motion'],
      'midnight_drift': ['Cool tones', 'Neon accents', 'Smooth drift'],
    };
    (styleMap[directorStyle] || styleMap['observed_moment']).forEach(t => greenTags.push(t));
  } else {
    greenTags.push('Natural light', 'Grain texture', 'Soft focus');
  }

  // Negative attributes (Observed Moment philosophy)
  redTags.push('No eye contact', 'No beat sync', 'No digital polish');

  tagsEl.innerHTML =
    greenTags.map(t => `<span class="ce-tag ce-tag-green">${t}</span>`).join('') +
    redTags.map(t => `<span class="ce-tag ce-tag-red">${t}</span>`).join('');
}

// â”€â”€ File Upload â†’ Canvas Engine Pipeline â”€â”€

async function handleFileUpload(input) {
  // GPU FAIL CHECK â€” Block upload if GPU is dead (secondary guard)
  if (window.__gpuGate && !window.__gpuGate.isLive()) {
    alert('GPU server is offline. Cannot generate canvases until the GPU server is running.');
    return;
  }
  // Double-check by pinging health endpoint directly
  try {
    const hc = await fetch('/api/health', { cache: 'no-store', signal: AbortSignal.timeout(5000) });
    if (!hc.ok) {
      alert('GPU server is offline. Cannot generate canvases right now.');
      return;
    }
    const hcData = await hc.json();
    if (hcData.gpu !== 'live') {
      alert('GPU server is not responding. Please wait for it to come online.');
      return;
    }
  } catch (e) {
    alert('Cannot reach GPU server. Generation is unavailable.');
    return;
  }

  if (input.files && input.files[0]) {
    currentFile = input.files[0];

    // Show Canvas Engine full-screen view
    showCanvasEngine();

    // Set track name in the bottom overlay
    const displayName = currentFile.name.replace(/\.(wav|mp3|flac|m4a)$/i, '').replace(/_/g, ' ');
    const trackNameEl = document.getElementById('ce-track-name');
    if (trackNameEl) trackNameEl.textContent = displayName;

    // Stage 1: Upload â€” mark active
    ceSetStage('upload', 'active');
    ceSetDetail('upload', `${currentFile.name} â€” uploading...`);

    try {
      // Upload file
      const formData = new FormData();
      formData.append('file', currentFile);
      const uploadResp = await fetch('/api/upload', { method: 'POST', body: formData });
      if (!uploadResp.ok) throw new Error('Upload failed');
      const uploadData = await uploadResp.json();
      currentJobId = uploadData.job_id;

      // Upload complete
      const sizeMB = (currentFile.size / 1024 / 1024).toFixed(1);
      ceSetStage('upload', 'done');
      ceSetDetail('upload', `${currentFile.name} â€” ${sizeMB}MB`);

      // Stage 2: Feel â€” extract emotional DNA
      ceSetStage('feel', 'active');
      ceSetDetail('feel', 'Extracting emotional DNA from your track...');
      document.getElementById('ce-status-text').textContent = 'ANALYZING';

      const analyzeResp = await fetch('/api/v2/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ job_id: currentJobId })
      });

      if (!analyzeResp.ok) {
        console.log('v2 analyze unavailable, falling back to v1');
        ceSetStage('feel', 'done');
        ceSetDetail('feel', 'Analysis complete');
        await fallbackToV1(currentJobId);
        return;
      }

      const analyzeData = await analyzeResp.json();
      const dna = analyzeData.emotional_dna || {};

      if (analyzeData.mode === 'gpu') {
        console.log('[LoopCanvas] GPU mode active â€” real analysis');
        ceShowModeBanner('gpu');
      }

      // Feel complete â€” show emotional data
      ceSetStage('feel', 'done');
      const bpm = dna.bpm || dna.tempo || '?';
      const key = dna.key || '?';
      const energy = dna.energy_label || dna.mood || 'Unknown';
      ceSetDetail('feel', `BPM: ${Math.round(bpm)} â€” Key: ${key} â€” Energy: ${energy}`);

      // Store DNA for suggestion generation
      // (DNA bar is hidden in v3; meta info shows in overlay)

      // Stage 3: Direct â€” show director options
      ceSetStage('direct', 'active');
      document.getElementById('ce-status-text').textContent = 'DIRECTING';

      if (analyzeData.directions && analyzeData.directions.length > 0) {
        const top = analyzeData.directions[0];
        ceSetDetail('direct', `Matching director: ${top.director_name}`);
        ceShowDirectorCard(
          top.director_name,
          Math.round((top.confidence || 0) * 100),
          top.attributes || top.tags || ['Natural light', 'Long takes', 'Handheld drift', 'Golden hour']
        );
        ceShowDirections(analyzeData.directions);
        currentEmotionalDna = dna;
      } else {
        await fallbackToV1(currentJobId);
      }

    } catch (error) {
      console.error('Pipeline error:', error);
      ceSetStage('generate', 'done');
      ceSetDetail('generate', 'GPU generation failed â€” ' + (error.message || 'server unreachable'));
      document.getElementById('ce-status-text').textContent = 'ERROR';
      ceShowModeBanner('error', error.message);
    }
  }
}

async function fallbackToV1(jobId) {
  ceSetStage('direct', 'done');
  ceSetDetail('direct', 'Using default director');
  ceSetStage('generate', 'active');
  ceSetDetail('generate', 'Starting video generation...');

  const genResp = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ job_id: jobId })
  });
  if (genResp.ok) {
    pollJobStatus(jobId);
  } else {
    ceSetStage('generate', 'done');
    ceSetDetail('generate', 'GPU generation failed â€” server returned error');
    document.getElementById('ce-status-text').textContent = 'ERROR';
  }
}

function showDirectionPicker(directions, emotionalDna) {
  // Legacy compat â€” now handled by Canvas Engine view
  ceShowDirections(directions);
}

async function selectDirection(directionId) {
  // Mark Direct as done, Generate as active
  ceSetStage('direct', 'done');
  ceSetStage('generate', 'active');
  ceSetDetail('generate', 'Generating canvas with selected style...');

  try {
    const selectResp = await fetch('/api/v2/select', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ job_id: currentJobId, direction_id: directionId })
    });

    if (!selectResp.ok) {
      await fallbackToV1(currentJobId);
      return;
    }

    // Update tags based on selected direction
    ceUpdateTags(currentEmotionalDna, directionId);

    pollJobStatus(currentJobId);
  } catch (error) {
    console.error('Select error:', error);
    await fallbackToV1(currentJobId);
  }
}

function expandToMusicVideo() {
  // If connected to GPU, extend via API
  if (currentJobId && currentOutputDir) {
    const feedback = document.getElementById('ce-iterate-feedback');
    const label = document.getElementById('ce-iterate-label');
    if (feedback) { label.textContent = 'Extending to full music video...'; feedback.classList.add('active'); }
    document.getElementById('ce-status-text').textContent = 'EXTENDING';

    fetch('/api/v2/extend', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ job_id: currentJobId, duration: 'full' })
    }).then(r => r.json()).then(data => {
      if (data.outputs && data.outputs.full_video) {
        ceShowVideo(data.outputs.full_video);
      }
      if (feedback) feedback.classList.remove('active');
      document.getElementById('ce-status-text').textContent = 'COMPLETE';
    }).catch((err) => {
      if (feedback) feedback.classList.remove('active');
      document.getElementById('ce-status-text').textContent = 'ERROR';
      console.error('Extend failed:', err);
    });
  } else {
    // No job ID â€” GPU not connected
    document.getElementById('ce-status-text').textContent = 'ERROR';
    console.error('Cannot extend: no active GPU job');
  }
}

// demoExtendToVideo â€” REMOVED. No demo mode. GPU or nothing.

// Fun loading messages by stage
const FUN_MESSAGES = {
  upload: [
    "Your track sounds interesting already... ğŸ‘€",
    "Preparing the audio kitchen... ğŸ³",
    "Warming up the visual engines... ğŸš€",
  ],
  transcribe: [
    "Listening closely to every word... ğŸ‘‚",
    "Your lyrics are giving main character energy âœ¨",
    "Finding the poetry in your sound... ğŸ“",
    "Decoding the vibe... ğŸ­",
  ],
  analyze: [
    "This beat is hitting different... ğŸ”¥",
    "Detecting some serious groove here... ğŸ•º",
    "Your BPM is chef's kiss ğŸ‘¨â€ğŸ³",
    "The energy is immaculate... ğŸ’«",
  ],
  mood: [
    "Picking up on the emotions... ğŸ­",
    "This track has layers... like an onion ğŸ§…",
    "Sensing some real feelings here... ğŸ’­",
    "The mood board is coming together... ğŸ¨",
  ],
  concept: [
    "Building your visual universe... ğŸŒŒ",
    "Crafting something special... âœ¨",
    "The vision is becoming clear... ğŸ‘ï¸",
    "This is going to look incredible... ğŸ¬",
  ],
  assets: [
    "Cooking up some visuals... ğŸ¨",
    "The AI is feeling creative today... ğŸ¤–",
    "Generating pure cinema... ğŸ¥",
    "Each frame is being handcrafted (by robots)... ğŸ¦¾",
    "Making it look expensive... ğŸ’°",
  ],
  render: [
    "Putting it all together... ğŸ§©",
    "Adding the finishing touches... âœ¨",
    "This is the moment... ğŸ¬",
    "Almost there, don't blink... ğŸ‘€",
    "Rendering at max quality... ğŸ“º",
  ],
  final: [
    "Just a few more seconds... â³",
    "Quality checking every pixel... ğŸ”",
    "Making sure it's perfect... ğŸ’¯",
    "You're gonna love this... ğŸ˜",
  ],
  error: [
    "Hmm, let me try that again... ğŸ”„",
    "Small hiccup, one sec... âš¡",
    "Recalibrating the visual engine... ğŸ› ï¸"
  ]
};

const STAGE_EMOJIS = ['ğŸµ', 'ğŸ‘‚', 'ğŸ“Š', 'ğŸ­', 'ğŸ’¡', 'ğŸ¨', 'ğŸ¬'];
let currentStage = 0;
let funMessageInterval = null;

function getRandomMessage(stage) {
  const messages = FUN_MESSAGES[stage] || FUN_MESSAGES.assets;
  return messages[Math.floor(Math.random() * messages.length)];
}

function updateLoadingUI(progress, message, stage) {
  // Update main message
  document.getElementById('generating-text').textContent = message;

  // Update progress bar
  document.getElementById('progress-fill').style.width = `${progress}%`;

  // Update emoji based on stage
  const stageIndex = Math.min(Math.floor(progress / 15), 6);
  document.getElementById('spinner-emoji').textContent = STAGE_EMOJIS[stageIndex];

  // Update stage dots
  const dots = document.querySelectorAll('.stage-dot');
  dots.forEach((dot, i) => {
    if (i < stageIndex) {
      dot.classList.add('done');
      dot.classList.remove('active');
    } else if (i === stageIndex) {
      dot.classList.add('active');
      dot.classList.remove('done');
    } else {
      dot.classList.remove('done', 'active');
    }
  });
}

function startFunMessages(stage = 'upload') {
  // Clear any existing interval
  if (funMessageInterval) clearInterval(funMessageInterval);

  // Show initial message
  document.getElementById('fun-message').textContent = getRandomMessage(stage);

  // Rotate messages every 4 seconds
  funMessageInterval = setInterval(() => {
    const funEl = document.getElementById('fun-message');
    funEl.style.animation = 'none';
    funEl.offsetHeight; // Trigger reflow
    funEl.style.animation = 'fadeInUp 0.5s ease';
    funEl.textContent = getRandomMessage(stage);
  }, 4000);
}

function stopFunMessages() {
  if (funMessageInterval) {
    clearInterval(funMessageInterval);
    funMessageInterval = null;
  }
}

function updateGenSteps(progress) {
  // Map progress % to generation steps
  const steps = [
    { id: 'ce-gstep-analyze',  min: 0,  max: 50 },
    { id: 'ce-gstep-concept',  min: 50, max: 60 },
    { id: 'ce-gstep-scenes',   min: 60, max: 80 },
    { id: 'ce-gstep-render',   min: 80, max: 92 },
    { id: 'ce-gstep-quality',  min: 92, max: 100 },
  ];
  steps.forEach(s => {
    const el = document.getElementById(s.id);
    if (!el) return;
    if (progress >= s.max) {
      el.className = 'ce-gen-step done';
      el.querySelector('.ce-gen-step-icon').innerHTML = '<svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 5l2.5 2.5L8 3" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" fill="none"/></svg>';
    } else if (progress >= s.min) {
      el.className = 'ce-gen-step active';
      el.querySelector('.ce-gen-step-icon').innerHTML = '';
    } else {
      el.className = 'ce-gen-step';
      el.querySelector('.ce-gen-step-icon').innerHTML = '';
    }
  });
}

function updateGenEta() {
  const eta = document.getElementById('ce-gen-eta');
  if (!eta || !window._genStartTime) return;
  const elapsed = Math.floor((Date.now() - window._genStartTime) / 1000);
  const totalEstimate = 60; // ~1 minute for canvas-only cloud mode (1 clip + render)
  const remaining = Math.max(0, totalEstimate - elapsed);
  if (remaining > 60) {
    const mins = Math.ceil(remaining / 60);
    eta.innerHTML = `It will be ready in: <strong>~${mins} minute${mins > 1 ? 's' : ''}</strong>`;
  } else if (remaining > 0) {
    eta.innerHTML = `It will be ready in: <strong>~${remaining} seconds</strong>`;
  } else {
    eta.innerHTML = `<strong>Finishing up...</strong>`;
  }
}

function pollJobStatus(jobId) {
  let errorCount = 0;
  const startedAt = Date.now();
  let lastProgress = -1;
  let lastProgressTime = Date.now();

  const poll = async () => {
    // 20-minute max polling duration (cloud generation takes ~13 min for 7 clips)
    if (Date.now() - startedAt > 1200000) {
      stopFunMessages();
      ceSetStage('generate', 'done');
      ceSetDetail('generate', 'Generation timed out. Refresh page to check status.');
      document.getElementById('ce-status-text').textContent = 'TIMEOUT';
      return;
    }

    try {
      // Try v2 status first, fall back to v1
      let resp = await fetch(`/api/v2/status/${jobId}`);
      if (!resp.ok) {
        resp = await fetch(`/api/status/${jobId}`);
      }
      const job = await resp.json();
      const progress = job.progress || 0;

      // Successful poll â€” reset error count
      errorCount = 0;

      // Update Canvas Engine progress bar
      document.getElementById('ce-generate-fill').style.width = `${progress}%`;
      updateGenSteps(progress);

      // Stall detection: if progress unchanged for 120s while generating
      if (progress !== lastProgress) {
        lastProgress = progress;
        lastProgressTime = Date.now();
      }
      let detailMsg = job.message || `Generating... ${progress}%`;
      if (job.status === 'generating' && (Date.now() - lastProgressTime > 600000)) {
        detailMsg += ' (stalled â€” GPU may need restart)';
      }
      ceSetDetail('generate', detailMsg);

      if (job.status === 'complete') {
        stopFunMessages();
        currentOutputDir = job.outputs;
        if (job.quality_score) currentQualityScore = job.quality_score;
        if (job.emotional_dna) currentEmotionalDna = job.emotional_dna;

        // Generate stage complete
        ceSetStage('generate', 'done');
        ceSetDetail('generate', 'Canvas generated');
        document.getElementById('ce-generate-fill').style.width = '100%';

        // Validate stage
        ceSetStage('validate', 'active');
        const qualityScore = typeof currentQualityScore === 'number' ? currentQualityScore :
                             (job.quality_score || 0);

        if (qualityScore > 0) {
          ceSetStage('validate', 'done');
          ceSetDetail('validate', qualityScore >= 9.3
            ? `Score: ${qualityScore.toFixed(1)}/10 â€” PASSED`
            : `Score: ${qualityScore.toFixed(1)}/10 â€” Below 9.3 threshold`);
          ceShowQuality(qualityScore);
        } else {
          ceSetStage('validate', 'done');
          ceSetDetail('validate', 'Quality scoring complete');
        }

        // Show video preview
        document.getElementById('ce-status-text').textContent = 'COMPLETE';
        const videoUrl = (typeof job.outputs === 'object' && job.outputs.canvas)
          ? job.outputs.canvas
          : (typeof job.outputs === 'string' ? job.outputs : `/outputs/${jobId}/spotify_canvas_7s_9x16.mp4`);
        ceShowVideo(videoUrl);

        // Show result (transition to editor after a moment)
        setTimeout(() => {
          showResult(currentFile?.name || job.filename || 'Track', job);
        }, 3000);
        return;

      } else if (job.status === 'error' || job.status === 'dead') {
        stopFunMessages();
        ceSetStage('generate', 'done');
        ceSetDetail('generate', 'Generation failed â€” ' + (job.message || 'GPU error'));
        document.getElementById('ce-status-text').textContent = 'ERROR';
        console.error('Job error:', job.message);
        return;
      }

      // Continue polling
      setTimeout(poll, 2000);

    } catch (error) {
      errorCount++;
      console.error(`Poll error (${errorCount}/10):`, error);
      if (errorCount < 10) {
        const backoff = Math.min(2000 * Math.pow(1.5, errorCount), 15000);
        setTimeout(poll, backoff);
        return;
      }
      stopFunMessages();
      ceSetStage('generate', 'done');
      ceSetDetail('generate', 'Lost connection to GPU server');
      document.getElementById('ce-status-text').textContent = 'ERROR';
    }
  };

  poll();
}

// startDemoGeneration â€” REMOVED. No demo mode. GPU or nothing.

function showResult(filename, jobData) {
  closeUploadModal();

  // Canvas Engine IS the workspace â€” video plays fullscreen, drawer has creative tools
  if (!document.getElementById('canvas-engine').classList.contains('active')) {
    showCanvasEngine();
  }

  const displayName = filename.replace(/\.(wav|mp3|flac|m4a)$/i, '').replace(/_/g, ' ');

  // Set track name in the bottom overlay
  const trackNameEl = document.getElementById('ce-track-name');
  if (trackNameEl) trackNameEl.textContent = displayName;

  if (jobData && jobData.outputs && jobData.outputs.canvas) {
    // Real GPU output
    ceShowVideo(jobData.outputs.canvas);
    currentOutputDir = jobData.outputs;

    const q = jobData.quality_score || currentQualityScore;
    if (q && q > 0) {
      ceShowQuality(q);
      ceSetStage('validate', 'done');
      ceSetDetail('validate', q >= 9.3
        ? `Score: ${q.toFixed(1)}/10 â€” PASSED`
        : `Score: ${q.toFixed(1)}/10 â€” Below 9.3 threshold`);
    }

    document.getElementById('ce-status-text').textContent = 'COMPLETE';
    // Show creative drawer with intent bar + actions
    document.getElementById('ce-drawer').style.display = 'flex';
    ceUpdateSuggestions();

  } else if (currentJobId) {
    pollJobStatus(currentJobId);
  } else {
    // No job data and no job ID â€” GPU generation didn't produce output
    document.getElementById('ce-status-text').textContent = 'ERROR';
    ceSetStage('generate', 'done');
    ceSetDetail('generate', 'No GPU output received');
    console.error('showResult: no job data and no active job');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATIVE DIRECTOR WORKSPACE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function ceShowWorkspace(trackName) {
  // v3: Show the bottom drawer with intent bar + actions
  const drawer = document.getElementById('ce-drawer');
  if (drawer) drawer.style.display = 'flex';
  // Set track name in overlay
  const trackNameEl = document.getElementById('ce-track-name');
  if (trackNameEl) trackNameEl.textContent = trackName || 'Your Track';
  // Update intent suggestions based on emotional DNA
  ceUpdateSuggestions();
}

function ceSubmitIntent() {
  const input = document.getElementById('ce-intent-input');
  const intent = input.value.trim();
  if (!intent) return;

  const video = document.getElementById('ce-preview-video');
  const statusText = document.getElementById('ce-status-text');
  const feedback = document.getElementById('ce-iterate-feedback');
  const feedbackLabel = document.getElementById('ce-iterate-label');

  // Visual: blur the current video, show feedback
  if (statusText) statusText.textContent = 'ITERATING';
  if (video) video.classList.add('iterating');
  if (feedback) { feedbackLabel.textContent = `Applying: "${intent}"`; feedback.classList.add('active'); }

  // If connected to GPU server, send the intent
  if (currentJobId) {
    fetch('/api/v2/iterate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ job_id: currentJobId, intent: intent })
    }).then(r => r.json()).then(data => {
      if (data.outputs && data.outputs.canvas) {
        ceShowVideo(data.outputs.canvas);
      }
      if (video) { video.classList.remove('iterating'); video.classList.add('revealing'); setTimeout(() => video.classList.remove('revealing'), 800); }
      if (feedback) feedback.classList.remove('active');
      if (statusText) statusText.textContent = 'COMPLETE';
    }).catch((err) => {
      if (video) { video.classList.remove('iterating'); }
      if (feedback) feedback.classList.remove('active');
      if (statusText) statusText.textContent = 'ERROR';
      console.error('Iterate failed:', err);
    });
  } else {
    // No job ID â€” GPU not connected, can't iterate
    if (video) { video.classList.remove('iterating'); }
    if (feedback) feedback.classList.remove('active');
    if (statusText) statusText.textContent = 'ERROR';
    console.error('Cannot iterate: no active GPU job');
  }

  input.value = '';
}

// ceDemoIterate â€” REMOVED. No demo mode. GPU or nothing.

function ceUseSuggestion(el) {
  // Highlight the selected chip
  document.querySelectorAll('.ce-chip').forEach(c => {
    c.style.borderColor = '';
    c.style.color = '';
  });
  el.style.borderColor = 'var(--accent)';
  el.style.color = 'var(--accent)';
  // Populate input â€” let user review and press enter to confirm (no accidental fires)
  const input = document.getElementById('ce-intent-input');
  input.value = el.textContent;
  input.focus();
}

function ceSliderChange(param, value) {
  // v3: No sliders â€” intent-based editing only. Kept for compatibility.
  const el = document.getElementById(`ce-slider-${param}-val`);
  if (el) el.textContent = value;
}

function ceRegenerate() {
  // v3: Regenerate uses intent input â€” just submit whatever is in the input
  const input = document.getElementById('ce-intent-input');
  if (!input.value.trim()) {
    input.value = 'subtle refinement';
  }
  ceSubmitIntent();
}

function ceStartSpotifyProgress() {
  const fill = document.getElementById('ce-sp-progress-fill');
  const timeEl = document.getElementById('ce-sp-time');
  if (!fill || !timeEl) return;

  let progress = 0;
  const duration = 7; // 7 second canvas
  const interval = setInterval(() => {
    progress += 0.1;
    if (progress >= duration) progress = 0;
    fill.style.width = `${(progress / duration) * 100}%`;
    const secs = Math.floor(progress);
    const ms = Math.floor((progress - secs) * 10);
    timeEl.textContent = `0:0${secs}.${ms}`;
  }, 100);

  // Store interval so we can clear it
  window._ceSpotifyInterval = interval;
}

function ceSpotifyPlayPause() {
  const video = document.getElementById('ce-spotify-video');
  if (!video) return;
  if (video.paused) { video.play(); } else { video.pause(); }
}

function ceUpdateSuggestions() {
  const dna = currentEmotionalDna || {};
  const suggestions = document.getElementById('ce-intent-suggestions');
  if (!suggestions) return;

  // Generate context-aware suggestions
  const contextSuggestions = [];
  if (dna.valence < 0.4) {
    contextSuggestions.push('more melancholy', 'rain-soaked', 'late night vibes');
  } else if (dna.valence > 0.7) {
    contextSuggestions.push('euphoric', 'golden light', 'festival energy');
  }
  if (dna.bpm && dna.bpm > 120) {
    contextSuggestions.push('faster cuts', 'strobe flashes', 'raw energy');
  } else if (dna.bpm && dna.bpm < 90) {
    contextSuggestions.push('slow drift', 'breathing room', 'meditative');
  }
  // Add genre-specific
  const genres = dna.genre_predictions || {};
  if (genres.hip_hop > 0.5) contextSuggestions.push('concrete jungle', 'neon streets');
  if (genres.electronic > 0.5) contextSuggestions.push('liquid metal', 'circuit boards');

  // Default fallbacks
  const defaults = ['warmer tones', 'more movement', 'darker mood', 'film grain', 'slow motion'];
  const finalSuggestions = contextSuggestions.length > 3 ? contextSuggestions.slice(0, 5) : defaults;

  suggestions.innerHTML = finalSuggestions
    .map(s => `<button class="ce-suggestion" onclick="ceUseSuggestion(this)">${s}</button>`)
    .join('');
}

function ceExport(platform) {
  const formats = {
    spotify: { name: 'Spotify Canvas', ratio: '9:16', duration: '7s' },
    reels: { name: 'Instagram Reels', ratio: '9:16', duration: '15-30s' },
    tiktok: { name: 'TikTok', ratio: '9:16', duration: '15-60s' },
    youtube: { name: 'YouTube', ratio: '16:9', duration: 'Full' },
    apple: { name: 'Apple Music', ratio: '9:16', duration: '7s' },
    raw: { name: 'Raw Files', ratio: 'Original', duration: 'All' },
  };
  const fmt = formats[platform] || formats.spotify;

  // Get the current video source from the canvas editor preview
  const video = document.getElementById('ce-video');
  if (video && video.src) {
    // Create download link
    const a = document.createElement('a');
    a.href = video.src;
    a.download = `loopcanvas_${platform}_${Date.now()}.mp4`;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Show success toast
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(48,209,88,0.95);color:#000;padding:14px 28px;border-radius:100px;font-size:14px;font-weight:600;z-index:10000;animation:ceFadeUp 0.3s ease;';
    toast.textContent = `Exported for ${fmt.name}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  } else {
    // No video available â€” show export modal
    document.getElementById('export-modal')?.classList.add('active');
  }
}

function ceShowExportAll() {
  // Show all export options as an overlay on the video
  const overlay = document.createElement('div');
  overlay.id = 'ce-export-overlay';
  overlay.style.cssText = 'position:absolute;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(20px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:60;animation:ceFadeUp 0.3s ease;';
  overlay.innerHTML = `
    <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:8px;">Export to all platforms</div>
    <button onclick="ceExport('spotify');this.parentElement.remove();" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;cursor:pointer;width:240px;text-align:left;display:flex;align-items:center;gap:10px;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
      <svg viewBox="0 0 24 24" fill="#1DB954" style="width:20px;height:20px;flex-shrink:0;"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02z"/></svg>
      Spotify Canvas <span style="opacity:0.5;margin-left:auto;">9:16 / 7s</span>
    </button>
    <button onclick="ceExport('reels');this.parentElement.remove();" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;cursor:pointer;width:240px;text-align:left;display:flex;align-items:center;gap:10px;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
      <svg viewBox="0 0 24 24" fill="#E1306C" style="width:20px;height:20px;flex-shrink:0;"><rect width="20" height="20" x="2" y="2" rx="5" fill="none" stroke="#E1306C" stroke-width="2"/><circle cx="12" cy="12" r="5" fill="none" stroke="#E1306C" stroke-width="2"/></svg>
      Instagram Reels <span style="opacity:0.5;margin-left:auto;">9:16 / 30s</span>
    </button>
    <button onclick="ceExport('tiktok');this.parentElement.remove();" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;cursor:pointer;width:240px;text-align:left;display:flex;align-items:center;gap:10px;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
      <svg viewBox="0 0 24 24" fill="#fff" style="width:20px;height:20px;flex-shrink:0;"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-.88-5.64v-3.5a6.37 6.37 0 00-.88-.06A6.4 6.4 0 001.33 15.4 6.4 6.4 0 007.73 21.8a6.4 6.4 0 006.4-6.4V9.06a8.23 8.23 0 005.46 2.09V7.7a4.84 4.84 0 01-3.59-1.01z"/></svg>
      TikTok <span style="opacity:0.5;margin-left:auto;">9:16 / 60s</span>
    </button>
    <button onclick="ceExport('youtube');this.parentElement.remove();" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;cursor:pointer;width:240px;text-align:left;display:flex;align-items:center;gap:10px;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
      <svg viewBox="0 0 24 24" fill="#FF0000" style="width:20px;height:20px;flex-shrink:0;"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
      YouTube <span style="opacity:0.5;margin-left:auto;">16:9 / Full</span>
    </button>
    <button onclick="ceExport('apple');this.parentElement.remove();" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;cursor:pointer;width:240px;text-align:left;display:flex;align-items:center;gap:10px;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
      <svg viewBox="0 0 24 24" fill="#FC3C44" style="width:20px;height:20px;flex-shrink:0;"><path d="M23.994 18.066c-.064.177-1.034 3.564-3.416 5.065-1.455 1.052-2.849 1.036-3.479 1.01-.881-.036-1.598-.372-2.242-.677-.594-.282-1.138-.54-1.92-.54-.83 0-1.417.27-2.048.562-.576.267-1.2.556-2.007.588C8.34 24.084 7.17 24 5.93 22.8 2.123 18.894 1.607 13.056 4.34 9.674c1.35-1.67 3.36-2.665 5.365-2.665.996 0 1.85.335 2.576.622.555.22 1.026.407 1.444.407.359 0 .79-.17 1.31-.378.82-.328 1.842-.737 3.04-.627 1.684.155 2.95.891 3.777 2.195-1.482 1.02-2.667 2.714-2.376 5.169.261 2.207 1.619 3.655 2.975 4.322-.29.65-.431.908-.456.947zM15.69.025C14.2.203 12.434 1.186 11.36 2.598c-.979 1.286-1.79 3.194-1.476 5.045 1.665.053 3.427-.935 4.418-2.36C15.315 3.783 15.975 1.83 15.69.025z"/></svg>
      Apple Music <span style="opacity:0.5;margin-left:auto;">9:16 / 7s</span>
    </button>
    <button onclick="ceExport('raw');this.parentElement.remove();" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;cursor:pointer;width:240px;text-align:left;display:flex;align-items:center;gap:10px;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
      <svg viewBox="0 0 20 20" fill="none" stroke="#fff" stroke-width="1.5" style="width:20px;height:20px;flex-shrink:0;"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
      Raw Files <span style="opacity:0.5;margin-left:auto;">Original</span>
    </button>
    <button onclick="this.parentElement.remove();" style="background:none;border:none;color:rgba(255,255,255,0.5);padding:8px 16px;cursor:pointer;font-size:13px;margin-top:4px;">Cancel</button>
  `;
  const videoWrap = document.querySelector('.ce-video-wrap');
  // Remove existing overlay if any
  const existing = document.getElementById('ce-export-overlay');
  if (existing) existing.remove();
  if (videoWrap) videoWrap.appendChild(overlay);
}

function ceShowActionBar(trackName) {
  // Add action bar to Canvas Engine if not already present
  let bar = document.getElementById('ce-action-bar');
  if (bar) return; // Already exists

  bar = document.createElement('div');
  bar.id = 'ce-action-bar';
  bar.className = 'ce-action-bar';
  bar.innerHTML = `
    <div class="ce-action-track">${trackName || 'Your Track'}</div>
    <div class="ce-action-buttons">
      <button class="ce-action-btn ce-action-edit" onclick="openEditorFromCE()">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" style="width:16px;height:16px;"><path d="M11 4H4a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 00-3 3L9 12l-4 1 1-4 6.5-6.5z"/></svg>
        Edit Canvas
      </button>
      <button class="ce-action-btn ce-action-export" onclick="openExportFromCE()">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" style="width:16px;height:16px;"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        Export
      </button>
    </div>
  `;

  const preview = document.querySelector('.ce-preview');
  if (preview) preview.appendChild(bar);
}

function openEditorFromCE() {
  hideCanvasEngine();
  document.getElementById('hero').style.display = 'none';
  document.getElementById('moods').style.display = 'none';
  document.getElementById('proof').style.display = 'none';
  document.getElementById('footer').style.display = 'none';
  document.getElementById('editor-workspace').classList.add('active');

  // Load video into editor
  const canvasVideo = document.getElementById('canvas-video');
  if (currentOutputDir) {
    const src = typeof currentOutputDir === 'object' ? (currentOutputDir.canvas || '') : currentOutputDir;
    if (src) {
      canvasVideo.src = src + '?t=' + Date.now();
      canvasVideo.load();
      canvasVideo.muted = true;
      canvasVideo.play().catch(() => {});
    }
  }
  initEditorControls();
}

function openExportFromCE() {
  // Show export modal directly
  if (typeof exportTo === 'function') {
    exportTo('spotify');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITOR WORKSPACE CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function closeEditor() {
  document.getElementById('editor-workspace').classList.remove('active');
  hideCanvasEngine();
  document.getElementById('hero').style.display = '';
  document.getElementById('moods').style.display = '';
  document.getElementById('proof').style.display = '';
  document.getElementById('footer').style.display = '';
  // Reset state
  currentFile = null;
  currentJobId = null;
  currentOutputDir = null;
  currentQualityScore = null;
  currentEmotionalDna = null;
  // Reset Canvas Engine v3 elements
  document.getElementById('ce-quality-score').style.opacity = '0';
  document.getElementById('ce-directors-overlay').style.display = 'none';
  document.getElementById('ce-gen-overlay').style.display = 'none';
  document.getElementById('ce-drawer').style.display = 'none';
  document.getElementById('ce-video-placeholder').style.display = 'flex';
  document.getElementById('ce-status-text').textContent = 'PROCESSING';
  // Reset video
  const video = document.getElementById('ce-preview-video');
  if (video) { video.pause(); video.removeAttribute('src'); video.load(); }
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITOR STATE â€” Real parameters that map to generation engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const editorState = {
  // Style selection
  style: 'memory_in_motion',

  // Texture parameters (from VISUAL_STYLES)
  grain: 0.4,
  vignette: 0.5,
  glow: 0.6,
  softness: 0.7,

  // Motion parameters
  motionSpeed: 0.3,
  particleCount: 60,

  // Color parameters
  saturation: 1.15,
  contrast: 1.1,
  temperature: 5500,

  // Effects toggles
  effects: {
    shake: false,
    retro: false,
    distortion: false,
    glitch: false,
    light: true,
  },

  // Observed Moment Scoring (0-1 each, weighted to 10 max)
  scores: {
    observer_neutrality: 1.0,     // Ã—3.0 weight
    camera_humility: 0.85,        // Ã—2.5 weight
    temporal_indifference: 0.9,   // Ã—2.0 weight
    memory_texture: 0.88,         // Ã—1.5 weight
    light_first_emotion: 0.82,    // Ã—1.0 weight
  },

  // Output mode
  outputMode: 'canvas',  // 'canvas' or 'full_video'

  // Pending changes flag
  hasChanges: false,
};

// Scoring axis info for display
const SCORING_AXES = {
  observer_neutrality: { weight: 3.0, min: 1.0, label: 'Observer Neutrality', desc: 'Subject unaware of camera' },
  camera_humility: { weight: 2.5, min: 0.75, label: 'Camera Humility', desc: 'Camera doesn\'t call attention to itself' },
  temporal_indifference: { weight: 2.0, min: 0.80, label: 'Temporal Indifference', desc: 'Motion indifferent to music' },
  memory_texture: { weight: 1.5, min: 0.80, label: 'Memory Texture', desc: 'Feels like memory, not documentation' },
  light_first_emotion: { weight: 1.0, min: 0.75, label: 'Light-First Emotion', desc: 'Emotion from light, not subject' },
};

function calculateTotalScore() {
  let total = 0;
  for (const [axis, info] of Object.entries(SCORING_AXES)) {
    total += editorState.scores[axis] * info.weight;
  }
  return total.toFixed(1);
}

function checkAxisMinimums() {
  const failures = [];
  for (const [axis, info] of Object.entries(SCORING_AXES)) {
    if (editorState.scores[axis] < info.min) {
      failures.push({ axis, score: editorState.scores[axis], min: info.min, label: info.label });
    }
  }
  return failures;
}

function initEditorControls() {
  const video = document.getElementById('canvas-video');

  // Timeline/Playhead sync
  video.addEventListener('timeupdate', () => {
    const progress = (video.currentTime / video.duration) * 100;
    document.getElementById('timeline-playhead').style.left = `${progress}%`;
    document.getElementById('current-time').textContent = formatTime(video.currentTime);
    document.getElementById('total-time').textContent = formatTime(video.duration);
  });

  // Timeline click to seek
  document.getElementById('timeline-track')?.addEventListener('click', (e) => {
    const rect = e.target.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    video.currentTime = percent * video.duration;
  });

  // Mode tabs - switch between Canvas and Full Video
  document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const mode = tab.dataset.mode;
      editorState.outputMode = mode;
      updateModeUI(mode);
    });
  });

  // Effect toggles with real state binding
  document.querySelectorAll('.quick-action[data-effect]').forEach(action => {
    action.addEventListener('click', () => {
      const effect = action.dataset.effect;
      editorState.effects[effect] = !editorState.effects[effect];
      action.classList.toggle('active', editorState.effects[effect]);
      editorState.hasChanges = true;
      updateApplyButton();

      // Update scores based on effects
      recalculateScoresFromParams();
    });
  });

  // Style/Mood selector
  const moodSelect = document.getElementById('mood-select');
  if (moodSelect) {
    moodSelect.addEventListener('change', (e) => {
      editorState.style = e.target.value;
      editorState.hasChanges = true;
      applyStylePreset(e.target.value);
      updateApplyButton();
    });
  }

  // Slider controls with real parameter binding + REAL-TIME CSS FILTER PREVIEW
  initSlider('grain-slider', 'grain', 0, 100, val => {
    editorState.grain = val / 100;
    recalculateScoresFromParams();
    updateVideoFilters(); // Real-time preview
  });

  initSlider('vignette-slider', 'vignette', 0, 100, val => {
    editorState.vignette = val / 100;
    recalculateScoresFromParams();
    updateVideoFilters();
  });

  initSlider('glow-slider', 'glow', 0, 100, val => {
    editorState.glow = val / 100;
    recalculateScoresFromParams();
    updateVideoFilters();
  });

  initSlider('saturation-slider', 'saturation', 0, 100, val => {
    editorState.saturation = 0.5 + (val / 100) * 1.5; // 0.5 to 2.0
    recalculateScoresFromParams();
    updateVideoFilters();
  });

  initSlider('contrast-slider', 'contrast', 0, 100, val => {
    editorState.contrast = 0.8 + (val / 100) * 0.6; // 0.8 to 1.4
    recalculateScoresFromParams();
    updateVideoFilters();
  });

  initSlider('temperature-slider', 'temperature', 0, 100, val => {
    editorState.temperature = 3000 + (val / 100) * 5000; // 3000K to 8000K
    recalculateScoresFromParams();
    updateVideoFilters();
  });

  initSlider('motion-slider', 'motion_speed', 0, 100, val => {
    editorState.motionSpeed = val / 100;
    recalculateScoresFromParams();
  });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REAL-TIME CSS FILTER PREVIEW â€” Instant visual feedback like CapCut
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateVideoFilters() {
  const video = document.getElementById('canvas-video');
  if (!video) return;

  // Build CSS filter string from editor state
  const filters = [];

  // Saturation (1.0 = normal)
  filters.push(`saturate(${editorState.saturation})`);

  // Contrast (1.0 = normal)
  filters.push(`contrast(${editorState.contrast})`);

  // Brightness/Glow (1.0 = normal, higher = brighter/glowier)
  const brightness = 1.0 + (editorState.glow * 0.3);
  filters.push(`brightness(${brightness})`);

  // Temperature (sepia for warm, hue-rotate for cool)
  const tempNorm = (editorState.temperature - 5500) / 2500; // -1 to +1
  if (tempNorm > 0) {
    // Warm (golden) - add sepia
    filters.push(`sepia(${tempNorm * 0.3})`);
  } else {
    // Cool (blue) - hue rotate toward blue
    filters.push(`hue-rotate(${tempNorm * 20}deg)`);
  }

  // Apply combined filter
  video.style.filter = filters.join(' ');

  // Apply grain overlay using CSS pseudo-element (via CSS variable)
  video.style.setProperty('--grain-opacity', editorState.grain * 0.5);

  // Apply vignette using box-shadow (via CSS variable)
  video.style.setProperty('--vignette-size', (1 - editorState.vignette) * 100 + '%');
}

  // Color presets
  document.querySelectorAll('.color-preset').forEach(preset => {
    preset.addEventListener('click', () => {
      document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('active'));
      preset.classList.add('active');
      applyColorPreset(preset.dataset.preset);
    });
  });

  // Quality selector
  document.querySelectorAll('.quality-option').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('.quality-option').forEach(o => o.classList.remove('active'));
      opt.classList.add('active');
    });
  });

  // Initialize scoring display
  updateScoringDisplay();
}

function initSlider(id, param, min, max, onChange) {
  const slider = document.getElementById(id);
  if (!slider) return;

  slider.addEventListener('input', () => {
    const val = parseInt(slider.value);
    const valSpan = slider.parentElement?.querySelector('span');
    if (valSpan) valSpan.textContent = val;
    editorState.hasChanges = true;
    updateApplyButton();
    onChange(val);
    updateScoringDisplay();
  });
}

function recalculateScoresFromParams() {
  // Recalculate scores based on parameter settings
  // Higher grain = more memory texture
  editorState.scores.memory_texture = 0.6 + (editorState.grain * 0.4);

  // Higher glow + lower contrast = more light-first emotion
  editorState.scores.light_first_emotion = Math.min(1.0, 0.5 + (editorState.glow * 0.3) + ((1.5 - editorState.contrast) * 0.3));

  // Slower motion = more temporal indifference
  editorState.scores.temporal_indifference = Math.min(1.0, 0.7 + ((1 - editorState.motionSpeed) * 0.3));

  // Glitch/shake effects reduce observer neutrality
  if (editorState.effects.glitch || editorState.effects.shake) {
    editorState.scores.observer_neutrality = 0.7;
    editorState.scores.camera_humility = 0.6;
  } else {
    editorState.scores.observer_neutrality = 1.0;
    editorState.scores.camera_humility = 0.85;
  }

  updateScoringDisplay();
}

function updateScoringDisplay() {
  const total = calculateTotalScore();
  const failures = checkAxisMinimums();
  const passed = total >= 9.3 && failures.length === 0;

  // Update total score
  const scoreEl = document.getElementById('total-score');
  if (scoreEl) {
    scoreEl.textContent = total;
    scoreEl.className = passed ? 'score-pass' : 'score-fail';
  }

  // Update pass/fail indicator
  const statusEl = document.getElementById('score-status');
  if (statusEl) {
    if (passed) {
      statusEl.innerHTML = '<span class="status-pass">âœ“ PASS</span>';
    } else {
      const reasons = failures.map(f => f.label).join(', ');
      statusEl.innerHTML = `<span class="status-fail">âœ— FAIL</span><span class="fail-reason">${reasons || 'Score below 9.3'}</span>`;
    }
  }

  // Update individual axis scores
  for (const [axis, info] of Object.entries(SCORING_AXES)) {
    const axisEl = document.getElementById(`score-${axis}`);
    if (axisEl) {
      const score = editorState.scores[axis];
      const weighted = (score * info.weight).toFixed(1);
      axisEl.textContent = weighted;
      axisEl.className = score >= info.min ? 'axis-pass' : 'axis-fail';
    }
  }
}

function updateApplyButton() {
  const btn = document.getElementById('apply-changes-btn');
  if (btn) {
    btn.disabled = !editorState.hasChanges;
    btn.classList.toggle('has-changes', editorState.hasChanges);
  }
}

function updateModeUI(mode) {
  // Update UI based on canvas vs full_video mode
  const canvasControls = document.querySelectorAll('.canvas-only');
  const videoControls = document.querySelectorAll('.video-only');

  canvasControls.forEach(el => el.style.display = mode === 'canvas' ? '' : 'none');
  videoControls.forEach(el => el.style.display = mode === 'full_video' ? '' : 'none');

  // Update preview badge
  const badge = document.querySelector('.preview-badge span');
  if (badge) {
    badge.textContent = mode === 'canvas' ? '7s Canvas' : 'Full Video';
  }
}

function applyStylePreset(styleName) {
  // Apply style presets from VISUAL_STYLES mapping
  const presets = {
    memory_in_motion: { grain: 40, vignette: 50, glow: 60, saturation: 57, contrast: 50, motion: 30 },
    afterglow_ritual: { grain: 50, vignette: 60, glow: 80, saturation: 55, contrast: 60, motion: 25 },
    midnight_city: { grain: 30, vignette: 40, glow: 50, saturation: 47, contrast: 75, motion: 50 },
    analog_memory: { grain: 70, vignette: 70, glow: 40, saturation: 35, contrast: 52, motion: 35 },
    velvet_dark: { grain: 45, vignette: 70, glow: 30, saturation: 40, contrast: 70, motion: 20 },
    ghost_room: { grain: 60, vignette: 65, glow: 25, saturation: 30, contrast: 55, motion: 15 },
    euphoric_drift: { grain: 25, vignette: 30, glow: 70, saturation: 65, contrast: 45, motion: 40 },
    sunrise_departure: { grain: 20, vignette: 30, glow: 70, saturation: 60, contrast: 40, motion: 20 },
  };

  const preset = presets[styleName] || presets.memory_in_motion;

  // Update sliders
  setSliderValue('grain-slider', preset.grain);
  setSliderValue('vignette-slider', preset.vignette);
  setSliderValue('glow-slider', preset.glow);
  setSliderValue('saturation-slider', preset.saturation);
  setSliderValue('contrast-slider', preset.contrast);
  setSliderValue('motion-slider', preset.motion);

  // Update state
  editorState.grain = preset.grain / 100;
  editorState.vignette = preset.vignette / 100;
  editorState.glow = preset.glow / 100;
  editorState.saturation = 0.5 + (preset.saturation / 100) * 1.5;
  editorState.contrast = 0.8 + (preset.contrast / 100) * 0.6;
  editorState.motionSpeed = preset.motion / 100;

  recalculateScoresFromParams();
}

function setSliderValue(id, value) {
  const slider = document.getElementById(id);
  if (slider) {
    slider.value = value;
    const valSpan = slider.parentElement?.querySelector('span');
    if (valSpan) valSpan.textContent = value;
  }
}

function applyColorPreset(preset) {
  // Color presets affect temperature and saturation
  const colorPresets = {
    warm: { temperature: 75, saturation: 60 },
    cool: { temperature: 25, saturation: 45 },
    neutral: { temperature: 50, saturation: 50 },
    vintage: { temperature: 60, saturation: 35 },
    vibrant: { temperature: 50, saturation: 80 },
  };

  const p = colorPresets[preset];
  if (p) {
    setSliderValue('temperature-slider', p.temperature);
    setSliderValue('saturation-slider', p.saturation);
    editorState.temperature = 3000 + (p.temperature / 100) * 5000;
    editorState.saturation = 0.5 + (p.saturation / 100) * 1.5;
    editorState.hasChanges = true;
    updateApplyButton();
    recalculateScoresFromParams();
  }
}

function formatTime(seconds) {
  if (isNaN(seconds)) return '0:00';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function togglePlayPause() {
  const video = document.getElementById('canvas-video');
  const playIcon = document.querySelector('#play-pause-btn .play-icon');
  const pauseIcon = document.querySelector('#play-pause-btn .pause-icon');

  if (video.paused) {
    video.play();
    playIcon.style.display = 'none';
    pauseIcon.style.display = 'block';
  } else {
    video.pause();
    playIcon.style.display = 'block';
    pauseIcon.style.display = 'none';
  }
}

function seekBackward() {
  const video = document.getElementById('canvas-video');
  video.currentTime = Math.max(0, video.currentTime - 1);
}

function seekForward() {
  const video = document.getElementById('canvas-video');
  video.currentTime = Math.min(video.duration, video.currentTime + 1);
}

function toggleMute() {
  const video = document.getElementById('canvas-video');
  const soundOn = document.querySelector('#mute-btn .sound-on');
  const soundOff = document.querySelector('#mute-btn .sound-off');

  video.muted = !video.muted;
  soundOn.style.display = video.muted ? 'none' : 'block';
  soundOff.style.display = video.muted ? 'block' : 'none';
}

function resetMood() {
  document.getElementById('mood-select').value = 'memory_in_motion';
}

// AI Editor Chat - Natural Language to Editor Controls
function sendEditorAIMessage() {
  const input = document.getElementById('ai-editor-input');
  const message = input.value.trim();
  if (!message) return;

  const chat = document.getElementById('ai-chat-messages');

  // Add user message
  chat.innerHTML += `
    <div class="ai-message user">
      <div class="ai-message-content">${message}</div>
      <div class="ai-message-time">You â€¢ just now</div>
    </div>
  `;

  input.value = '';
  chat.scrollTop = chat.scrollHeight;

  // Parse natural language and apply changes
  const lowerMsg = message.toLowerCase();
  let changes = [];
  let response = '';

  // Grain / Film texture
  if (lowerMsg.includes('more grain') || lowerMsg.includes('grainier') || lowerMsg.includes('film')) {
    editorState.grain = Math.min(1.0, editorState.grain + 0.2);
    document.querySelector('[data-slider="grain"]').value = editorState.grain * 100;
    changes.push('increased film grain');
  } else if (lowerMsg.includes('less grain') || lowerMsg.includes('cleaner') || lowerMsg.includes('smooth')) {
    editorState.grain = Math.max(0, editorState.grain - 0.2);
    document.querySelector('[data-slider="grain"]').value = editorState.grain * 100;
    changes.push('reduced grain for cleaner look');
  }

  // Warmth / Temperature
  if (lowerMsg.includes('warmer') || lowerMsg.includes('golden') || lowerMsg.includes('sunset')) {
    editorState.temperature = Math.min(8000, editorState.temperature + 1000);
    document.querySelector('[data-slider="temperature"]').value = ((editorState.temperature - 3000) / 5000) * 100;
    changes.push('warmed up color temperature');
  } else if (lowerMsg.includes('cooler') || lowerMsg.includes('blue') || lowerMsg.includes('cold')) {
    editorState.temperature = Math.max(3000, editorState.temperature - 1000);
    document.querySelector('[data-slider="temperature"]').value = ((editorState.temperature - 3000) / 5000) * 100;
    changes.push('cooled down color temperature');
  }

  // Contrast
  if (lowerMsg.includes('more contrast') || lowerMsg.includes('punchier') || lowerMsg.includes('dramatic')) {
    editorState.contrast = Math.min(1.4, editorState.contrast + 0.1);
    document.querySelector('[data-slider="contrast"]').value = ((editorState.contrast - 0.8) / 0.6) * 100;
    changes.push('increased contrast');
  } else if (lowerMsg.includes('less contrast') || lowerMsg.includes('softer') || lowerMsg.includes('flat')) {
    editorState.contrast = Math.max(0.8, editorState.contrast - 0.1);
    document.querySelector('[data-slider="contrast"]').value = ((editorState.contrast - 0.8) / 0.6) * 100;
    changes.push('softened contrast');
  }

  // Saturation
  if (lowerMsg.includes('more saturated') || lowerMsg.includes('vibrant') || lowerMsg.includes('colorful')) {
    editorState.saturation = Math.min(2.0, editorState.saturation + 0.2);
    document.querySelector('[data-slider="saturation"]').value = ((editorState.saturation - 0.5) / 1.5) * 100;
    changes.push('boosted saturation');
  } else if (lowerMsg.includes('desaturated') || lowerMsg.includes('muted') || lowerMsg.includes('faded')) {
    editorState.saturation = Math.max(0.5, editorState.saturation - 0.2);
    document.querySelector('[data-slider="saturation"]').value = ((editorState.saturation - 0.5) / 1.5) * 100;
    changes.push('muted colors');
  }

  // Glow / Bloom
  if (lowerMsg.includes('more glow') || lowerMsg.includes('dreamy') || lowerMsg.includes('bloom')) {
    editorState.glow = Math.min(1.0, editorState.glow + 0.2);
    document.querySelector('[data-slider="glow"]').value = editorState.glow * 100;
    changes.push('added dreamy glow');
  } else if (lowerMsg.includes('less glow') || lowerMsg.includes('sharper') || lowerMsg.includes('crisp')) {
    editorState.glow = Math.max(0, editorState.glow - 0.2);
    document.querySelector('[data-slider="glow"]').value = editorState.glow * 100;
    changes.push('reduced glow for sharper look');
  }

  // Vignette
  if (lowerMsg.includes('more vignette') || lowerMsg.includes('darker edges') || lowerMsg.includes('focus center')) {
    editorState.vignette = Math.min(1.0, editorState.vignette + 0.2);
    document.querySelector('[data-slider="vignette"]').value = editorState.vignette * 100;
    changes.push('increased vignette');
  } else if (lowerMsg.includes('less vignette') || lowerMsg.includes('brighter edges')) {
    editorState.vignette = Math.max(0, editorState.vignette - 0.2);
    document.querySelector('[data-slider="vignette"]').value = editorState.vignette * 100;
    changes.push('reduced vignette');
  }

  // Motion speed
  if (lowerMsg.includes('slower') || lowerMsg.includes('calm') || lowerMsg.includes('peaceful')) {
    editorState.motionSpeed = Math.max(0, editorState.motionSpeed - 0.2);
    document.querySelector('[data-slider="motion"]')?.value && (document.querySelector('[data-slider="motion"]').value = editorState.motionSpeed * 100);
    changes.push('slowed motion for calmer feel');
  } else if (lowerMsg.includes('faster') || lowerMsg.includes('energetic') || lowerMsg.includes('dynamic')) {
    editorState.motionSpeed = Math.min(1.0, editorState.motionSpeed + 0.2);
    document.querySelector('[data-slider="motion"]')?.value && (document.querySelector('[data-slider="motion"]').value = editorState.motionSpeed * 100);
    changes.push('increased motion energy');
  }

  // Style presets
  if (lowerMsg.includes('lubezki') || lowerMsg.includes('natural light') || lowerMsg.includes('golden hour')) {
    applyPreset('memory_in_motion');
    changes.push('applied Lubezki-inspired golden hour look');
  } else if (lowerMsg.includes('wong kar') || lowerMsg.includes('neon') || lowerMsg.includes('urban')) {
    applyPreset('midnight_city');
    changes.push('applied Wong Kar-wai neon aesthetic');
  } else if (lowerMsg.includes('tarkovsky') || lowerMsg.includes('haunting') || lowerMsg.includes('ethereal')) {
    applyPreset('ghost_room');
    changes.push('applied Tarkovsky-inspired atmospheric look');
  } else if (lowerMsg.includes('lynch') || lowerMsg.includes('dark') || lowerMsg.includes('mysterious')) {
    applyPreset('velvet_dark');
    changes.push('applied Lynch-inspired dark mood');
  }

  // Build response
  if (changes.length > 0) {
    editorState.hasChanges = true;
    updateScoresFromEffects();
    updateQualityMeter();
    response = `Done! I've ${changes.join(', ')}. The preview will update with your changes. Click "Regenerate" to create a new canvas with these settings.`;
  } else {
    response = `I understand you want to change "${message}". Try phrases like:
      <br>â€¢ "make it warmer" or "cooler"
      <br>â€¢ "more film grain" or "cleaner"
      <br>â€¢ "more contrast" or "softer"
      <br>â€¢ "more saturated" or "muted colors"
      <br>â€¢ "add dreamy glow"
      <br>â€¢ "Lubezki style" or "Wong Kar-wai look"`;
  }

  // Add AI response
  setTimeout(() => {
    chat.innerHTML += `
      <div class="ai-message assistant">
        <div class="ai-message-content">${response}</div>
        <div class="ai-message-time">AI â€¢ just now</div>
      </div>
    `;
    chat.scrollTop = chat.scrollHeight;
  }, 500);
}

function applySuggestion(text) {
  const input = document.getElementById('ai-editor-input');
  input.value = text;
  sendEditorAIMessage();
}

// Enter key for AI editor chat
document.getElementById('ai-editor-input')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendEditorAIMessage();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREMIUM FEATURES â€” AI Magic, Quality Selector, Export
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showAIMagic() {
  // Add AI enhancement message to chat
  const chat = document.getElementById('ai-chat-messages');
  chat.innerHTML += `
    <div class="ai-message assistant">
      <div class="ai-message-content">
        âœ¨ <strong>AI Auto-Enhance activated</strong>
        <br><br>
        Analyzing your canvas and applying professional polish:
        <br>
        âœ“ Color grading optimized<br>
        âœ“ Film grain balanced<br>
        âœ“ Motion smoothed<br>
        âœ“ Loop seam perfected
      </div>
      <div class="ai-message-time">AI â€¢ just now</div>
    </div>
  `;
  chat.scrollTop = chat.scrollHeight;
}

function exportTo(platform) {
  const chat = document.getElementById('ai-chat-messages');
  const platformMap = {
    spotify: 'spotify_canvas',
    tiktok: 'tiktok',
    youtube: 'youtube_shorts',
    instagram: 'instagram_reels',
    apple: 'apple_music',
    twitter: 'twitter_x',
  };
  const platformNames = {
    spotify: 'Spotify Canvas',
    tiktok: 'TikTok',
    youtube: 'YouTube Shorts',
    instagram: 'Instagram Reels',
    apple: 'Apple Music',
    twitter: 'Twitter/X',
  };

  if (chat) {
    chat.innerHTML += `
      <div class="ai-message assistant">
        <div class="ai-message-content">
          ğŸ“¤ Preparing export for <strong>${platformNames[platform] || platform}</strong>...
        </div>
        <div class="ai-message-time">AI â€¢ just now</div>
      </div>
    `;
    chat.scrollTop = chat.scrollHeight;
  }

  // Use v2 multi-platform export if job exists
  if (currentJobId && platformMap[platform]) {
    fetch('/api/v2/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        job_id: currentJobId,
        platforms: [platformMap[platform]],
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.exports) {
        const exp = data.exports[platformMap[platform]];
        if (exp && exp.success && exp.output_path) {
          // Download the exported file
          const link = document.createElement('a');
          link.href = exp.output_path;
          link.download = `${currentFile?.name?.replace(/\.\w+$/, '') || 'canvas'}_${platform}.mp4`;
          link.click();

          if (chat) {
            chat.innerHTML += `
              <div class="ai-message assistant">
                <div class="ai-message-content">
                  âœ… ${platformNames[platform]} export ready (${exp.resolution}, ${exp.file_size_mb?.toFixed(1)}MB)
                  ${exp.warnings?.length ? '<br>âš ï¸ ' + exp.warnings.join(', ') : ''}
                </div>
                <div class="ai-message-time">AI â€¢ just now</div>
              </div>
            `;
            chat.scrollTop = chat.scrollHeight;
          }
          return;
        }
      }
      // Fallback
      downloadCanvas();
    })
    .catch(() => downloadCanvas());
  } else {
    setTimeout(() => downloadCanvas(), 500);
  }
}

// Quality selector
document.querySelectorAll('.quality-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.querySelectorAll('.quality-option').forEach(o => o.classList.remove('active'));
    opt.classList.add('active');
  });
});

function regenerateCanvas() {
  if (!currentJobId) {
    setTimeout(() => showResult(currentFile?.name || 'Track', null), 2000);
    return;
  }

  // Build a natural language description of the current params
  const adjustments = [];
  if (editorState.temperature > 6000) adjustments.push('warmer');
  if (editorState.temperature < 4500) adjustments.push('cooler');
  if (editorState.grain > 0.5) adjustments.push('more grain');
  if (editorState.grain < 0.2) adjustments.push('less grain');
  if (editorState.contrast > 1.2) adjustments.push('more contrast');
  if (editorState.contrast < 0.9) adjustments.push('less contrast');
  if (editorState.saturation > 1.5) adjustments.push('more saturated');
  if (editorState.saturation < 0.8) adjustments.push('desaturated');

  const adjustment = adjustments.length > 0 ? adjustments.join(', ') : 'refresh with current settings';

  // Try v2 iterate first (< 3 seconds), fall back to v1 regenerate
  const regenBtn = document.querySelector('.editor-actions .btn-secondary');
  if (regenBtn) { regenBtn.textContent = 'Applying...'; regenBtn.disabled = true; }

  fetch('/api/v2/iterate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      job_id: currentJobId,
      adjustment: adjustment,
      params: {
        temperature_shift: editorState.temperature - 5500,
        grain_delta: editorState.grain - 0.4,
        contrast_delta: editorState.contrast - 1.1,
        saturation_delta: editorState.saturation - 1.15,
        brightness_delta: (editorState.glow - 0.6) * 0.15,
      }
    })
  })
  .then(res => res.json())
  .then(data => {
    if (regenBtn) { regenBtn.textContent = 'Regenerate'; regenBtn.disabled = false; }

    if (data.success && data.outputs) {
      // Update the preview instantly
      currentOutputDir = data.outputs;
      const video = document.getElementById('canvas-video');
      if (video && data.outputs.canvas) {
        video.src = data.outputs.canvas + '?t=' + Date.now();
        video.load();
        video.play().catch(() => {});
      }
      editorState.hasChanges = false;
      updateApplyButton();
    } else {
      // Fall back to v1 regenerate
      fallbackRegenerate();
    }
  })
  .catch(err => {
    console.error('v2 iterate error:', err);
    if (regenBtn) { regenBtn.textContent = 'Regenerate'; regenBtn.disabled = false; }
    fallbackRegenerate();
  });
}

function fallbackRegenerate() {
  document.getElementById('editor-workspace').classList.remove('active');
  document.getElementById('upload-modal').classList.add('active');
  document.getElementById('upload-state').style.display = 'none';
  document.getElementById('generating-state').classList.add('active');
  document.getElementById('analyzing-phase').style.display = 'block';
  document.getElementById('directions-phase').style.display = 'none';
  document.getElementById('generating-text').textContent = 'Regenerating with new visual style...';

  fetch('/api/regenerate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      job_id: currentJobId,
      params: {
        style: editorState.style,
        grain: editorState.grain,
        vignette: editorState.vignette,
        glow: editorState.glow,
        motion_speed: editorState.motionSpeed,
        saturation: editorState.saturation,
        contrast: editorState.contrast,
        temperature: editorState.temperature,
      },
      output_type: editorState.outputMode || 'canvas'
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) pollRegenStatus(data.job_id);
    else document.getElementById('generating-text').textContent = 'Error: ' + (data.error || 'Failed');
  })
  .catch(err => {
    console.error('Regenerate error:', err);
    document.getElementById('generating-text').textContent = 'Regeneration failed';
  });
}

function pollRegenStatus(jobId) {
  let errorCount = 0;
  const startedAt = Date.now();

  const poll = () => {
    // 10-minute max polling duration
    if (Date.now() - startedAt > 600000) {
      document.getElementById('generating-text').textContent = 'Regeneration timed out. Refresh page to check status.';
      return;
    }

    fetch(`/api/status/${jobId}`)
      .then(res => res.json())
      .then(data => {
        errorCount = 0; // reset on success
        if (data.regen_status === 'complete') {
          // Regeneration complete - update preview
          document.getElementById('generating-text').textContent = 'Done! Loading new canvas...';
          setTimeout(() => {
            showResult(currentFile?.name || 'Track', data.outputs);
          }, 500);
        } else if (data.regen_status === 'error') {
          document.getElementById('generating-text').textContent = 'Error: ' + (data.regen_message || 'Failed');
        } else {
          // Still processing
          document.getElementById('generating-text').textContent = data.regen_message || 'Regenerating...';
          setTimeout(poll, 2000);
        }
      })
      .catch(err => {
        errorCount++;
        console.error(`Regen poll error (${errorCount}/10):`, err);
        if (errorCount < 10) {
          const backoff = Math.min(2000 * Math.pow(1.5, errorCount), 15000);
          setTimeout(poll, backoff);
        } else {
          document.getElementById('generating-text').textContent = 'Lost connection to GPU server';
        }
      });
  };

  poll();
}

function backToHome() {
  // Close editor workspace
  document.getElementById('editor-workspace').classList.remove('active');
  document.getElementById('hero').style.display = '';
  document.getElementById('moods').style.display = '';
  document.getElementById('proof').style.display = '';
  document.getElementById('footer').style.display = '';
  // Reset state
  currentFile = null;
  currentJobId = null;
  currentOutputDir = null;
  currentQualityScore = null;
  currentEmotionalDna = null;
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Export paywall - Game Theory: Endowment + Sunk Cost
let selectedExportOption = 'canvas';

// Free trial: 3 exports stored in localStorage
function getTrialExports() {
  return parseInt(localStorage.getItem('loopcanvas_trial_exports') || '3');
}

function useTrialExport() {
  const remaining = getTrialExports();
  if (remaining > 0) {
    localStorage.setItem('loopcanvas_trial_exports', (remaining - 1).toString());
    return true;
  }
  return false;
}

function downloadCanvas() {
  openExportModal();
}

function openExportModal() {
  const modal = document.getElementById('export-modal');
  const previewVideo = document.getElementById('export-preview-video');
  const trialView = document.getElementById('export-trial-view');
  const paidView = document.getElementById('export-paid-view');
  const trialCount = document.getElementById('trial-count');

  // Show their canvas in the preview
  if (currentOutputDir && currentOutputDir.canvas) {
    previewVideo.src = currentOutputDir.canvas;
  } else {
    previewVideo.src = '';
    previewVideo.poster = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 720 1280"><rect fill="%23111"/><text x="360" y="640" text-anchor="middle" fill="%23666" font-family="system-ui" font-size="24">Not ready yet</text></svg>';
  }

  // Check trial status
  const remaining = getTrialExports();
  if (remaining > 0) {
    trialView.style.display = 'block';
    paidView.style.display = 'none';
    trialCount.textContent = remaining;
  } else {
    trialView.style.display = 'none';
    paidView.style.display = 'block';
  }

  modal.classList.add('active');
}

function closeExportModal() {
  document.getElementById('export-modal').classList.remove('active');
}

function selectExportOption(option) {
  selectedExportOption = option;
  document.querySelectorAll('.export-option').forEach(el => el.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
}

function exportFree() {
  if (useTrialExport()) {
    actualDownload();
    closeExportModal();
    // Update count for next time
    const remaining = getTrialExports();
    if (remaining === 0) {
      // Show a message about trial ending
      setTimeout(() => {
        alert('You\'ve used all your free exports! Upgrade for unlimited exports.');
      }, 500);
    }
  }
}

function proceedToPayment() {
  // Apple Pay / Stripe integration
  // In production: redirect to Stripe checkout with Apple Pay
  const price = selectedExportOption === 'canvas' ? 4.99 : 19;
  alert(`Opening Apple Pay for $${price}... (Demo mode: downloading for free)`);
  actualDownload();
  closeExportModal();
}

function payWithCard() {
  // Fallback to Stripe card checkout
  const price = selectedExportOption === 'canvas' ? 4.99 : 19;
  alert(`Opening Stripe checkout for $${price}... (Demo mode: downloading for free)`);
  actualDownload();
  closeExportModal();
}

function actualDownload() {
  if (!currentOutputDir || !currentOutputDir.canvas) {
    alert('Your canvas is still generating. Please wait for it to complete.');
    return;
  }
  const link = document.createElement('a');
  link.href = currentOutputDir.canvas;
  link.download = (currentFile?.name?.replace(/\.(wav|mp3|flac|m4a)$/i, '') || 'canvas') + '_spotify_canvas.mp4';
  link.click();
}

function generateFullVideo() {
  const btn = event.target;
  btn.textContent = 'Generating...';
  btn.disabled = true;

  // Show progress
  setTimeout(() => {
    if (currentOutputDir && currentOutputDir.full_video) {
      btn.textContent = 'Full video ready!';
      // Could auto-open or show preview
      window.open(currentOutputDir.full_video, '_blank');
    } else {
      btn.textContent = 'Generate full-length video';
      btn.disabled = false;
      alert('Full video generation takes a few minutes. Check back soon!');
    }
  }, 2000);
}

// Workstation
function openWorkstation() {
  document.getElementById('workstation').classList.add('active');
  const wsVideo = document.getElementById('ws-video');

  // Use job-specific output if available
  if (currentOutputDir && currentOutputDir.canvas) {
    wsVideo.src = currentOutputDir.canvas;
    wsVideo.load();
  } else {
    wsVideo.src = '';
    wsVideo.poster = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 720 1280"><rect fill="%23111"/><text x="360" y="640" text-anchor="middle" fill="%23666" font-family="system-ui" font-size="24">Generating...</text></svg>';
  }

  // Show actual filename
  const displayName = currentFile?.name?.replace(/\.(wav|mp3|flac|m4a)$/i, '').replace(/_/g, ' ') || 'Track';
  document.getElementById('ws-track-name').textContent = displayName;
}

function closeWorkstation() {
  document.getElementById('workstation').classList.remove('active');
}

// AI Assistant â€” now wired to v2 iterate for real-time adjustments
function sendAIMessage() {
  const input = document.getElementById('ai-input');
  const message = input.value.trim();
  if (!message) return;

  const chat = document.getElementById('ai-chat');
  chat.innerHTML += `
    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
      <p style="font-size: 13px;">${message}</p>
    </div>
  `;
  input.value = '';
  chat.scrollTop = chat.scrollHeight;

  if (!currentJobId) {
    chat.innerHTML += `
      <div style="background: var(--accent); color: #000; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
        <p style="font-size: 13px;">Upload a track first so I can adjust your canvas.</p>
      </div>
    `;
    chat.scrollTop = chat.scrollHeight;
    return;
  }

  // Show "thinking" message
  const thinkingId = 'thinking-' + Date.now();
  chat.innerHTML += `
    <div id="${thinkingId}" style="background: rgba(29,185,84,0.15); color: var(--text-secondary); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
      <p style="font-size: 13px;">Adjusting canvas...</p>
    </div>
  `;
  chat.scrollTop = chat.scrollHeight;

  // Call v2 iterate with natural language
  fetch('/api/v2/iterate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      job_id: currentJobId,
      adjustment: message,
    })
  })
  .then(res => res.json())
  .then(data => {
    const thinkingEl = document.getElementById(thinkingId);
    if (data.success && data.outputs) {
      // Update video preview
      currentOutputDir = data.outputs;
      const video = document.getElementById('canvas-video');
      if (video && data.outputs.canvas) {
        video.src = data.outputs.canvas + '?t=' + Date.now();
        video.load();
        video.play().catch(() => {});
      }

      if (thinkingEl) {
        thinkingEl.style.background = 'var(--accent)';
        thinkingEl.style.color = '#000';
        thinkingEl.querySelector('p').textContent =
          `Done in ${data.elapsed_seconds || '?'}s. "${message}" applied.`;
      }
    } else {
      if (thinkingEl) {
        thinkingEl.querySelector('p').textContent =
          `Couldn't apply that adjustment. Try something like "make it warmer" or "more grain".`;
      }
    }
    chat.scrollTop = chat.scrollHeight;
  })
  .catch(err => {
    console.error('AI adjust error:', err);
    const thinkingEl = document.getElementById(thinkingId);
    if (thinkingEl) {
      thinkingEl.querySelector('p').textContent = `Error: ${err.message}. Try again.`;
    }
  });
}

// Enter key for AI chat
document.getElementById('ai-input')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendAIMessage();
  }
});

// Click outside modal to close
document.getElementById('upload-modal').addEventListener('click', (e) => {
  if (e.target.id === 'upload-modal') closeUploadModal();
});

// CMS data cache
let cmsData = null;

// Load CMS and demo content
async function loadCMSContent() {
  try {
    // Load CMS data
    cmsData = await fetch('/cms/moods.json').then(r => r.json());

    // Load demo video from CMS
    if (cmsData && cmsData.demo) {
      const demo = cmsData.demo;
      const heroVideo = document.getElementById('hero-video');
      const albumArtVideo = document.getElementById('album-art-video');

      if (heroVideo && demo.video_url) {
        heroVideo.src = demo.video_url;
        heroVideo.load();
        // Sync album art with hero video
        if (albumArtVideo) {
          albumArtVideo.src = demo.video_url;
          albumArtVideo.load();
        }
      }

      // Load hero audio for playback
      if (demo.audio_url) {
        let heroAudio = document.getElementById('hero-audio');
        if (!heroAudio) {
          heroAudio = document.createElement('audio');
          heroAudio.id = 'hero-audio';
          heroAudio.loop = true;
          heroAudio.preload = 'metadata';
          document.body.appendChild(heroAudio);
        }
        heroAudio.src = demo.audio_url;
        heroAudio.load();
      }

      // Update Spotify-style track info
      document.getElementById('hero-track-name').textContent = demo.track_name || demo.title;
      const artistEl = document.getElementById('hero-artist-name');
      if (artistEl) artistEl.textContent = demo.artist;
      document.getElementById('demo-duration').textContent = demo.duration;
    }

    // Load mood library from CMS
    if (cmsData && cmsData.moods) {
      renderMoodLibrary(cmsData.moods);
    }

  } catch (e) {
    console.log('CMS load error', e);
    // No fallback - leave hero video empty
  }
}

// Render mood library cards from CMS â€” 3x4 Grid with Vertical Scroll Parallax
function renderMoodLibrary(moods) {
  const container = document.getElementById('mood-grid');
  if (!container) return;

  const sortedMoods = moods
    .filter(m => m.featured)
    .sort((a, b) => a.order - b.order);

  container.innerHTML = sortedMoods
    .map((mood, index) => `
      <div class="mood-card${index === 0 ? ' signature' : ''}" data-mood-id="${mood.id}" data-index="${index}" data-audio-url="${mood.audio_url || ''}">
        <div class="mood-visual" style="background: linear-gradient(135deg, ${mood.gradient.start}, ${mood.gradient.end})">
          ${mood.video_url ? `<video src="${mood.video_url}" loop muted playsinline preload="metadata"></video>` : ''}
          <div class="mood-play-btn">
            <svg class="play-icon" viewBox="0 0 24 24" fill="#fff"><polygon points="5,3 19,12 5,21"/></svg>
            <svg class="pause-icon" viewBox="0 0 24 24" fill="#fff" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
          </div>
          ${mood.audio_url ? `<audio src="${mood.audio_url}" preload="metadata" loop></audio>` : ''}
        </div>
        <div class="mood-info">
          <h4>${mood.title}</h4>
          <p class="mood-artist">${mood.artist}</p>
          <p class="mood-desc">${mood.description}</p>
          <div class="mood-tags">
            ${mood.tags.map(t => `<span class="mood-tag">${t}</span>`).join('')}
          </div>
          ${mood.cinematographer_ref ? `<div class="mood-cinematographer">Inspired by ${formatCinematographer(mood.cinematographer_ref)}</div>` : ''}
        </div>
      </div>
    `).join('');

  // Helper to format cinematographer name
  function formatCinematographer(ref) {
    const names = {
      'lubezki': 'Lubezki',
      'wong_kar_wai': 'Wong Kar-wai',
      'malick': 'Malick',
      'tarkovsky': 'Tarkovsky',
      'lynch': 'Lynch',
      'doyle': 'Doyle'
    };
    return names[ref] || ref;
  }

  // Vertical scroll parallax â€” cards float up at different rates based on row
  const updateVerticalParallax = () => {
    const cards = container.querySelectorAll('.mood-card');
    const viewportHeight = window.innerHeight;
    const viewportCenter = viewportHeight / 2;

    cards.forEach((card, index) => {
      const rect = card.getBoundingClientRect();
      const cardCenter = rect.top + rect.height / 2;

      // Distance from viewport center (negative = above, positive = below)
      const distanceFromCenter = cardCenter - viewportCenter;
      const normalizedDistance = distanceFromCenter / viewportHeight;

      // Row-based parallax speed (rows further down move slower, creating depth)
      // 3 columns = 4 rows for 12 cards
      const row = Math.floor(index / 3);
      const parallaxSpeed = 0.1 + (row * 0.05); // Row 0: 0.1, Row 1: 0.15, Row 2: 0.2, Row 3: 0.25

      // Vertical offset â€” cards above center float up, below float down
      const translateY = -normalizedDistance * 60 * parallaxSpeed;

      // Scale â€” cards in center are full size, edges slightly smaller
      const absNormalized = Math.abs(normalizedDistance);
      const scale = 1 - (absNormalized * 0.08);

      // Subtle X rotation â€” cards tilt toward viewer as they approach center
      const rotateX = normalizedDistance * 3; // degrees

      // Opacity â€” full in center, fade at edges
      const opacity = Math.max(0.4, 1 - (absNormalized * 0.6));

      // Set CSS custom properties
      card.style.setProperty('--parallax-y', `${translateY}px`);
      card.style.setProperty('--parallax-scale', scale);
      card.style.setProperty('--parallax-rotateX', `${rotateX}deg`);
      card.style.setProperty('--parallax-opacity', opacity);
    });
  };

  // Listen to window scroll for vertical parallax
  window.addEventListener('scroll', updateVerticalParallax, { passive: true });
  window.addEventListener('resize', updateVerticalParallax);

  // Initial parallax calculation
  setTimeout(updateVerticalParallax, 100);

  // Add click-to-play with sound for mood cards
  container.querySelectorAll('.mood-card').forEach(card => {
    const video = card.querySelector('video');
    const audio = card.querySelector('audio');
    const playIcon = card.querySelector('.play-icon');
    const pauseIcon = card.querySelector('.pause-icon');
    let isPlaying = false;

    if (!video) return;

    const updateIcons = (playing) => {
      if (playIcon) playIcon.style.display = playing ? 'none' : 'block';
      if (pauseIcon) pauseIcon.style.display = playing ? 'block' : 'none';
    };

    // Click card to play video + audio
    card.addEventListener('click', (e) => {
      // Pause all other cards first (video + audio)
      container.querySelectorAll('.mood-card').forEach(otherCard => {
        if (otherCard !== card) {
          const otherVideo = otherCard.querySelector('video');
          const otherAudio = otherCard.querySelector('audio');
          const otherPlay = otherCard.querySelector('.play-icon');
          const otherPause = otherCard.querySelector('.pause-icon');
          if (otherVideo) {
            otherVideo.pause();
            otherVideo.currentTime = 0;
          }
          if (otherAudio) {
            otherAudio.pause();
            otherAudio.currentTime = 0;
          }
          otherCard.classList.remove('playing');
          if (otherPlay) otherPlay.style.display = 'block';
          if (otherPause) otherPause.style.display = 'none';
        }
      });

      if (isPlaying) {
        video.pause();
        if (audio) audio.pause();
        card.classList.remove('playing');
        isPlaying = false;
        updateIcons(false);
      } else {
        video.muted = false;
        const vp = video.play();
        if (vp && vp.catch) vp.catch(() => { video.muted = true; video.play().catch(() => {}); });
        if (audio) { const ap = audio.play(); if (ap && ap.catch) ap.catch(() => {}); }
        card.classList.add('playing');
        isPlaying = true;
        updateIcons(true);
      }
    });

    // Loop video
    video.addEventListener('ended', () => {
      video.currentTime = 0;
      const p = video.play();
      if (p && p.catch) p.catch(() => {});
    });

    // Hover preview (muted) â€” Safari-safe: catch rejected play promise
    card.addEventListener('mouseenter', () => {
      if (!isPlaying) {
        video.muted = true;
        const p = video.play();
        if (p && p.catch) p.catch(() => {});
      }
    });

    card.addEventListener('mouseleave', () => {
      if (!isPlaying) {
        video.pause();
        video.currentTime = 0;
      }
    });

    // Auto-play muted when scrolled into view â€” shows video content immediately
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !isPlaying) {
          video.muted = true;
          const p = video.play();
          if (p && p.catch) p.catch(() => {});
        } else if (!entry.isIntersecting && !isPlaying) {
          video.pause();
        }
      });
    }, { threshold: 0.3 });
    observer.observe(card);
  });
}

// Toggle demo sound - Apple-style minimal interaction
function toggleDemoSound() {
  const video = document.getElementById('hero-video');
  const heroAudio = document.getElementById('hero-audio');
  const toggle = document.getElementById('sound-toggle');

  if (toggle.classList.contains('muted')) {
    // Unmute - play audio
    toggle.classList.remove('muted');
    if (heroAudio) {
      heroAudio.currentTime = video.currentTime || 0;
      heroAudio.play();
    }
  } else {
    // Mute - pause audio
    toggle.classList.add('muted');
    if (heroAudio) {
      heroAudio.pause();
    }
  }
}

// Drag and drop handling
const uploadZone = document.querySelector('.upload-zone');
if (uploadZone) {
  ['dragenter', 'dragover'].forEach(event => {
    uploadZone.addEventListener(event, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadZone.classList.add('drag-over');
    });
  });

  ['dragleave', 'drop'].forEach(event => {
    uploadZone.addEventListener(event, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadZone.classList.remove('drag-over');
    });
  });

  uploadZone.addEventListener('drop', (e) => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const fileInput = document.getElementById('file-input');
      fileInput.files = files;
      handleFileUpload(fileInput);
    }
  });
}

// Initialize on load
loadCMSContent();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Spotify Play Button â€” Toggle Audio Mute/Unmute
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const spotifyPlayBtn = document.getElementById('spotify-play-btn');
if (spotifyPlayBtn) {
  let isMuted = true; // Start muted (video is muted by default)

  spotifyPlayBtn.addEventListener('click', () => {
    const heroAudio = document.getElementById('hero-audio');
    const heroVideo = document.getElementById('hero-video');
    const playIcon = spotifyPlayBtn.querySelector('svg');

    if (!heroAudio) {
      console.log('No hero audio found');
      return;
    }

    if (isMuted) {
      // Unmute - start playing audio
      heroAudio.currentTime = 0;
      heroAudio.play().then(() => {
        isMuted = false;
        // Change to pause icon (showing audio is playing)
        playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
      }).catch(err => {
        console.log('Audio play blocked:', err);
      });
    } else {
      // Mute - pause audio
      heroAudio.pause();
      isMuted = true;
      // Change back to play icon
      playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Apple Core Foundation: Scroll-Edge Header Behavior
// Headers respond to scroll with opacity/blur/scale changes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initScrollEdgeHeader() {
  const header = document.querySelector('.header');
  if (!header) return;

  let lastScrollY = window.scrollY;
  let ticking = false;

  const updateHeader = () => {
    const scrollY = window.scrollY;

    // Add/remove scrolled class based on scroll position
    if (scrollY > 50) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }

    lastScrollY = scrollY;
    ticking = false;
  };

  window.addEventListener('scroll', () => {
    if (!ticking) {
      requestAnimationFrame(updateHeader);
      ticking = true;
    }
  }, { passive: true });

  // Initial check
  updateHeader();
}

// Initialize scroll-edge header
initScrollEdgeHeader();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Apple Core Foundation: Bottom Tab Bar Navigation (Mobile)
// "Controls shift from top to bottom for better thumb accessibility"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initBottomTabBar() {
  const tabs = document.querySelectorAll('.tab-item');
  if (!tabs.length) return;

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remove active from all tabs
      tabs.forEach(t => t.classList.remove('active'));
      // Add active to clicked tab
      tab.classList.add('active');

      // Handle navigation
      const target = tab.dataset.target;
      if (target === 'home') {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else if (target === 'moods') {
        document.getElementById('moods')?.scrollIntoView({ behavior: 'smooth' });
      } else if (target === 'upload') {
        openUploadModal();
      } else if (target === 'proof') {
        document.getElementById('proof')?.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });
}

// Initialize bottom tab bar
initBottomTabBar();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Apple Core Foundation: Fluid Slider Interactions
// Update slider track fill as value changes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFluidSliders() {
  document.querySelectorAll('input[type="range"]').forEach(slider => {
    const updateSliderFill = () => {
      const min = parseFloat(slider.min) || 0;
      const max = parseFloat(slider.max) || 100;
      const value = parseFloat(slider.value) || 0;
      const percentage = ((value - min) / (max - min)) * 100;
      slider.style.setProperty('--slider-fill', `${percentage}%`);
    };

    slider.addEventListener('input', updateSliderFill);
    // Initial update
    updateSliderFill();
  });
}

// Initialize fluid sliders
initFluidSliders();
</script>

<!-- Bottom Tab Bar â€” Apple Core Foundation Mobile Navigation -->
<nav class="bottom-tab-bar">
  <div class="tab-item active" data-target="home">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
    <span>Home</span>
  </div>
  <div class="tab-item" data-target="moods">
    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
    <span>Moods</span>
  </div>
  <div class="tab-item" data-target="upload">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    <span>Create</span>
  </div>
  <div class="tab-item" data-target="proof">
    <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
    <span>Reviews</span>
  </div>
</nav>

<!-- Re-initialize bottom tab bar now that DOM elements exist -->
<script>
initBottomTabBar();

// Mobile: Move phone preview right under headline
(function() {
  function handleMobilePhone() {
    const phone = document.querySelector('.phone-preview');
    const slot = document.getElementById('hero-phone-slot');
    const hero = document.getElementById('hero');
    if (!phone || !slot || !hero) return;

    if (window.innerWidth <= 768) {
      // Move phone into the slot (right after h1)
      if (!slot.contains(phone)) {
        slot.appendChild(phone);
        phone.classList.add('mobile-inline');
      }
    } else {
      // Move phone back to hero as sibling of hero-content
      if (slot.contains(phone)) {
        hero.appendChild(phone);
        phone.classList.remove('mobile-inline');
      }
    }
  }
  handleMobilePhone();
  window.addEventListener('resize', handleMobilePhone);
})();
</script>

<!-- Export Modal â€” Free Trial + Apple Pay -->
<div class="modal-overlay" id="export-modal">
  <div class="modal export-modal">
    <div class="export-preview">
      <video id="export-preview-video" autoplay loop muted playsinline></video>
    </div>
    <div class="export-content">
      <!-- Free Trial State (first 3 exports) -->
      <div id="export-trial-view">
        <div class="trial-badge">FREE EXPORT</div>
        <h2>Your canvas is ready</h2>
        <p class="trial-remaining"><span id="trial-count">3</span> free exports remaining</p>
        <button class="btn btn-hero-cta export-cta" onclick="exportFree()">
          Export Free
        </button>
        <p class="export-formats">720Ã—1280 Â· H.264 Â· Spotify-ready</p>
      </div>

      <!-- Paid State (after trial) -->
      <div id="export-paid-view" style="display: none;">
        <h2>Your canvas is ready</h2>
        <p>Export in full quality, no watermark.</p>
        <div class="export-options">
          <div class="export-option" onclick="selectExportOption('canvas')">
            <div class="export-option-header">
              <span class="export-option-name">Canvas</span>
              <span class="export-option-price">$4.99</span>
            </div>
            <div class="export-option-detail">7-second loop Â· 4K Â· Spotify-ready</div>
          </div>
          <div class="export-option featured" onclick="selectExportOption('bundle')">
            <div class="export-option-badge">SAVE 60%</div>
            <div class="export-option-header">
              <span class="export-option-name">Canvas + Full Video</span>
              <span class="export-option-price">$19</span>
            </div>
            <div class="export-option-detail">Full music video Â· 4K Â· All platforms</div>
          </div>
        </div>
        <button class="btn btn-hero-cta export-cta apple-pay-btn" onclick="proceedToPayment()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M17.72 12.68c-.02-2.03 1.66-3.01 1.73-3.05-.94-1.38-2.41-1.57-2.93-1.59-1.25-.13-2.44.74-3.07.74-.64 0-1.62-.72-2.66-.7-1.37.02-2.64.8-3.34 2.03-1.42 2.47-.36 6.14 1.02 8.15.68.98 1.49 2.08 2.55 2.04 1.02-.04 1.41-.66 2.65-.66 1.24 0 1.59.66 2.67.64 1.1-.02 1.8-.99 2.47-1.98.78-1.14 1.1-2.24 1.12-2.3-.02-.01-2.14-.82-2.16-3.27l-.05-.05zM15.74 5.88c.56-.68.94-1.63.84-2.58-.81.03-1.79.54-2.37 1.22-.52.6-.98 1.57-.86 2.5.91.07 1.83-.46 2.39-1.14z"/></svg>
          Pay with Apple Pay
        </button>
        <p class="export-note">or <a href="#" onclick="payWithCard(); return false;">pay with card</a></p>
      </div>
    </div>
    <button class="modal-close" onclick="closeExportModal()">&times;</button>
  </div>
</div>

<!-- Footer -->
<footer class="site-footer" id="footer">
  <div class="footer-content">
    <div class="footer-brand">Loop<span>Canvas</span></div>
    <div class="footer-links">
      <a href="#moods">Styles</a>
      <a href="docs/">API Docs</a>
      <a href="mailto:support@loopcanvas.com">Support</a>
    </div>
    <p class="footer-copy">Built for artists, by artists. LoopCanvas 2026.</p>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTONOMOUS AGENT INTEGRATION
     Config reader, template injection, funnel tracking, gallery, share
     Managed by: retention_engineer, onboarding_optimizer, growth_engineer
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Template injection containers -->
<div id="lc-template-gallery"></div>
<div id="lc-template-return-banner"></div>
<div id="lc-template-share-modal"></div>
<div id="lc-template-onboarding-tips"></div>
<div id="lc-template-hero-variant"></div>
<div id="lc-template-growth-share"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LoopCanvas Autonomous Agent Frontend Integration
//  Reads configs written by autonomous agents, injects templates,
//  tracks funnel events, manages gallery + share mechanics.
//  All changes are config-driven: agents write JSON â†’ frontend reads.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
  'use strict';

  // â”€â”€â”€ Global Config Store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.lcConfigs = {
    retention: null,
    onboarding: null,
    landing: null,
    growth: null,
    loaded: false
  };

  // â”€â”€â”€ 1. Config Reader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadConfigs() {
    try {
      const resp = await fetch('/api/configs');
      if (resp.ok) {
        const configs = await resp.json();
        window.lcConfigs.retention = configs.retention || {};
        window.lcConfigs.onboarding = configs.onboarding || {};
        window.lcConfigs.landing = configs.landing || {};
        window.lcConfigs.growth = configs.growth || {};
        window.lcConfigs.loaded = true;
        console.log('[LC Agents] Configs loaded:', Object.keys(configs));
        applyConfigs();
      }
    } catch (e) {
      // Configs not available yet â€” agents haven't run. Use defaults.
      console.log('[LC Agents] No configs yet, using defaults');
      window.lcConfigs.loaded = true;
      applyDefaults();
    }
  }

  function applyDefaults() {
    // Enable gallery and return banner by default (Phase 1)
    window.lcConfigs.retention = {
      features: {
        gallery: { enabled: true, max_items: 50 },
        return_banner: { enabled: true },
        share_modal: { enabled: false }
      }
    };
    window.lcConfigs.onboarding = { tips_enabled: true };
    window.lcConfigs.growth = {
      features: { copy_link: { enabled: true } },
      share_copy: { share_button_text: 'Share Canvas' }
    };
    applyConfigs();
  }

  function applyConfigs() {
    loadTemplates();
    initGallery();
    initReturnBanner();
    initFunnelTracking();

    // Apply landing page variant if configured
    if (window.lcConfigs.landing && window.lcConfigs.landing.hero_variant) {
      if (typeof window.lcApplyHeroVariant === 'function') {
        window.lcApplyHeroVariant(window.lcConfigs.landing);
      }
    }
  }

  // â”€â”€â”€ 2. Template Injection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadTemplates() {
    const templates = [
      { name: 'gallery_component.html', target: 'lc-template-gallery' },
      { name: 'return_banner.html', target: 'lc-template-return-banner' },
      { name: 'share_modal.html', target: 'lc-template-share-modal' },
      { name: 'onboarding_tips.html', target: 'lc-template-onboarding-tips' },
      { name: 'landing_hero_variant.html', target: 'lc-template-hero-variant' },
      { name: 'growth_share.html', target: 'lc-template-growth-share' },
    ];

    for (const tpl of templates) {
      try {
        const resp = await fetch('/templates/' + tpl.name);
        if (resp.ok) {
          const html = await resp.text();
          const container = document.getElementById(tpl.target);
          if (container) {
            container.innerHTML = html;
            // Execute any scripts in the injected HTML
            container.querySelectorAll('script').forEach(oldScript => {
              const newScript = document.createElement('script');
              newScript.textContent = oldScript.textContent;
              oldScript.parentNode.replaceChild(newScript, oldScript);
            });
          }
          console.log('[LC Agents] Template loaded:', tpl.name);
        }
      } catch (e) {
        // Template not available yet â€” agent hasn't written it
      }
    }

    // â”€â”€â”€ Design Engineer CSS Overrides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // The DesignEngineer agent writes design_overrides.css daily
    // This injects it as a stylesheet so CSS changes auto-deploy
    try {
      const cssResp = await fetch('/templates/design_overrides.css');
      if (cssResp.ok) {
        const cssText = await cssResp.text();
        if (cssText.trim()) {
          const style = document.createElement('style');
          style.id = 'lc-design-overrides';
          style.textContent = cssText;
          document.head.appendChild(style);
          console.log('[LC Agents] Design overrides CSS loaded');
        }
      }
    } catch (e) {
      // Design engineer hasn't run yet â€” no CSS overrides
    }

    // â”€â”€â”€ SEO Meta from Content Engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    try {
      const seoResp = await fetch('/templates/seo_meta.html');
      if (seoResp.ok) {
        const seoHtml = await seoResp.text();
        if (seoHtml.trim()) {
          const seoDiv = document.createElement('div');
          seoDiv.innerHTML = seoHtml;
          seoDiv.querySelectorAll('meta, link').forEach(el => {
            const existing = document.head.querySelector(`meta[property="${el.getAttribute('property')}"]`) ||
                            document.head.querySelector(`meta[name="${el.getAttribute('name')}"]`);
            if (existing) existing.remove();
            document.head.appendChild(el.cloneNode(true));
          });
          console.log('[LC Agents] SEO meta tags loaded');
        }
      }
    } catch (e) {
      // Content engine hasn't run yet
    }
  }

  // â”€â”€â”€ 3. Funnel Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initFunnelTracking() {
    // Track page load
    lcTrackEvent('page_load', {
      source: document.referrer ? 'referral' : 'direct',
      is_return: localStorage.getItem('lc_visited') === 'true',
      hero_variant: (window.lcConfigs.landing || {}).hero_variant || 'default'
    });

    // Monkey-patch key functions to track funnel stages
    patchFunnelEvents();
  }

  function patchFunnelEvents() {
    // Patch handleFileUpload to track upload_start
    const origUpload = window.handleFileUpload;
    if (origUpload) {
      window.handleFileUpload = async function(input) {
        lcTrackEvent('upload_start', { fileName: input.files?.[0]?.name || '' });
        return origUpload.apply(this, arguments);
      };
    }

    // Patch showDirectionPicker to track analyze completion + director selection available
    const origDirectionPicker = window.showDirectionPicker;
    if (origDirectionPicker) {
      window.showDirectionPicker = function(directions, emotionalDna) {
        lcTrackEvent('analyze_start', { directionsCount: directions?.length || 0 });
        // Show onboarding tip
        if (typeof window.lcShowTip === 'function') window.lcShowTip('directors');
        return origDirectionPicker.apply(this, arguments);
      };
    }

    // Patch selectDirection to track director_select
    const origSelect = window.selectDirection;
    if (origSelect) {
      window.selectDirection = async function(directionId) {
        lcTrackEvent('director_select', { directionId });
        lcTrackEvent('generate_start', { directionId });
        // Show onboarding tip
        if (typeof window.lcShowTip === 'function') window.lcShowTip('generating');
        return origSelect.apply(this, arguments);
      };
    }

    // Patch exportFree to track export
    const origExport = window.exportFree;
    if (origExport) {
      window.exportFree = function() {
        lcTrackEvent('export', {
          jobId: window.currentJobId || '',
          director: window.currentDirectorStyle || ''
        });

        // Save to gallery on export
        saveToGallery();

        // Show share prompt after export if configured
        const retention = window.lcConfigs.retention || {};
        if (retention.features && retention.features.share_modal &&
            retention.features.share_modal.enabled) {
          setTimeout(() => {
            if (typeof window.lcShowShareModal === 'function') {
              window.lcShowShareModal({
                jobId: window.currentJobId || '',
                director: window.currentDirectorStyle || '',
                thumbnail: (window.currentOutputDir && window.currentOutputDir.canvas) || '',
                shareUrl: window.location.origin + '/c/' + (window.currentJobId || '')
              });
            }
          }, 1500);
        }

        return origExport.apply(this, arguments);
      };
    }
  }

  // â”€â”€â”€ 4. Event Tracking API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.lcTrackEvent = function(event, data) {
    const isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry/i.test(navigator.userAgent) ||
                     window.innerWidth < 768;
    const payload = {
      event: event,
      data: {
        ...(data || {}),
        sessionId: getSessionId(),
        url: window.location.pathname,
        is_mobile: isMobile,
        viewport: window.innerWidth + 'x' + window.innerHeight,
        ua_platform: navigator.userAgentData ? navigator.userAgentData.platform : navigator.platform
      },
      ts: Date.now()
    };

    // Fire and forget â€” don't block UI
    fetch('/api/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch(() => {});

    console.log('[LC Track]', event, data);
  };

  function getSessionId() {
    let sid = sessionStorage.getItem('lc_session_id');
    if (!sid) {
      sid = 'sess_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 6);
      sessionStorage.setItem('lc_session_id', sid);
    }
    return sid;
  }

  // â”€â”€â”€ 5. Project Gallery (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initGallery() {
    const retention = window.lcConfigs.retention || {};
    if (!retention.features || !retention.features.gallery || !retention.features.gallery.enabled) return;

    // Gallery is rendered by the injected template (gallery_component.html)
    // This function just ensures the data layer is ready
    const gallery = getGallery();
    console.log('[LC Gallery]', gallery.length, 'canvases saved');
  }

  function getGallery() {
    try {
      return JSON.parse(localStorage.getItem('lc_gallery') || '[]');
    } catch (e) {
      return [];
    }
  }

  function saveToGallery() {
    const gallery = getGallery();
    const maxItems = (window.lcConfigs.retention?.features?.gallery?.max_items) || 50;

    const entry = {
      jobId: window.currentJobId || 'job_' + Date.now(),
      director: window.currentDirectorStyle || 'Unknown',
      thumbnail: (window.currentOutputDir && window.currentOutputDir.canvas) || '',
      outputUrl: (window.currentOutputDir && window.currentOutputDir.canvas) || '',
      createdAt: new Date().toISOString(),
      quality: window.currentQualityScore || 0
    };

    gallery.unshift(entry);

    // Trim to max
    while (gallery.length > maxItems) gallery.pop();

    localStorage.setItem('lc_gallery', JSON.stringify(gallery));
    console.log('[LC Gallery] Saved canvas:', entry.jobId);

    // Trigger gallery re-render if template is loaded
    const galleryGrid = document.getElementById('lc-gallery-grid');
    if (galleryGrid) {
      // Re-dispatch the gallery render
      const section = document.getElementById('lc-gallery-section');
      if (section) section.style.display = 'block';
      const empty = document.getElementById('lc-gallery-empty');
      if (empty) empty.style.display = 'none';
      const count = document.getElementById('lc-gallery-count');
      if (count) count.textContent = gallery.length + ' canvas' + (gallery.length !== 1 ? 'es' : '');

      // Add the new card at the top
      const card = document.createElement('div');
      card.className = 'gallery-card';
      card.innerHTML =
        '<img class="gallery-card-thumb" src="' + (entry.thumbnail || '/mood_demos/default.jpg') + '" alt="' + entry.director + '" loading="lazy">' +
        '<div class="gallery-card-info">' +
        '<div class="gallery-card-title">' + entry.director + '</div>' +
        '<div class="gallery-card-date">' + new Date(entry.createdAt).toLocaleDateString() + '</div>' +
        '</div>';
      card.onclick = function() { if (entry.outputUrl) window.open(entry.outputUrl, '_blank'); };
      galleryGrid.insertBefore(card, galleryGrid.firstChild);
    }
  }

  // â”€â”€â”€ 6. Return Visit Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initReturnBanner() {
    const retention = window.lcConfigs.retention || {};
    if (!retention.features || !retention.features.return_banner ||
        !retention.features.return_banner.enabled) return;

    const isReturn = localStorage.getItem('lc_visited') === 'true';
    const gallery = getGallery();

    if (isReturn && gallery.length > 0) {
      lcTrackEvent('return_visit', { canvasCount: gallery.length });
    }

    // Mark as visited
    localStorage.setItem('lc_visited', 'true');
  }

  // â”€â”€â”€ 7. Share Button Injection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.lcInjectShareButton = function(containerSelector) {
    const growth = window.lcConfigs.growth || {};
    if (!growth.features) return;

    const container = document.querySelector(containerSelector);
    if (!container) return;

    const btnText = (growth.share_copy && growth.share_copy.share_button_text) || 'Share Canvas';
    const btn = document.createElement('button');
    btn.className = 'lc-share-trigger';
    btn.innerHTML = '<span style="font-size:16px;">â†—</span> ' + btnText;
    btn.onclick = function() {
      if (typeof window.lcShowShareModal === 'function') {
        window.lcShowShareModal({
          jobId: window.currentJobId || '',
          director: window.currentDirectorStyle || '',
          thumbnail: (window.currentOutputDir && window.currentOutputDir.canvas) || '',
          shareUrl: window.location.origin + '/c/' + (window.currentJobId || '')
        });
      } else if (typeof window.lcShare === 'function') {
        window.lcShare('copy', {
          jobId: window.currentJobId || '',
          shareUrl: window.location.origin
        });
      } else {
        navigator.clipboard.writeText(window.location.href);
        btn.innerHTML = '<span style="font-size:16px;">âœ“</span> Copied!';
        setTimeout(() => { btn.innerHTML = '<span style="font-size:16px;">â†—</span> ' + btnText; }, 2000);
      }
    };
    container.appendChild(btn);
  };

  // â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadConfigs);
  } else {
    loadConfigs();
  }

  console.log('[LC Agents] Autonomous integration initialized');
})();
</script>

</body>
</html>
